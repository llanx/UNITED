syntax = "proto3";
package united.ws;

import "auth.proto";
import "identity.proto";
import "server.proto";
import "channels.proto";
import "roles.proto";
import "moderation.proto";
import "invite.proto";
import "p2p.proto";
import "chat.proto";
import "presence.proto";
import "dm.proto";
import "blocks.proto";

// WebSocket envelope: all WS messages are wrapped in this type
// Both client->server and server->client use the same envelope format
// Binary protobuf encoding (no JSON) per CONTEXT.md decision
//
// Field number allocation:
//   10-19: Auth flow (Phase 1)
//   20-29: Server info (Phase 1)
//   30-39: Identity blobs (Phase 1)
//   40-49: Key rotation (Phase 1)
//   50-59: Channels and categories (Phase 2)
//   60-69: Roles and permissions (Phase 2)
//   70-79: Moderation - kick/ban (Phase 2)
//   80-89: Invites and join (Phase 2)
//   99:    Errors
//   100-109: Overflow from Phase 2
//   110-119: P2P networking (Phase 3)
//   120-149: Real-Time Chat (Phase 4)
//   150-159: Direct Messages (Phase 5)
//   160-179: Content Distribution (Phase 6) â€” block events

message Envelope {
  // Client-generated request ID, echoed in response for correlation
  string request_id = 1;

  oneof payload {
    // Auth flow (challenge-response over WS)
    united.auth.ChallengeRequest challenge_request = 10;
    united.auth.ChallengeResponse challenge_response = 11;
    united.auth.VerifyRequest verify_request = 12;
    united.auth.VerifyResponse verify_response = 13;

    // Server info
    ServerInfoRequest server_info_request = 20;
    ServerInfoResponse server_info_response = 21;

    // Identity blob storage
    united.identity.StoreBlobRequest store_blob_request = 30;
    united.identity.StoreBlobResponse store_blob_response = 31;
    united.identity.GetBlobRequest get_blob_request = 32;
    united.identity.GetBlobResponse get_blob_response = 33;

    // Key rotation
    united.identity.RotateKeyRequest rotate_key_request = 40;
    united.identity.RotateKeyResponse rotate_key_response = 41;
    united.identity.CancelRotationRequest cancel_rotation_request = 42;
    united.identity.CancelRotationResponse cancel_rotation_response = 43;

    // --- Phase 2: Channels and categories (50-59) ---
    united.channels.CreateChannelRequest create_channel_request = 50;
    united.channels.RenameChannelRequest rename_channel_request = 51;
    united.channels.DeleteChannelRequest delete_channel_request = 52;
    united.channels.ReorderChannelsRequest reorder_channels_request = 53;
    united.channels.CreateCategoryRequest create_category_request = 54;
    united.channels.RenameCategoryRequest rename_category_request = 55;
    united.channels.DeleteCategoryRequest delete_category_request = 56;
    united.channels.ReorderCategoriesRequest reorder_categories_request = 57;
    united.channels.ChannelListResponse channel_list_response = 58;
    united.channels.ChannelCreatedEvent channel_created_event = 59;
    united.channels.ChannelUpdatedEvent channel_updated_event = 100;
    united.channels.ChannelDeletedEvent channel_deleted_event = 101;
    united.channels.CategoryCreatedEvent category_created_event = 102;
    united.channels.CategoryUpdatedEvent category_updated_event = 103;
    united.channels.CategoryDeletedEvent category_deleted_event = 104;

    // --- Phase 2: Roles and permissions (60-69) ---
    united.roles.CreateRoleRequest create_role_request = 60;
    united.roles.UpdateRoleRequest update_role_request = 61;
    united.roles.DeleteRoleRequest delete_role_request = 62;
    united.roles.AssignRoleRequest assign_role_request = 63;
    united.roles.RemoveRoleRequest remove_role_request = 64;
    united.roles.RoleListResponse role_list_response = 65;
    united.roles.RoleCreatedEvent role_created_event = 66;
    united.roles.RoleUpdatedEvent role_updated_event = 67;
    united.roles.RoleDeletedEvent role_deleted_event = 68;
    united.roles.RoleAssignedEvent role_assigned_event = 69;
    united.roles.RoleRemovedEvent role_removed_event = 105;

    // --- Phase 2: Moderation - kick/ban (70-79) ---
    united.moderation.KickRequest kick_request = 70;
    united.moderation.BanRequest ban_request = 71;
    united.moderation.UnbanRequest unban_request = 72;
    united.moderation.UserKickedEvent user_kicked_event = 73;
    united.moderation.UserBannedEvent user_banned_event = 74;
    united.moderation.UserUnbannedEvent user_unbanned_event = 75;

    // --- Phase 2: Invites and join (80-89) ---
    united.invite.CreateInviteRequest create_invite_request = 80;
    united.invite.DeleteInviteRequest delete_invite_request = 81;
    united.invite.InviteListResponse invite_list_response = 82;
    united.invite.JoinServerRequest join_server_request = 83;
    united.invite.JoinServerResponse join_server_response = 84;

    // Errors
    ErrorResponse error = 99;

    // --- Phase 3: P2P networking (110-119) ---
    united.p2p.PeerDirectoryRequest peer_directory_request = 110;
    united.p2p.PeerDirectoryResponse peer_directory_response = 111;
    united.p2p.RegisterPeerIdRequest register_peer_id_request = 112;
    united.p2p.RegisterPeerIdResponse register_peer_id_response = 113;

    // --- Phase 4: Real-Time Chat (120-149) ---
    united.chat.NewMessageEvent new_message_event = 120;
    united.chat.MessageEditedEvent message_edited_event = 121;
    united.chat.MessageDeletedEvent message_deleted_event = 122;
    united.chat.ReactionAddedEvent reaction_added_event = 123;
    united.chat.ReactionRemovedEvent reaction_removed_event = 124;
    united.presence.PresenceUpdateEvent presence_update_event = 125;
    united.presence.TypingEvent typing_event = 126;
    united.chat.FetchHistoryRequest fetch_history_request = 130;
    united.chat.FetchHistoryResponse fetch_history_response = 131;

    // --- Phase 5: Direct Messages (150-169) ---
    united.dm.DmMessageEvent dm_message_event = 150;
    united.dm.DmConversationCreatedEvent dm_conversation_created_event = 151;
    united.dm.DmKeyRotatedEvent dm_key_rotated_event = 152;
    united.dm.DmHistoryRequest dm_history_request = 153;
    united.dm.DmHistoryResponse dm_history_response = 154;
    united.dm.DmConversationListRequest dm_conversation_list_request = 155;
    united.dm.DmConversationListResponse dm_conversation_list_response = 156;
    united.dm.DmOfflineMessagesResponse dm_offline_messages_response = 157;

    // --- Phase 6: Content Distribution (160-179) ---
    united.blocks.BlockStored block_stored = 160;
    united.blocks.BlockRequest block_request = 161;
    united.blocks.BlockAvailable block_available = 162;
  }
}

// Server info request (empty - just triggers info response)
message ServerInfoRequest {}

// Server info response
message ServerInfoResponse {
  united.server.ServerInfo info = 1;
}

// Generic error response
message ErrorResponse {
  // Error code (mirrors HTTP status codes where applicable)
  uint32 code = 1;
  // Human-readable error message
  string message = 2;
  // Optional: request_id of the failed request
  string request_id = 3;
}
