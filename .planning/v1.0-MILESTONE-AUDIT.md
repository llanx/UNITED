---
milestone: v1.0
audited: 2026-02-27T00:00:00Z
status: gaps_found
scores:
  requirements: 50/56
  phases: 8/9
  integration: 46/47
  flows: 7/8
gaps:
  requirements:
    - id: "SEC-01"
      status: "orphaned"
      phase: "Phase 1: Foundation"
      claimed_by_plans: ["01-02-PLAN.md", "01-06-PLAN.md"]
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "No Phase 1 VERIFICATION.md exists. REQUIREMENTS.md marks [x] Complete. Implementation exists (sodium-native Ed25519, Argon2id, BIP39) but never formally verified at phase level."
    - id: "SEC-02"
      status: "orphaned"
      phase: "Phase 1: Foundation"
      claimed_by_plans: ["01-02-PLAN.md", "01-06-PLAN.md"]
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "No Phase 1 VERIFICATION.md exists. REQUIREMENTS.md marks [x] Complete. Implementation exists (challenge-response auth, JWT) but never formally verified at phase level."
    - id: "SEC-09"
      status: "orphaned"
      phase: "Phase 1: Foundation"
      claimed_by_plans: ["01-03-PLAN.md"]
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "No Phase 1 VERIFICATION.md exists. REQUIREMENTS.md marks [x] Complete. Identity blob endpoints exist (PUT/GET /api/identity/blob) but never formally verified at phase level."
    - id: "SEC-10"
      status: "orphaned"
      phase: "Phase 1: Foundation"
      claimed_by_plans: ["01-03-PLAN.md", "01-06-PLAN.md"]
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "No Phase 1 VERIFICATION.md exists. REQUIREMENTS.md marks [x] Complete. TOTP implementation exists (server + client enrollment UI) but never formally verified at phase level."
    - id: "SEC-11"
      status: "orphaned"
      phase: "Phase 1: Foundation"
      claimed_by_plans: ["01-03-PLAN.md"]
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "No Phase 1 VERIFICATION.md exists. REQUIREMENTS.md marks [x] Complete. Key rotation endpoints exist (POST /api/identity/rotate) but never formally verified at phase level."
    - id: "SRVR-07"
      status: "orphaned"
      phase: "Phase 1: Foundation"
      claimed_by_plans: ["01-02-PLAN.md", "01-05-PLAN.md"]
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "No Phase 1 VERIFICATION.md exists. REQUIREMENTS.md marks [x] Complete. Server settings endpoints exist (GET/PUT /api/settings) but never formally verified at phase level."
  integration:
    - from: "server/src/chat/messages.rs (block_refs_json)"
      to: "client ChatMessage.block_refs"
      issue: "Server REST history returns block_refs_json as Option<String> (serialized JSON). Client ChatMessage interface expects block_refs?: BlockRefData[] (parsed typed array). No JSON.parse transformation occurs in CHAT_FETCH_HISTORY IPC handler. Media attachments in history are silently undefined."
      affected_requirements: ["MEDIA-01", "MEDIA-02", "MEDIA-03", "MEDIA-04"]
      severity: "critical"
    - from: "client/src/main/ws/chat-events.ts (newMessageEvent)"
      to: "ChatMessage.block_refs field"
      issue: "WS newMessageEvent case (lines 32-46) constructs ChatEvent.message without mapping msg.blockRefs from the protobuf repeated field. Live-delivered messages with attachments show no media in the UI."
      affected_requirements: ["MEDIA-01", "MEDIA-02", "MEDIA-03"]
      severity: "critical"
  flows:
    - flow: "Media Attachment Display"
      breaks_at: "block_refs deserialization — both REST history and WS live paths fail to populate ChatMessage.block_refs"
      affected_requirements: ["MEDIA-01", "MEDIA-02", "MEDIA-03", "MEDIA-04"]
tech_debt:
  - phase: 04-real-time-chat
    items:
      - "SEC-03 partially satisfied: REST message path has empty signature bytes (gossip path is signed)"
      - "MessageGroup.tsx lines 108-109: minor redundancy in isFirstInDay logic"
  - phase: 05-direct-messages
    items:
      - "DM_DELETE_LOCAL handler is a no-op (delete-for-self only in renderer memory, lost on restart)"
  - phase: 06-content-distribution
    items:
      - "server/src/blocks/store.rs: no disk-based verification on get_block (trusts metadata presence)"
  - phase: 08-voice-channels
    items:
      - "ChannelList.tsx line 266-268: console.warn for soft cap warning (should use toast system)"
      - "SEC-11 key rotation: 72h cancellation endpoint has no client-side UI to cancel"
---

# v1.0 Milestone Audit Report

**Audited:** 2026-02-27
**Milestone:** v1.0 — UNITED Desktop Application
**Status:** GAPS FOUND
**Previous audit:** 2026-02-26 (pre-Phase 9 gap closure)

---

## Executive Summary

56 v1 requirements. 50 formally verified via phase VERIFICATION.md files. 6 orphaned (Phase 1 has no VERIFICATION.md). 1 critical cross-phase integration break affects all media attachment rendering (MEDIA-01 through MEDIA-04). 7 of 8 E2E user flows confirmed complete.

---

## 1. Phase Verification Status

| Phase | VERIFICATION.md | Status | Score | Notes |
|-------|----------------|--------|-------|-------|
| 01-foundation | **MISSING** | UNVERIFIED | —/8 | No phase-level verification file exists. 6 requirements orphaned. |
| 02-server-management | 02-06-VERIFICATION.md | human_needed | 9/9 | Re-verified after gap closure. 6 human-test items. |
| 03-p2p-networking | 03-VERIFICATION.md | human_needed | 4/4 | Re-verified after 03-04 gap closure. 3 human-test items. |
| 04-real-time-chat | 04-VERIFICATION.md | human_needed | 5/5 | Re-verified after 04-06 gap closure. 6 human-test items. |
| 05-direct-messages | 05-VERIFICATION.md | passed | 4/4 | Re-verified after 05-04 gap closure. |
| 06-content-distribution | 06-VERIFICATION.md | human_needed | 14/14 | Re-verified after 06-05 gap closure. 3 human-test items. |
| 07-media-and-prefetching | 07-VERIFICATION.md | passed | 19/19 | Initial verification, no gaps. |
| 08-voice-channels | 08-VERIFICATION.md | passed | 11/11 | Initial verification, no gaps. |
| 09-milestone-gap-closure | 09-VERIFICATION.md | passed | 10/10 | Closed SEC-08, APP-01, SRVR-09, VOICE-01/03 gaps. |

**Phase score: 8/9** (Phase 1 missing verification)

---

## 2. Requirements Coverage (3-Source Cross-Reference)

### 2a. Fully Satisfied Requirements (50/56)

All three sources agree — REQUIREMENTS.md `[x]`, VERIFICATION.md SATISFIED, implementation confirmed:

| Category | Requirements | Phase | Status |
|----------|-------------|-------|--------|
| Messaging | MSG-01 through MSG-09 | Phase 4 | SATISFIED |
| Direct Messages | DM-01, DM-02, DM-03 | Phase 5 | SATISFIED |
| Media | MEDIA-01, MEDIA-02, MEDIA-03, MEDIA-04 | Phase 7 | SATISFIED (per phase verification; integration gap below) |
| Voice | VOICE-01, VOICE-02, VOICE-03, VOICE-04 | Phase 8 + Phase 9 fixes | SATISFIED |
| Server Mgmt | SRVR-01 through SRVR-06, SRVR-08, SRVR-09 | Phase 2 + Phase 9 fix | SATISFIED |
| P2P | P2P-01 through P2P-10 | Phases 3, 6, 7 | SATISFIED |
| Security | SEC-03, SEC-04, SEC-05, SEC-06, SEC-07, SEC-08, SEC-12 | Phases 2-6, 9 | SATISFIED |
| Client App | APP-01, APP-02, APP-03, APP-04, APP-05 | Phases 1, 3, 4, 6, 9 | SATISFIED |

### 2b. Orphaned Requirements (6/56) — Phase 1 Missing VERIFICATION.md

These requirements are marked `[x] Complete` in REQUIREMENTS.md and assigned to Phase 1 in the traceability table, but **no Phase 1 VERIFICATION.md exists** to provide formal evidence. They are absent from ALL phase VERIFICATION.md files.

| Requirement | Description | Phase | Traceability | Verification | Final Status |
|-------------|-------------|-------|-------------|-------------|--------------|
| SEC-01 | Ed25519 keypair identity with passphrase, BIP39 mnemonic | Phase 1 | `[x]` Complete | MISSING | **orphaned** |
| SEC-02 | Challenge-response auth, JWT tokens | Phase 1 | `[x]` Complete | MISSING | **orphaned** |
| SEC-09 | Encrypted identity blob stored on servers for recovery | Phase 1 | `[x]` Complete | MISSING | **orphaned** |
| SEC-10 | TOTP 2FA enabled by default | Phase 1 | `[x]` Complete | MISSING | **orphaned** |
| SEC-11 | Key rotation via signed rotation records | Phase 1 | `[x]` Complete | MISSING | **orphaned** |
| SRVR-07 | Server admin configures server name, icon, description | Phase 1 | `[x]` Complete | MISSING | **orphaned** |

**Note:** These 6 requirements are almost certainly implemented — every subsequent phase depends on Phase 1's auth, identity, and server systems. The gap is **formal verification**, not implementation.

### 2c. SEC-03 Caveat

SEC-03 (messages signed by Ed25519 key) is marked SATISFIED in Phase 4 verification with a known caveat: only the gossipsub path signs messages. The REST POST path sends empty signature bytes. This is tracked as tech debt, not a blocker.

---

## 3. Cross-Phase Integration Results

**Integration checker result:** 46/47 integration points wired. 7/8 E2E flows complete.

### 3a. Critical Integration Break: Media Attachment Display

**Affected requirements:** MEDIA-01, MEDIA-02, MEDIA-03, MEDIA-04

**Root cause:** Two type-mismatch issues between server and client prevent media attachments from rendering:

1. **REST history path:** Server `MessageResponse` returns `block_refs_json: Option<String>` (a serialized JSON string). Client `ChatMessage` interface expects `block_refs?: BlockRefData[]` (a parsed typed array). The `CHAT_FETCH_HISTORY` IPC handler in `client/src/main/ipc/chat.ts` does `apiGet<ChatHistoryResponse>()` without parsing `block_refs_json` → `block_refs`. Result: `message.block_refs` is `undefined` for all history-loaded messages.

2. **WS live path:** `client/src/main/ws/chat-events.ts` lines 32-46 construct the `ChatEvent.message` object manually but omit the `block_refs` field entirely, even though the protobuf `ChatMessage` has `repeated BlockRef block_refs = 13`. Result: live-delivered messages with attachments also show no media.

**Impact:** `MessageRow.tsx` falls back to `message.block_refs ?? []`, so no error is thrown — media simply never renders. `InlineImage`, `InlineVideo`, `ImageGrid`, `AttachmentCard`, `Lightbox`, and `BlurhashPlaceholder` components are all fully implemented and correct, but never receive data.

**Fix required in 2 files:**
- `client/src/main/ipc/chat.ts`: After `apiGet()`, transform each message's `block_refs_json` string via `JSON.parse()` into `block_refs: BlockRefData[]`
- `client/src/main/ws/chat-events.ts`: In the `newMessageEvent` case, map `msg.blockRefs` (protobuf repeated field) into `block_refs` array

### 3b. Connected Flows (7/8 Complete)

| # | Flow | Status |
|---|------|--------|
| 1 | Identity creation → server auth → JWT → WS connect → P2P mesh | COMPLETE |
| 2 | WS protobuf envelope dispatch (chat, DM, voice coexist) | COMPLETE |
| 3 | Gossipsub → WS bridge for chat messages | COMPLETE |
| 4 | Block content resolution cascade (useBlockContent → resolveBlock) | COMPLETE |
| 5 | Voice signaling (join → WebRTC peer connections) | COMPLETE |
| 6 | DM end-to-end encryption pipeline | COMPLETE |
| 7 | Invite flow (deep link → validate → join → channels) | COMPLETE |
| 8 | **Media attachment display** (upload → message → render) | **BROKEN** |

### 3c. Auth Protection

All sensitive REST endpoints use `Claims` extractor JWT middleware. The following routes are intentionally public:
- `GET /api/identity/blob/:fingerprint` — public key discovery
- `GET /api/p2p/info` — peer directory bootstrap
- `GET /api/invites/{code}` — pre-join invite preview
- `GET /invite/{code}` — HTML landing page

---

## 4. Tech Debt Inventory

### Phase 4: Real-Time Chat
- SEC-03 REST path: messages sent via POST have empty signature bytes (gossip path correctly signs)
- MessageGroup.tsx: minor redundancy in isFirstInDay logic (cosmetic)

### Phase 5: Direct Messages
- DM_DELETE_LOCAL handler is a no-op — delete-for-self only persists in renderer memory, cleared on restart

### Phase 6: Content Distribution
- server/src/blocks/store.rs: no disk-based verification on get_block (trusts metadata presence)

### Phase 8: Voice Channels
- ChannelList.tsx: console.warn for soft cap warning (should use toast system)
- SEC-11 key rotation: 72h cancellation endpoint has no client-side UI to cancel

**Total: 6 tech debt items across 4 phases**

---

## 5. Human Verification Backlog

Accumulated across all phase verifications — items requiring live runtime testing:

| Phase | Count | Key Items |
|-------|-------|-----------|
| Phase 2 | 6 | WS channel events, non-admin gating, invite join, welcome overlay, ban notice, SEC-12 QR round-trip |
| Phase 3 | 4 | Cross-network discovery, gossipsub latency, dev panel, reconnection fast-recovery |
| Phase 4 | 6 | Real-time delivery, message grouping, @mention UX, reaction sync, desktop notifications, presence dots |
| Phase 5 | 4 | Real-time DM delivery, offline DM, encryption banner persistence, key unavailable state |
| Phase 6 | 3 | StorageSettings panel, zero-reflow, file type icons |
| Phase 7 | 7 | Inline media grids, placeholder transitions, lightbox, drag-drop, upload progress, status bar, hover prefetch |
| Phase 8 | 5 | P2P audio, mute/deafen, speaking glow, PTT global hook, TURN relay |
| Phase 9 | 3 | Invite E2E, voice self-exclusion, offer/answer correctness |

**Total: 38 human verification items** (none are blockers — all automated checks pass)

---

## 6. Changes Since Previous Audit

The previous audit (2026-02-26) identified 5 requirement gaps and 2 integration breaks. Phase 9 closed:

| Previous Gap | Resolution |
|-------------|------------|
| SEC-08 orphaned | Phase 9 plan 09-03 verified Electron security config, marked Complete |
| APP-01 orphaned | Phase 9 plan 09-04 verified SPA behavior, marked Complete |
| SEC-12 stale traceability | REQUIREMENTS.md updated to Phase 2 Complete |
| SRVR-09 invite validation broken | Phase 9 plan 09-01 added GET /api/invites/{code} handler |
| VOICE-01/03 localUserId bug | Phase 9 plan 09-02 fixed voice identity |

**New findings in this audit:**
- 6 Phase 1 orphaned requirements (formal verification gap, not implementation gap)
- 1 critical integration break: block_refs deserialization (MEDIA-01 through MEDIA-04)

---

_Audited: 2026-02-27_
_Auditor: Claude (gsd audit-milestone workflow)_
_Previous audit: 2026-02-26 (pre-Phase 9)_
