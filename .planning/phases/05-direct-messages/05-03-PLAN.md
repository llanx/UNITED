---
phase: 05-direct-messages
plan: 03
type: execute
wave: 2
depends_on: [05-01, 05-02]
files_modified:
  - client/src/renderer/src/components/ServerRail.tsx
  - client/src/renderer/src/components/DmConversationList.tsx
  - client/src/renderer/src/components/DmChatView.tsx
  - client/src/renderer/src/components/DmComposer.tsx
  - client/src/renderer/src/components/DmMessageRow.tsx
  - client/src/renderer/src/components/EncryptionBanner.tsx
  - client/src/renderer/src/components/EncryptionIndicator.tsx
  - client/src/renderer/src/components/KeyRotationNotice.tsx
  - client/src/renderer/src/components/MainContent.tsx
  - client/src/renderer/src/components/ChannelSidebar.tsx
  - client/src/renderer/src/components/MessageRow.tsx
  - client/src/renderer/src/components/UserProfilePopup.tsx
  - client/src/renderer/src/stores/ui.ts
autonomous: true
requirements: [DM-01, DM-03, SEC-07]

must_haves:
  truths:
    - "DM icon at top of server rail navigates to DM view, replacing channel sidebar with DM conversation list"
    - "DM icon shows red badge with total unread DM count, visible regardless of current view"
    - "DM conversation list shows avatar, name, last message preview (encrypted -- shows timestamp only), timestamp, unread badge"
    - "Clicking a conversation opens the DM chat view in the main content area"
    - "DM chat view is full-width (no right member panel), reusing chat patterns from Phase 4"
    - "First-time DM shows dismissible educational banner explaining E2E encryption"
    - "After banner dismissed, subtle lock icon visible near message input or conversation header"
    - "Channel messages show a differentiated signed indicator (checkmark) distinct from the DM lock icon"
    - "Key exchange failure disables message input with 'Waiting for encryption keys from [user]' message"
    - "Key rotation produces inline system message: '[user]'s encryption keys have changed'"
    - "Clicking user name/avatar anywhere opens DM (member list, messages, mentions)"
    - "DM conversations ordered by most recent activity (newest at top)"
    - "Offline messages appear inline with subtle 'received while offline' separator"
  artifacts:
    - path: "client/src/renderer/src/components/DmConversationList.tsx"
      provides: "Sidebar list of DM conversations with avatars, names, timestamps, unread badges"
      contains: "DmConversationList"
    - path: "client/src/renderer/src/components/DmChatView.tsx"
      provides: "Full-width DM conversation view with encryption status header"
      contains: "DmChatView"
    - path: "client/src/renderer/src/components/DmComposer.tsx"
      provides: "Message composer for DMs with encryption key status awareness"
      contains: "DmComposer"
    - path: "client/src/renderer/src/components/DmMessageRow.tsx"
      provides: "DM message row with lock icon and offline separator"
      contains: "DmMessageRow"
    - path: "client/src/renderer/src/components/EncryptionBanner.tsx"
      provides: "Dismissible E2E encryption educational banner for first-time DM"
      contains: "EncryptionBanner"
    - path: "client/src/renderer/src/components/EncryptionIndicator.tsx"
      provides: "Lock icon for E2E DMs and checkmark for signed channel messages"
      contains: "EncryptionIndicator"
    - path: "client/src/renderer/src/components/KeyRotationNotice.tsx"
      provides: "Inline system message for key rotation events"
      contains: "KeyRotationNotice"
  key_links:
    - from: "client/src/renderer/src/components/ServerRail.tsx"
      to: "client/src/renderer/src/stores/dm.ts"
      via: "DM icon click sets dmView=true, reads getTotalDmUnread for badge"
      pattern: "setDmView"
    - from: "client/src/renderer/src/components/DmChatView.tsx"
      to: "client/src/renderer/src/hooks/useDm.ts"
      via: "useDm hook provides messages, send, loadOlder for active conversation"
      pattern: "useDm"
    - from: "client/src/renderer/src/components/MainContent.tsx"
      to: "client/src/renderer/src/components/DmChatView.tsx"
      via: "Renders DmChatView when dmView=true and activeDmConversationId is set"
      pattern: "DmChatView"
    - from: "client/src/renderer/src/components/DmComposer.tsx"
      to: "client/src/renderer/src/hooks/useDm.ts"
      via: "useDmKeyStatus checks if peer key is available; disabled if not"
      pattern: "useDmKeyStatus"
    - from: "client/src/renderer/src/components/UserProfilePopup.tsx"
      to: "client/src/renderer/src/stores/dm.ts"
      via: "'Message' button creates conversation and navigates to DM view"
      pattern: "createConversation"
    - from: "client/src/renderer/src/components/MessageRow.tsx"
      to: "client/src/renderer/src/components/EncryptionIndicator.tsx"
      via: "Shows 'signed' checkmark on channel messages"
      pattern: "EncryptionIndicator"
---

<objective>
DM user interface: server rail DM icon with unread badge, DM conversation list sidebar, DM chat view, E2E encryption indicators (lock icon for DMs, checkmark for signed channels), first-time encryption banner, key rotation notices, and "Message" button integration throughout the app.

Purpose: This is the user-facing DM experience. It brings together the server infrastructure (plan 01) and client data layer (plan 02) into a complete private messaging interface that makes encryption visible and understandable without being intrusive.

Output: DmConversationList, DmChatView, DmComposer, DmMessageRow, EncryptionBanner, EncryptionIndicator, KeyRotationNotice components. Updated ServerRail, MainContent, ChannelSidebar, MessageRow, UserProfilePopup, and UiSlice.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-direct-messages/05-CONTEXT.md
@.planning/phases/05-direct-messages/05-01-SUMMARY.md
@.planning/phases/05-direct-messages/05-02-SUMMARY.md

Key existing files to reference:
@client/src/renderer/src/components/ServerRail.tsx (server icon rail -- add DM icon at top)
@client/src/renderer/src/components/ChannelSidebar.tsx (sidebar pattern -- DM list follows same width/style)
@client/src/renderer/src/components/MainContent.tsx (central panel routing)
@client/src/renderer/src/components/ChatView.tsx (message list pattern to reuse for DMs)
@client/src/renderer/src/components/MessageComposer.tsx (composer pattern to adapt for DMs)
@client/src/renderer/src/components/MessageRow.tsx (message row pattern -- add signed indicator)
@client/src/renderer/src/components/UserProfilePopup.tsx (add "Message" button)
@client/src/renderer/src/stores/ui.ts (activePanel state -- extend for DM view)
@client/src/renderer/src/stores/dm.ts (from plan 02 -- DM state)
@client/src/renderer/src/hooks/useDm.ts (from plan 02 -- DM data)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Encryption indicators, banner, key rotation notice, and DM message row</name>
  <files>
    client/src/renderer/src/components/EncryptionBanner.tsx
    client/src/renderer/src/components/EncryptionIndicator.tsx
    client/src/renderer/src/components/KeyRotationNotice.tsx
    client/src/renderer/src/components/DmMessageRow.tsx
    client/src/renderer/src/components/MessageRow.tsx
  </files>
  <action>
**EncryptionIndicator.tsx:**

Create a small, reusable indicator component. Two modes:

1. `mode="e2e"` (for DMs): Lock icon. A small SVG lock icon (or unicode padlock character) in a muted color (e.g., text-green-400/60). Size: 12-14px. Tooltip on hover: "End-to-end encrypted".
2. `mode="signed"` (for channel messages): Checkmark icon. A small SVG checkmark (or unicode check mark) in a muted color (e.g., text-blue-400/60). Size: 12-14px. Tooltip on hover: "Signed by sender".

Props: `{ mode: 'e2e' | 'signed', className?: string }`.

Per CONTEXT.md: "Channel messages show a differentiated 'signed' indicator (e.g., checkmark) -- users learn the difference between E2E encrypted DMs and signed channel messages."

Keep the indicators subtle -- they should be visible but not dominate the message layout. Place them near the timestamp area or after the sender name.

**EncryptionBanner.tsx:**

Create a dismissible banner for first-time DM conversations. Per CONTEXT.md:
- Plain-language explanation: "Only you and [user] can read these messages. Not even the server operator can see them."
- Self-contained, no external links.
- Styled like Signal's "Messages are end-to-end encrypted" banner but friendlier.
- Layout: Full-width banner at top of DM conversation, bg-green-900/20 or bg-blue-900/20, border-b border-green-500/20, p-3. Lock icon on the left. Text in the center. Dismiss X button on the right.
- Props: `{ recipientName: string, onDismiss: () => void }`.
- On dismiss: Call `dismissEncryptionBanner()` in the DM store (persists to cached state so it never shows again).
- Per CONTEXT.md: "First-time DM: dismissible educational banner... After dismissed: subtle lock icon near message input or conversation header."

**KeyRotationNotice.tsx:**

Inline system message for key rotation events. Per CONTEXT.md:
- "[User]'s encryption keys have changed" -- non-blocking, conversation continues.
- Styled like WhatsApp's yellow "security code changed" inline notice.
- Layout: Centered text in a pill/badge, bg-yellow-900/20, border border-yellow-500/20, rounded-full, px-4, py-1, text-xs, text-yellow-300/80. An info icon or lock-refresh icon before the text.
- Props: `{ displayName: string, timestamp: number }`.
- This appears inline in the message list, positioned by timestamp like a date separator.

**DmMessageRow.tsx:**

DM-specific message row. Similar to the channel MessageRow but with DM-specific features:

Props: `{ message: DecryptedDmMessage, isGrouped: boolean, isOfflineSeparator?: boolean }`.

Layout:
- Full message (not grouped): Avatar (40px colored circle with first initial), display name in bold, timestamp in muted text, lock icon (EncryptionIndicator mode="e2e") next to timestamp, then message content below.
- Grouped message (continuation): No avatar/name/timestamp. Small left margin. Hover shows exact time tooltip.
- Content: Render via `<MarkdownContent content={message.content} />` (reuse from Phase 4).
- Decryption failure: If `message.decryptionFailed`, show "[Unable to decrypt this message]" in italic muted text with a warning icon. Tooltip: "This message could not be decrypted. The sender may have rotated their keys."
- Offline separator: When `isOfflineSeparator` is true, render a subtle divider above the message: "--- Messages received while you were offline ---" in centered muted text (similar to date separators in ChatView). Per CONTEXT.md: "Offline messages appear inline in conversation in chronological order with a subtle 'received while offline' separator line."
- Right-click context menu: Copy Text, Delete for Me (calls deleteLocalDmMessage), Copy Message ID.
- NO hover toolbar with React/Reply -- DMs in v1 don't have reactions. Keep it simple.

**Update MessageRow.tsx (channel messages):**

Add the `EncryptionIndicator` with `mode="signed"` to channel message rows. Place it next to the timestamp, similar to how it was described in plan 04-03. This fulfills SEC-07: "User can see encryption indicators in the UI confirming that DMs are end-to-end encrypted and channel messages are signed."

Import EncryptionIndicator and render `<EncryptionIndicator mode="signed" />` in the timestamp area of each message row.
  </action>
  <verify>
`cd client && npx tsc --noEmit` -- EncryptionBanner, EncryptionIndicator, KeyRotationNotice, DmMessageRow, updated MessageRow compile without type errors.
Verify EncryptionIndicator renders different icons for 'e2e' and 'signed' modes.
Verify EncryptionBanner has dismiss behavior and shows recipient name.
Verify DmMessageRow handles decryptionFailed and offline separator cases.
  </verify>
  <done>
EncryptionIndicator shows lock icon for DMs and checkmark for channel messages. EncryptionBanner displays dismissible E2E explanation on first DM. KeyRotationNotice renders inline yellow pill for key changes. DmMessageRow handles encrypted DM display, decryption failures, and offline separators. Channel MessageRow updated with signed indicator. SEC-07 requirement fulfilled with visible encryption/signing indicators.
  </done>
</task>

<task type="auto">
  <name>Task 2: DM conversation list, chat view, composer, and integration into app layout</name>
  <files>
    client/src/renderer/src/components/ServerRail.tsx
    client/src/renderer/src/components/DmConversationList.tsx
    client/src/renderer/src/components/DmChatView.tsx
    client/src/renderer/src/components/DmComposer.tsx
    client/src/renderer/src/components/MainContent.tsx
    client/src/renderer/src/components/ChannelSidebar.tsx
    client/src/renderer/src/components/UserProfilePopup.tsx
    client/src/renderer/src/stores/ui.ts
  </files>
  <action>
**UiSlice Extension:**

Update `client/src/renderer/src/stores/ui.ts`:
- The DM view state is in the DM store (dmView boolean from plan 02). No changes needed to UiSlice for the basic toggle. However, ensure the activePanel type allows the existing panels to coexist with DM view. DM view is orthogonal to activePanel -- when dmView is true, the sidebar shows DM conversations instead of channels, and the main content shows DM chat instead of channel chat. The activePanel ('chat', 'settings', etc.) is for within-channel views.

**ServerRail.tsx (DM Icon):**

Update the existing server rail component:
- Add a DM icon at the TOP of the server rail, above the server list. Per CONTEXT.md: "DM icon at the top of the server rail (Discord-style). Clicking it replaces the channel sidebar with the DM conversation list."
- Icon: A speech bubble icon or a "friends" icon (two people silhouette). Can use a simple SVG or Unicode character. Style it similar to server icons: rounded circle, 48px, bg-[var(--color-bg-tertiary)], hover:bg-[var(--color-bg-secondary)].
- Active state: When dmView is true, highlight the DM icon (bg-blue-500/20 or rounded-lg transition like Discord's server icon animation).
- Unread badge: Red circle badge at top-right of the DM icon showing `getTotalDmUnread()` count. Per CONTEXT.md: "Red circle with unread DM count on the DM icon in the server rail -- always visible regardless of what you're viewing." Use the same badge style as channel unread badges (bg-red-500, text-white, rounded-full, min-w-5, text-xs, font-bold).
- Click handler: Toggle `setDmView(!dmView)`. When entering DM view, deselect any active channel (set activeChannelId to null). When leaving DM view, deselect active DM conversation.
- Visual separator: Add a thin horizontal line (border-b border-white/10) between the DM icon and the server list.

**DmConversationList.tsx:**

Per CONTEXT.md: "DM conversation list shows: user avatar, name, last message preview, timestamp, unread badge. Mirrors channel sidebar but for people."

Props: none (reads from DM store).

Layout: Same width and styling as ChannelSidebar (w-60, bg-[var(--color-bg-secondary)], border-r border-white/5).

Header: "Direct Messages" in uppercase, small, bold, muted text. Padding at top.

Conversation items:
- Each row: User avatar (40px colored circle with first initial, using hash-derived color from pubkey), display name (bold if unread), last message preview (since content is E2E encrypted, the server sends empty preview -- show timestamp of last message instead, e.g., "2 hours ago" or "Yesterday" using date-fns), unread badge (same style as channel UnreadBadge).
- Active state: The currently selected conversation has bg-white/5 highlight.
- Click: Set `activeDmConversationId` to the conversation id. Load messages for this conversation.
- Sort: By lastMessageAt DESC (most recent first, per CONTEXT.md).
- Empty state: When no conversations exist, show centered text: "No direct messages yet. Click a user's name to start a conversation."

The DM conversation list renders in place of the ChannelSidebar when dmView is true.

**DmChatView.tsx:**

Per CONTEXT.md: "DM view is conversation only (full width). No right panel. Profile info accessible by clicking user's name at top."

Layout (full height flex column):
- Conversation header (h-12, border-b): Display name of the other participant. Lock icon (EncryptionIndicator mode="e2e"). Click on name opens UserProfilePopup for that user.
- EncryptionBanner (conditional): Show only if `!dmEncryptionBannerDismissed` from DM store.
- Message list (flex-1, overflow-y-auto): Renders DmMessageRow components. Reuse the grouping logic from ChatView -- group consecutive messages from the same sender within 5 minutes. Include date separators. Include offline separators when messages transition from "sent while online" to "received while offline".
  - Use @tanstack/react-virtual useVirtualizer for virtualized rendering (same pattern as ChatView).
  - Stick-to-bottom behavior, scroll-to-bottom button when scrolled up, infinite scroll up for history.
- KeyRotationNotice: Insert inline in the message list at the timestamp where a key rotation occurred.
- DmComposer at bottom.

Integration with useDm hook:
- Call `useDm(activeDmConversationId)` to get messages, hasMore, loadOlder, send.
- Pass the recipient's pubkey (derived from the conversation participants -- the one that isn't the current user).

**DmComposer.tsx:**

Similar to MessageComposer from Phase 4 but with DM-specific features:

- Auto-expanding textarea (same pattern: 1 line min, 5 lines max, then scroll).
- Enter sends, Shift+Enter newline.
- Placeholder: "Message [display_name]" (per Discord pattern).
- Lock icon inline in or near the composer (per CONTEXT.md: "After dismissed: subtle lock icon near message input or conversation header for DMs"). Place a small lock icon at the left of the composer input or in the corner.
- Key status awareness: Use `useDmKeyStatus(recipientPubkey)` hook.
  - If key is available: Normal composer, messages can be sent.
  - If key is NOT available: Disable the textarea, show "Waiting for encryption keys from [user]" in the placeholder area. Per CONTEXT.md: "If key exchange fails (peer's public key unavailable): block send + explain. Message input disabled with: 'Waiting for encryption keys from [user]'. No unencrypted DMs ever sent."
  - Poll key status every 10 seconds while in this state (the peer may publish their key at any time).
- On successful send: Clear input, scroll to bottom.
- No reply mode for DMs in v1 (keep it simple).

**MainContent.tsx:**

Update the main content routing:
- When `dmView === true` AND `activeDmConversationId` is set: Render `<DmChatView />` (full width, no member list sidebar).
- When `dmView === true` AND no activeDmConversationId: Show a welcome/empty state: centered text "Select a conversation or click a user to start a new DM." with a large speech bubble icon.
- When `dmView === false`: Existing behavior (ChatView with channel content, admin panels, etc.).

**ChannelSidebar.tsx:**

The existing ChannelSidebar should be conditionally rendered:
- When `dmView === false`: Show the normal ChannelSidebar.
- When `dmView === true`: Show DmConversationList instead.

This can be handled at the parent level (e.g., in App.tsx or wherever the triple-column layout is composed). The parent checks dmView and swaps the sidebar component.

**UserProfilePopup.tsx:**

Per CONTEXT.md: "Initiate DMs by clicking a user's name/avatar anywhere (member list, message, mention) -- no dedicated compose button."

Update the existing UserProfilePopup:
- Add a "Message" button (previously disabled/hidden in Phase 4). Now active.
- On click:
  1. Call `createConversation(userPubkey)` from DM store.
  2. Set `dmView = true`.
  3. Set `activeDmConversationId` to the returned conversation id.
  4. Close the popup.
- Style: Primary-ish button, bg-blue-500/80, hover:bg-blue-500, rounded, px-4, py-1.5, text-sm, font-medium. Label: "Message".

Also update the click handlers on user names/avatars in:
- MessageRow: Clicking sender name/avatar opens UserProfilePopup (already exists from Phase 4).
- MemberListSidebar: Clicking member opens UserProfilePopup (already exists from Phase 4).
- The "Message" button in the popup is the DM entry point -- no separate "DM" click needed.

**Integration point -- Clicking any user's name/avatar to DM:**

The flow is:
1. User clicks name/avatar in message list, member sidebar, or @mention.
2. UserProfilePopup opens (existing behavior).
3. User clicks "Message" button in popup.
4. Popup creates/gets DM conversation, navigates to DM view with that conversation active.
5. DM conversation list appears in sidebar, DM chat view appears in main area.
  </action>
  <verify>
`cd client && npx tsc --noEmit` -- All new and updated components compile without type errors.
Verify ServerRail DM icon renders with unread badge.
Verify DmConversationList shows conversations sorted by recency.
Verify DmChatView renders messages with encryption indicators.
Verify DmComposer disables when peer key unavailable.
Verify MainContent routes correctly between channel view and DM view.
Verify UserProfilePopup "Message" button navigates to DM.
  </verify>
  <done>
DM UI complete: ServerRail has DM icon with red unread badge at top. DmConversationList replaces channel sidebar in DM mode with avatar/name/timestamp/unread per conversation. DmChatView renders full-width encrypted conversation with virtualized message list. DmComposer blocks sending when peer key unavailable. EncryptionBanner shows on first DM then dismissed. Lock icons on DM messages, checkmarks on channel messages (SEC-07). Key rotation notices inline. UserProfilePopup "Message" button creates conversation and navigates to DM view. Clicking any user name/avatar leads to DM via profile popup.
  </done>
</task>

</tasks>

<verification>
- DM icon visible at top of server rail with red unread badge
- Clicking DM icon switches sidebar from channels to DM conversations
- DM conversations sorted by most recent activity
- Clicking a conversation opens the DM chat view (full width, no right panel)
- First-time DM shows dismissible encryption banner
- Lock icon visible on DM messages, checkmark on channel messages
- Key rotation produces inline yellow notice in conversation
- Composer disabled with explanation when peer key unavailable
- "Message" button in UserProfilePopup creates conversation and navigates to DM
- Offline messages show "received while offline" separator
- Decryption failures show "[Unable to decrypt]" with warning icon
- Server rail DM badge always shows total unread DM count
</verification>

<success_criteria>
1. DM icon at top of server rail with red unread count badge
2. Clicking DM icon replaces channel sidebar with DM conversation list
3. DM conversations show avatar, name, timestamp, unread badge sorted by recency
4. DM chat view renders full-width with virtualized message list
5. First-time encryption banner is dismissible and explains E2E in plain language
6. Lock icon (E2E) on DMs, checkmark (signed) on channel messages
7. Key rotation: inline non-blocking notice in conversation
8. Composer disabled when peer X25519 key unavailable
9. "Message" button in profile popup starts DM conversation
10. Offline messages have subtle "received while offline" separator
11. User can scroll back through full DM history
12. MainContent correctly routes between channel and DM views
</success_criteria>

<output>
After completion, create `.planning/phases/05-direct-messages/05-03-SUMMARY.md`
</output>
