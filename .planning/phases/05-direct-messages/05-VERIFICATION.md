---
phase: 05-direct-messages
verified: 2026-02-26T06:30:00Z
status: passed
score: 4/4 success criteria verified
re_verification:
  previous_status: gaps_found
  previous_score: 3/4
  gaps_closed:
    - "Real-time WS DM push event delivery broken (JSON.parse on protobuf binary) — fixed by rewriting dm-events.ts to use fromBinary(EnvelopeSchema, data)"
    - "ws_pb.ts missing DM payload variants (fields 150-157) — fixed by regenerating via buf generate"
  gaps_remaining: []
  regressions: []
human_verification:
  - test: "In two separate app instances, user A sends a DM to user B"
    expected: "User B sees the message appear in their DM conversation view in real time without polling or reconnecting"
    why_human: "Requires running two concurrent app instances with an active WS connection; cannot exercise the full WS + protobuf decode + decrypt + render pipeline programmatically"
  - test: "User B goes offline; User A sends a DM; User B reconnects"
    expected: "DM appears in conversation with offline separator"
    why_human: "Requires coordinated connection management and timing"
  - test: "Open first DM conversation, dismiss encryption banner; close and reopen app"
    expected: "Banner does not reappear"
    why_human: "Requires verifying localStorage/cached-state persistence across restarts"
  - test: "Attempt to DM a user who has not published X25519 keys"
    expected: "Composer is disabled with 'Waiting for encryption keys from [user]' message; no message sent"
    why_human: "Requires a test account that has never called publishKey"
---

# Phase 5: Direct Messages Verification Report

**Phase Goal:** Users can have private one-on-one conversations where only the participants can read the messages, even if the coordination server is compromised
**Verified:** 2026-02-26
**Status:** passed
**Re-verification:** Yes — after gap closure (Plan 05-04 fixed WS DM push event delivery)

## Re-Verification Summary

The initial verification (2026-02-25) found one critical gap: `dm-events.ts` used `JSON.parse` on protobuf binary data, silently discarding every incoming WS DM push event. Additionally, `ws_pb.ts` was not regenerated after DM fields were added to `ws.proto`, so the TypeScript Envelope type had no DM payload cases.

Plan 05-04 fixed both issues in commit `4897053`:
- Rewrote `dm-events.ts` to use `fromBinary(EnvelopeSchema, data)` with `payload.case` switch — matching `chat-events.ts` exactly
- Regenerated `dm_pb.ts` and `ws_pb.ts` via `buf generate`, adding all DM Envelope payload variants (fields 150-157)

This re-verification confirms both fixes are in the codebase and the previously-failed truth now passes.

---

## Goal Achievement

### Observable Truths (from Success Criteria)

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | User can send and receive DMs that are E2E encrypted — server stores only encrypted blobs it cannot decrypt; real-time WS delivery works | VERIFIED | `dm-events.ts` uses `fromBinary(EnvelopeSchema, data)` (line 30), switches on `dmMessageEvent` (line 34), decrypts via `decryptDmMessage`, broadcasts via `IPC.PUSH_DM_EVENT` (line 150). `ws_pb.ts` exports `case: "dmMessageEvent"` at field 150. Zero `JSON.parse` calls remain. |
| 2 | User can receive DMs sent while offline, delivered via encrypted blobs stored on the coordination server | VERIFIED | `GET /api/dm/offline` endpoint in `server/src/dm/offline.rs`, `dm_offline_queue` table with 30-day TTL, `DM_FETCH_OFFLINE` IPC handler fetches on reconnect — unchanged from initial verification |
| 3 | User can see DM conversations listed separately from channel messages in a dedicated DM section | VERIFIED | `DmConversationList.tsx` present; `Main.tsx` conditionally renders `<DmConversationList />` vs `<ChannelSidebar />` based on `dmView` — unchanged from initial verification |
| 4 | User can see encryption indicators confirming DMs are E2E encrypted and channel messages are signed | VERIFIED | `EncryptionIndicator.tsx` with `mode="e2e"` (lock SVG, green) in `DmMessageRow` and `mode="signed"` (checkmark SVG, blue) in `MessageRow` — unchanged from initial verification |

**Score:** 4/4 success criteria verified

---

## Required Artifacts

### Plan 04 — Gap Closure (WS DM Push Event Fix) — FULL VERIFICATION

| Artifact | Status | Details |
|----------|--------|---------|
| `shared/types/generated/dm_pb.ts` | VERIFIED | Exists (356 lines); exports `DmMessageEventSchema` (line 207), `DmConversationCreatedEventSchema` (line 224), `DmKeyRotatedEventSchema` (line 255), `EncryptedDmMessageSchema` (line 153). Generated by `protoc-gen-es v2.11.0`. |
| `shared/types/generated/ws_pb.ts` | VERIFIED | Exists (591 lines); Envelope oneof includes `case: "dmMessageEvent"` (field 150, line 470), `case: "dmConversationCreatedEvent"` (field 151, line 476), `case: "dmKeyRotatedEvent"` (field 152, line 482), plus DmHistoryRequest/Response and DmConversationList variants (fields 153-157). Imports `file_dm`. |
| `client/src/main/ws/dm-events.ts` | VERIFIED | 166 lines; imports `fromBinary` and `EnvelopeSchema`; switches on `payload.case` for all three DM event types; zero `JSON.parse` calls; `broadcastToRenderers(IPC.PUSH_DM_EVENT, ...)` on lines 61 and 150. |

### Previously Verified Artifacts — REGRESSION CHECK

| Artifact | Status | Details |
|----------|--------|---------|
| `shared/proto/dm.proto` | VERIFIED (no regression) | File present; unchanged |
| `server/src/dm/conversations.rs` | VERIFIED (no regression) | File present; unchanged |
| `server/src/dm/messages.rs` | VERIFIED (no regression) | File present; unchanged |
| `server/src/dm/keys.rs` | VERIFIED (no regression) | File present; unchanged |
| `server/src/dm/offline.rs` | VERIFIED (no regression) | File present; unchanged |
| `client/src/main/ipc/dm-crypto.ts` | VERIFIED (no regression) | File present; unchanged |
| `client/src/main/ipc/dm.ts` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/stores/dm.ts` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/hooks/useDm.ts` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/components/DmConversationList.tsx` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/components/DmChatView.tsx` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/components/DmComposer.tsx` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/components/DmMessageRow.tsx` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/components/EncryptionBanner.tsx` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/components/EncryptionIndicator.tsx` | VERIFIED (no regression) | File present; unchanged |
| `client/src/renderer/src/components/KeyRotationNotice.tsx` | VERIFIED (no regression) | File present; unchanged |

---

## Key Link Verification

### Plan 04 Key Links — FULL VERIFICATION

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `client/src/main/ws/dm-events.ts` | `shared/types/generated/ws_pb.ts` | `fromBinary(EnvelopeSchema, data)` decoding | WIRED | Line 11: `import { fromBinary } from '@bufbuild/protobuf'`; line 12: `import { EnvelopeSchema } from '@shared/generated/ws_pb'`; line 30: `fromBinary(EnvelopeSchema, data)` called in message handler |
| `client/src/main/ws/dm-events.ts` | `client/src/renderer/src/stores/dm.ts` | `broadcastToRenderers(IPC.PUSH_DM_EVENT, ...)` broadcast to renderer | WIRED | Lines 61 and 150: `broadcastToRenderers(IPC.PUSH_DM_EVENT, dmEvent)`; line 68: `broadcastToRenderers(IPC.PUSH_DM_KEY_ROTATED, ...)` — renderer store listens on these IPC channels via `useDm` hook |

### Previously Verified Key Links — REGRESSION CHECK (all unchanged)

| From | To | Via | Status |
|------|----|-----|--------|
| `server/src/dm/messages.rs` | `server/src/ws/broadcast.rs` | `send_to_user` after storing encrypted DM | WIRED |
| `server/src/dm/keys.rs` | `server/src/db/migrations.rs` | Stores X25519 keys in `dm_public_keys` table | WIRED |
| `server/src/dm/offline.rs` | `server/src/dm/messages.rs` | Offline queue populated when recipient has no active WS connection | WIRED |
| `client/src/main/ipc/dm-crypto.ts` | `client/src/main/ipc/crypto.ts` | `getSessionKeys()` for X25519 derivation | WIRED |
| `client/src/main/ipc/dm.ts` | `client/src/main/ipc/dm-crypto.ts` | Encrypts before sending, decrypts after receiving | WIRED |
| `client/src/renderer/src/hooks/useDm.ts` | `client/src/renderer/src/stores/dm.ts` | Hook reads conversations/messages, triggers IPC mutations | WIRED |
| `Main.tsx` | `DmConversationList.tsx` / `ChannelSidebar.tsx` | Conditional sidebar on `dmView` | WIRED |
| `DmChatView.tsx` | `useDm` hook | `useDm(activeDmConversationId)` provides messages, load, loadOlder | WIRED |
| `UserProfilePopup.tsx` | `stores/dm.ts` | "Message" button creates conversation and navigates to DM view | WIRED |
| `MessageRow.tsx` | `EncryptionIndicator.tsx` | `mode="signed"` on channel messages | WIRED |

---

## Requirements Coverage

| Requirement | Source Plans | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| DM-01 | 05-01, 05-02, 05-03, 05-04 | E2E encrypted DMs with X25519 key exchange, only participants hold decryption keys | SATISFIED | X25519 derivation in `dm-crypto.ts`; XChaCha20-Poly1305 encryption on send; real-time WS delivery now working via protobuf `fromBinary` decode in `dm-events.ts`; server stores only opaque encrypted blobs. Gap confirmed closed. |
| DM-02 | 05-01, 05-02 | Receive DMs while offline via encrypted blobs on coordination server | SATISFIED | `dm_offline_queue` table, `GET /api/dm/offline` endpoint, `DM_FETCH_OFFLINE` IPC handler, 30-day TTL background cleanup |
| DM-03 | 05-01, 05-03 | DM conversations listed separately from channel messages | SATISFIED | `DmConversationList` in sidebar, `dmView` toggle, separate `DmChatView` in MainContent |
| SEC-05 | 05-01, 05-02 | DMs use per-conversation X25519 keys; coordination server stores only encrypted blobs | SATISFIED | `server/src/dm/messages.rs` stores `encrypted_payload` as opaque BLOB; server never holds decryption keys |
| SEC-07 | 05-03 | User can see encryption indicators — DMs E2E encrypted, channel messages signed | SATISFIED | `EncryptionIndicator mode="e2e"` on DM messages (lock, green); `mode="signed"` on channel `MessageRow` (checkmark, blue) |

**Orphaned requirements:** None. All 5 requirement IDs (DM-01, DM-02, DM-03, SEC-05, SEC-07) from plan frontmatter are accounted for. REQUIREMENTS.md traceability table marks all five as "Complete" for Phase 5.

---

## Anti-Patterns

### Cleared (were blockers in initial verification)

| File | Issue | Resolution |
|------|-------|------------|
| `client/src/main/ws/dm-events.ts` | JSON.parse on protobuf binary Uint8Array — always threw, silently discarded all WS DM events | FIXED — rewritten to use `fromBinary(EnvelopeSchema, data)` in commit `4897053` |
| `shared/types/generated/ws_pb.ts` | Missing DM payload cases in Envelope oneof — ws.proto updated but TypeScript not regenerated | FIXED — `buf generate` regenerated types with all DM cases (fields 150-157) |

### Remaining (non-blockers)

| File | Issue | Severity | Impact |
|------|-------|----------|--------|
| `client/src/main/ipc/dm.ts` (DM_DELETE_LOCAL handler) | No-op main process implementation — comment "Future: persist DM messages in local SQLite" | WARNING | Delete-for-self works only in renderer memory; cleared on restart. Does not block any success criterion. |

---

## Human Verification Required

The following items need human testing and cannot be verified programmatically:

### 1. Real-Time DM Delivery (Requires Two Instances)

**Test:** In two separate app instances, user A sends a DM to user B
**Expected:** User B sees the message appear in their DM conversation view immediately without polling or reconnecting
**Why human:** Requires running two concurrent app instances with active WS connections; cannot exercise the full WS + protobuf decode + decrypt + store dispatch + render pipeline programmatically

### 2. Offline DM Delivery

**Test:** User B goes offline; User A sends a DM; User B reconnects
**Expected:** DM appears in conversation with "received while offline" separator
**Why human:** Requires coordinated connection management and timing

### 3. Encryption Banner Persistence

**Test:** Open first DM conversation, dismiss the encryption banner; close and reopen app
**Expected:** Banner does not reappear
**Why human:** Requires verifying localStorage/cached-state persistence across restarts

### 4. Key Unavailable State

**Test:** Attempt to DM a user who has not published X25519 keys
**Expected:** Composer is disabled with "Waiting for encryption keys from [user]" message; no message sent
**Why human:** Requires a test account that has never called publishKey

---

## Gap Closure Confirmation

The single gap identified in the initial verification is confirmed closed:

**Gap:** "User can send and receive direct messages that are end-to-end encrypted — real-time WS delivery works"

**Root cause:** `dm-events.ts` called `JSON.parse(new TextDecoder().decode(data))` on protobuf binary `Uint8Array` data. This always threw a parse error. The catch block silently returned. Every server-pushed DM event was discarded. Additionally, `ws_pb.ts` was not regenerated after DM fields were added to `ws.proto`, so `Envelope.payload` had no DM cases in TypeScript.

**Fix verified in codebase:**
- `dm-events.ts` line 11: `import { fromBinary } from '@bufbuild/protobuf'`
- `dm-events.ts` line 12: `import { EnvelopeSchema } from '@shared/generated/ws_pb'`
- `dm-events.ts` line 30: `const envelope = fromBinary(EnvelopeSchema, data)` — protobuf decode, not JSON
- `dm-events.ts` lines 34, 42, 65: switch cases for `dmMessageEvent`, `dmConversationCreatedEvent`, `dmKeyRotatedEvent`
- `dm-events.ts` lines 61, 150: `broadcastToRenderers(IPC.PUSH_DM_EVENT, ...)` — events now reach renderer
- `ws_pb.ts` lines 468-512: Envelope payload oneof includes all DM cases (fields 150-157)
- `dm_pb.ts`: New file with `DmMessageEventSchema`, `DmConversationCreatedEventSchema`, `DmKeyRotatedEventSchema`, `EncryptedDmMessageSchema`
- Zero `JSON.parse` calls remain in `dm-events.ts`
- Commit `4897053`: "fix(05-04): rewrite dm-events.ts to decode protobuf Envelope"

---

*Verified: 2026-02-26*
*Verifier: Claude (gsd-verifier)*
