---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - client/src/main/index.ts
  - client/src/main/ipc/auth.ts
  - client/src/main/ipc/crypto.ts
  - client/src/main/ipc/storage.ts
  - client/src/main/ipc/connection.ts
  - client/src/main/db/schema.ts
  - client/src/main/db/queries.ts
  - client/src/main/ws/client.ts
  - client/src/main/ws/protocol.ts
  - client/src/preload/index.ts
autonomous: true
requirements: [SEC-08]

must_haves:
  truths:
    - "Electron app launches with contextIsolation enabled, nodeIntegration disabled, and strict CSP enforced"
    - "IPC bridge round-trips work: renderer calls window.united.*, main process returns mock data"
    - "SQLite database is created on first launch with identity, servers, channels, and cached_state tables"
    - "WebSocket client connects with exponential backoff and emits connection status events to renderer"
    - "No white flash on app launch (dark backgroundColor set before window shows)"
  artifacts:
    - path: "client/src/main/index.ts"
      provides: "Electron main process with secure BrowserWindow"
      contains: "contextIsolation"
    - path: "client/src/preload/index.ts"
      provides: "contextBridge API surface"
      contains: "exposeInMainWorld"
    - path: "client/src/main/db/schema.ts"
      provides: "Local SQLite schema"
      contains: "better-sqlite3"
    - path: "client/src/main/ws/client.ts"
      provides: "WebSocket client with reconnection"
      contains: "exponentialBackoff"
  key_links:
    - from: "client/src/preload/index.ts"
      to: "client/src/main/ipc/*"
      via: "IPC handler registration"
      pattern: "ipcMain.handle"
---

<objective>
Build the Electron main process infrastructure: secure BrowserWindow with CSP and contextIsolation, preload script with typed IPC bridge, IPC handler stubs returning mock data, local SQLite database, and WebSocket client with auto-reconnect.

Purpose: Deliver the secure Electron foundation that the UI shell (Plan 01-05) and auth flows (Plan 01-06) will build upon.
Output: Electron app with security hardening, IPC bridge, SQLite, and WebSocket client — all with stub/mock implementations.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT-CLIENT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Electron main process with security, IPC bridge, and local SQLite</name>
  <files>client/src/main/index.ts, client/src/preload/index.ts, client/src/main/ipc/auth.ts, client/src/main/ipc/crypto.ts, client/src/main/ipc/storage.ts, client/src/main/ipc/connection.ts, client/src/main/db/schema.ts, client/src/main/db/queries.ts, client/src/main/ws/client.ts, client/src/main/ws/protocol.ts</files>
  <action>
Implement main/index.ts: BrowserWindow creation with contextIsolation: true, nodeIntegration: false, sandbox: true, webSecurity: true, backgroundColor: '#1a1a2e' (dark, prevents white flash), show: false until ready-to-show. Set strict CSP via session.webRequest.onHeadersReceived (script-src 'self', style-src 'self' 'unsafe-inline', connect-src 'self' ws: wss:). Window defaults: 1280x720, minWidth 940, minHeight 500.

Implement preload/index.ts: contextBridge.exposeInMainWorld('united', api) with full typed API surface from shared/types/ipc-bridge.ts. Methods: createIdentity, recoverFromMnemonic, unlockIdentity, connectToServer, register, signChallenge, enrollTotp, verifyTotp, getServerInfo, updateServerSettings. Push events: onConnectionStatus, onAuthError. Each method maps to ipcMain.handle in main process.

Implement IPC handler stubs in main/ipc/: auth.ts (identity creation, signing — stubs returning mock data), crypto.ts (keypair ops, mnemonic — stubs), storage.ts (SQLite read/write, safeStorage — stubs), connection.ts (WebSocket management — stubs). Stubs return realistic mock data so renderer UI can be built against them.

Implement main/db/schema.ts: Local SQLite schema using better-sqlite3 — tables for local_identity (fingerprint, public_key, encrypted_private_key, salt, nonce, argon2_params), servers (id, url, name, icon_data, description, last_connected), channels (id, server_id, name, category, position), cached_state (key, value, updated_at). Run migrations on app start.

Implement main/db/queries.ts: Typed query functions for identity CRUD, server CRUD, channel list caching, cached state hydration.

Implement main/ws/client.ts: WebSocket client with auto-reconnect using exponential backoff (1s, 2s, 4s, 8s, 16s, cap 30s) + random jitter. Emit connection status events to renderer via IPC push events.

Implement main/ws/protocol.ts: Protobuf encode/decode using @bufbuild/protobuf generated types.
  </action>
  <verify>npm run dev launches Electron app with secure window. DevTools console shows no CSP violations. IPC calls from renderer reach main process and return mock data. SQLite database is created on first launch.</verify>
  <done>Electron main process launches with full security hardening. IPC bridge functional with mock handlers. SQLite initialized. WebSocket client ready.</done>
</task>

</tasks>

<verification>
- Electron app launches with no security warnings in DevTools
- CSP blocks inline scripts (verify by checking for violations)
- IPC round-trip works (renderer calls window.united.*, gets mock response)
- SQLite database created at expected path with correct schema
- No white flash on launch
</verification>

<success_criteria>
- Electron renderer has contextIsolation enabled, nodeIntegration disabled, strict CSP
- IPC bridge operational with typed request-response and push event patterns
- SQLite database initialized with migration system
- WebSocket client ready with exponential backoff reconnection
</success_criteria>

<output>
Create `.planning/phases/01-foundation/01-04-SUMMARY.md` with accomplishments, commits, and metrics.
</output>
