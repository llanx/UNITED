---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/proto/auth.proto
  - shared/proto/identity.proto
  - shared/proto/server.proto
  - shared/proto/ws.proto
  - shared/types/api.ts
  - shared/types/ws-protocol.ts
  - shared/types/ipc-bridge.ts
  - server/Cargo.toml
  - server/build.rs
  - server/src/main.rs
  - client/package.json
  - client/electron.vite.config.ts
  - client/tsconfig.json
  - .gitignore
autonomous: true
requirements: [SEC-01, SEC-02, SRVR-07]

must_haves:
  truths:
    - "cargo check passes in server/ with prost-generated types from shared/proto/*.proto"
    - "npm install && tsc --noEmit pass in client/ with shared/types/*.ts resolved"
    - "Protobuf ChallengeResponse round-trips identically between Rust (prost) and TypeScript (@bufbuild/protobuf)"
    - "sodium-native and better-sqlite3 rebuild for Electron 40, or fallback strategy is documented"
    - "shared/types/ipc-bridge.ts defines all window.united methods matching CONTEXT docs"
  artifacts:
    - path: "shared/proto/auth.proto"
      provides: "Auth message types for challenge-response"
      contains: "ChallengeRequest"
    - path: "shared/proto/identity.proto"
      provides: "Identity and rotation record types"
      contains: "IdentityBlob"
    - path: "shared/proto/server.proto"
      provides: "Server info and settings types"
      contains: "ServerInfo"
    - path: "shared/proto/ws.proto"
      provides: "WebSocket envelope with oneof payload"
      contains: "Envelope"
    - path: "shared/types/ipc-bridge.ts"
      provides: "Typed IPC API surface for window.united"
      contains: "UnitedAPI"
    - path: "server/Cargo.toml"
      provides: "Rust server dependency manifest"
      contains: "axum"
    - path: "client/package.json"
      provides: "Client dependency manifest"
      contains: "electron"
  key_links:
    - from: "server/build.rs"
      to: "shared/proto/*.proto"
      via: "prost-build codegen"
      pattern: "prost_build"
    - from: "shared/types/ipc-bridge.ts"
      to: "client/src/preload"
      via: "contextBridge API definition"
      pattern: "UnitedAPI"
---

<objective>
Define shared protobuf schemas, REST API types, IPC bridge type definitions, and monorepo directory structure that both developers will build against. This is the "Day 0" joint task from PARALLEL-DEV.md.

Purpose: Establish byte-level compatible contracts between Rust server and TypeScript client before parallel development begins.
Output: 4 proto files, 3 TypeScript type files, server Cargo.toml, client package.json, build tooling
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/IDENTITY-ARCHITECTURE.md
@.planning/PARALLEL-DEV.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-CONTEXT-CLIENT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Monorepo scaffold and build tooling</name>
  <files>server/Cargo.toml, server/build.rs, server/src/main.rs, client/package.json, client/electron.vite.config.ts, client/tsconfig.json, .gitignore</files>
  <action>
Create the top-level directory structure: server/, client/, shared/proto/, shared/types/, tests/integration/.

Create server/Cargo.toml with pinned dependencies from 01-RESEARCH.md Standard Stack (server section): axum, tokio, serde, rusqlite, ed25519-dalek, jsonwebtoken, totp-rs, argon2, prost, tonic, tower, tower-governor, dashmap, uuid, chrono, figment, clap, tracing, tracing-subscriber.

Create server/build.rs with prost-build configuration pointing to ../shared/proto/*.proto for codegen.

Create server/src/main.rs as a minimal placeholder (fn main() { println!("UNITED server"); }).

Create client/package.json with all dependencies from 01-RESEARCH.md Standard Stack (client section): electron 40, electron-vite, react 19, zustand 5, @bufbuild/protobuf, @scure/bip39, sodium-native, better-sqlite3, qrcode.react, @tanstack/react-virtual.

Create client/electron.vite.config.ts with main/preload/renderer config. Set assetsInlineLimit: 0 (CSP pitfall from research — inline assets violate CSP).

Create client/tsconfig.json and sub-configs for main/renderer.

Create .gitignore (Rust target/, node_modules/, .env, *.db, dist/, out/).
  </action>
  <verify>cargo check passes in server/. npm install completes in client/.</verify>
  <done>Both codebases scaffold with all dependencies resolved. Directory structure matches PARALLEL-DEV.md monorepo layout.</done>
</task>

<task type="auto">
  <name>Task 2: Protobuf schemas and shared type definitions</name>
  <files>shared/proto/auth.proto, shared/proto/identity.proto, shared/proto/server.proto, shared/proto/ws.proto, shared/types/api.ts, shared/types/ws-protocol.ts, shared/types/ipc-bridge.ts</files>
  <action>
Create shared/proto/auth.proto: ChallengeRequest (fingerprint), ChallengeResponse (challenge_id, challenge_bytes), VerifyRequest (challenge_id, public_key, signature, fingerprint), VerifyResponse (access_token, refresh_token), RefreshRequest (refresh_token), RefreshResponse (access_token, refresh_token), RegisterRequest (public_key, fingerprint, display_name, encrypted_blob), RegisterResponse (user_id).

Create shared/proto/identity.proto: IdentityBlob (fingerprint, public_key, encrypted_private_key, salt, nonce, argon2_params), GenesisRecord (public_key, created_at, signature), RotationRecord (prev_key, new_key, reason, timestamp, signature_old, signature_new), Argon2Params (m_cost, t_cost, p_cost).

Create shared/proto/server.proto: ServerInfo (name, description, icon_data, registration_mode), ServerSettings (name, description, icon_data, registration_mode), UpdateSettingsRequest (settings), UpdateSettingsResponse (settings).

Create shared/proto/ws.proto: Envelope with request_id + oneof payload covering all message types, ErrorResponse.

Create shared/types/api.ts: TypeScript interfaces for REST endpoints — POST /api/auth/challenge, POST /api/auth/verify, POST /api/auth/refresh, POST /api/auth/register, GET /api/identity/blob/{fingerprint}, PUT /api/identity/blob, GET /api/server/info, PUT /api/server/settings, POST /api/auth/totp/enroll, POST /api/auth/totp/verify, POST /api/identity/rotate, POST /api/identity/rotate/cancel.

Create shared/types/ws-protocol.ts: WebSocket message union type, close code constants (4001=expired, 4002=invalid, 4003=banned).

Create shared/types/ipc-bridge.ts: Full UnitedAPI interface for window.united with all methods (createIdentity, recoverFromMnemonic, unlockIdentity, connectToServer, register, signChallenge, enrollTotp, verifyTotp, getServerInfo, updateServerSettings), plus declare global { interface Window { united: UnitedAPI } }.
  </action>
  <verify>prost-build generates server/src/proto/ types from build.rs. TypeScript compiles with tsc --noEmit on shared/types/.</verify>
  <done>All proto files define the shared contract. TypeScript types compile. Rust codegen produces valid types.</done>
</task>

<task type="auto">
  <name>Task 3: Code generation validation and native module test</name>
  <files>tests/integration/proto-roundtrip.ts</files>
  <action>
Run cargo build in server/ to confirm prost codegen produces valid Rust types.

Run @bufbuild/protoc-gen-es (or buf generate) in client/ to generate _pb.ts files from proto schemas.

Create a minimal round-trip test: Rust encodes a ChallengeResponse protobuf, save bytes to file; TypeScript decodes same bytes and verifies fields match. This validates cross-language protobuf compatibility (Pitfall 7 and Pitfall 8 from research).

Run @electron/rebuild on sodium-native and better-sqlite3 to validate native module rebuilds succeed (Pitfall 1 from research). If rebuild fails, document fallback plan (libsodium-wrappers for sodium-native, sql.js for better-sqlite3).
  </action>
  <verify>All protobuf types compile in both languages. Native module rebuild passes or fallback documented. Round-trip test passes.</verify>
  <done>Cross-language protobuf compatibility confirmed. Native modules working or fallbacks in place.</done>
</task>

</tasks>

<verification>
- cargo check and cargo build pass in server/
- npm install and tsc --noEmit pass in client/
- Protobuf round-trip test confirms Rust ↔ TypeScript compatibility
- Native module rebuild verified or fallback documented
- Directory structure matches PARALLEL-DEV.md
</verification>

<success_criteria>
- Both developers can clone, install deps, and build independently
- Shared proto schemas define the full auth, identity, server, and WS contract
- IPC bridge types define the complete preload API surface
- Cross-language serialization is byte-compatible
</success_criteria>

<output>
Create `.planning/phases/01-foundation/01-01-SUMMARY.md` with accomplishments, commits, and metrics.
</output>
