---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: [01-02]
files_modified:
  - server/src/auth/totp.rs
  - server/src/identity/blob.rs
  - server/src/identity/rotation.rs
  - server/src/identity/mod.rs
  - server/src/ws/mod.rs
  - server/src/ws/handler.rs
  - server/src/ws/actor.rs
  - server/src/ws/protocol.rs
  - server/src/routes.rs
  - server/Dockerfile
  - server/tests/auth_test.rs
  - server/tests/ws_test.rs
autonomous: true
requirements: [SEC-09, SEC-10, SEC-11]

must_haves:
  truths:
    - "TOTP 2FA enrollment and verification works with standard authenticator apps"
    - "Identity blobs are stored and retrievable by fingerprint"
    - "Key rotation with 72-hour cancellation window is enforced"
    - "WebSocket connections are authenticated and maintained with proper cleanup"
    - "Server runs in Docker container"
  artifacts:
    - path: "server/src/auth/totp.rs"
      provides: "TOTP enrollment and verification"
      contains: "totp_rs"
    - path: "server/src/identity/blob.rs"
      provides: "Encrypted identity blob storage and retrieval"
      contains: "fingerprint"
    - path: "server/src/identity/rotation.rs"
      provides: "Key rotation with cancellation window"
      contains: "cancellation_deadline"
    - path: "server/src/ws/actor.rs"
      provides: "Actor-per-connection WebSocket pattern"
      contains: "mpsc"
    - path: "server/Dockerfile"
      provides: "Multi-stage Docker build"
      contains: "cargo-chef"
  key_links:
    - from: "server/src/ws/handler.rs"
      to: "server/src/auth/jwt.rs"
      via: "WebSocket auth via query param"
      pattern: "token"
    - from: "server/src/ws/actor.rs"
      to: "server/src/ws/protocol.rs"
      via: "protobuf message dispatch"
      pattern: "Envelope"
    - from: "server/src/identity/rotation.rs"
      to: "server/src/db"
      via: "rotation chain persistence"
      pattern: "rotation_records"
---

<objective>
Add TOTP two-factor authentication, identity blob retrieval endpoints, key rotation chain management, WebSocket handler with actor-per-connection pattern and protobuf dispatch, and Docker container build. This completes the server side of Phase 1.

Purpose: Complete all server-side Phase 1 requirements including 2FA, identity storage, key rotation, real-time connections, and deployment.
Output: Full server with TOTP, blob storage, key rotation, WebSocket, and Docker image.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/IDENTITY-ARCHITECTURE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TOTP, identity blobs, and key rotation</name>
  <files>server/src/auth/totp.rs, server/src/identity/blob.rs, server/src/identity/rotation.rs, server/src/identity/mod.rs, server/src/routes.rs</files>
  <action>
Implement auth/totp.rs: POST /api/auth/totp/enroll — generate TOTP secret using totp-rs, encrypt with server-side AES-256 key (random key generated on first boot, stored alongside JWT key), store in users table (totp_secret_encrypted), return otpauth:// URI + secret for QR display. POST /api/auth/totp/verify — verify 6-digit TOTP code against stored secret. TOTP verification required during auth/verify if user has TOTP enrolled.

Implement identity/blob.rs: GET /api/identity/blob/{fingerprint} — return encrypted blob (public endpoint with rate limiting per user decision: "public by fingerprint with rate limiting"). PUT /api/identity/blob — authenticated endpoint, store/update encrypted blob for the calling user's fingerprint.

Implement identity/rotation.rs: POST /api/identity/rotate — accept RotationRecord (prev_key, new_key, reason, signature_old, signature_new). Verify both signatures. Update user's active public_key. Set cancellation_deadline = now + 72 hours. Invalidate all existing JWTs (delete refresh tokens). POST /api/identity/rotate/cancel — accept cancellation signed by old key. Only valid within 72-hour window. Revert to old key. Delete refresh tokens.

Implement rotation chain queries: retrieve full chain for a fingerprint (genesis + all rotations).

Update routes.rs with new endpoints.
  </action>
  <verify>TOTP enrollment returns valid otpauth URI. TOTP verification accepts valid codes, rejects invalid. Blob GET/PUT works. Rotation creates record and updates key. Cancellation within 72h reverts key. Cancellation after 72h is rejected.</verify>
  <done>All identity management endpoints work: TOTP enrollment/verify, blob storage/retrieval, key rotation with 72h cancellation.</done>
</task>

<task type="auto">
  <name>Task 2: WebSocket handler, integration tests, and Docker</name>
  <files>server/src/ws/mod.rs, server/src/ws/handler.rs, server/src/ws/actor.rs, server/src/ws/protocol.rs, server/src/routes.rs, server/Dockerfile, server/tests/auth_test.rs, server/tests/ws_test.rs</files>
  <action>
Implement ws/handler.rs: WebSocket upgrade endpoint at /ws. Authenticate via query parameter ?token=JWT. Reject with close code (4001/4002/4003) on auth failure. On success, spawn actor.

Implement ws/actor.rs: Actor-per-connection pattern. Split WebSocket into reader/writer. Spawn writer task with mpsc::unbounded_channel. Reader loop: decode protobuf Envelope, dispatch to handler by payload type. Server-side ping every 30 seconds, close if pong not received within 10 seconds (Pitfall 5 from research). Clean up connection registry on disconnect.

Implement ws/protocol.rs: Protobuf Envelope encode/decode using prost. Message dispatch table mapping payload variants to handler functions. Support for request_id echo.

Implement connection registry: Arc&lt;DashMap&lt;UserId, Vec&lt;ConnectionSender&gt;&gt;&gt;. Tracks all active WebSocket connections per user.

Create server/Dockerfile: Multi-stage build. Stage 1: cargo-chef for dependency caching + cargo build --release. Stage 2: debian-slim runtime with only the binary + data directory. Expose port 1984. Entry point: united-server.

Write server/tests/auth_test.rs: Integration test for full auth flow (challenge -> verify -> JWT -> refresh). Test rate limiting. Test TOTP flow.

Write server/tests/ws_test.rs: Integration test for WebSocket connection, auth, ping/pong, message dispatch.
  </action>
  <verify>docker build -t united-server . succeeds. WebSocket connects with valid JWT. Invalid JWT gets close code 4001/4002. Ping/pong keepalive works. Connection cleanup on disconnect. cargo test passes all tests.</verify>
  <done>WebSocket handler works with actor pattern. Docker image builds. All integration tests pass.</done>
</task>

</tasks>

<verification>
- TOTP enrollment returns valid otpauth URI, verification works
- Identity blob GET/PUT works with rate limiting
- Key rotation creates chain record, 72h cancellation enforced
- WebSocket connects with JWT, rejects invalid tokens with correct close codes
- Ping/pong keepalive prevents stale connections
- Docker image builds and runs successfully
- All cargo test pass
</verification>

<success_criteria>
- TOTP 2FA works with standard authenticator apps
- Identity blobs stored and retrievable by fingerprint
- Key rotation with 72-hour cancellation window
- WebSocket connections authenticated and maintained
- Server runs in Docker on port 1984
</success_criteria>

<output>
Create `.planning/phases/01-foundation/01-03-SUMMARY.md` with accomplishments, commits, and metrics.
</output>
