---
phase: 01-foundation
plan: 06
type: execute
wave: 3
depends_on: [01-05]
files_modified:
  - client/src/main/ipc/auth.ts
  - client/src/main/ipc/crypto.ts
  - client/src/main/ipc/connection.ts
  - client/src/renderer/src/pages/CreateIdentity.tsx
  - client/src/renderer/src/pages/RecoverIdentity.tsx
  - client/src/renderer/src/pages/JoinServer.tsx
  - client/src/renderer/src/components/MnemonicGrid.tsx
  - client/src/renderer/src/components/MnemonicVerify.tsx
  - client/src/renderer/src/components/TotpEnrollment.tsx
  - client/src/renderer/src/components/ServerSettings.tsx
  - client/src/renderer/src/hooks/useAuth.ts
  - client/src/renderer/src/hooks/useConnection.ts
  - client/src/renderer/src/hooks/useServer.ts
  - client/src/renderer/src/stores/auth.ts
autonomous: false
requirements: [SEC-01, SEC-02, SEC-10, SRVR-07]

must_haves:
  truths:
    - "User can create an Ed25519 keypair identity with passphrase and 24-word mnemonic backup"
    - "User can authenticate to server via challenge-response and receive JWT"
    - "User can recover identity from mnemonic on a new device"
    - "TOTP 2FA enrollment works with standard authenticator apps"
    - "Server admin can update server name, icon, and description from the client"
    - "App loads instantly from cache on subsequent launches"
    - "Returning user logs in with passphrase only"
  artifacts:
    - path: "client/src/renderer/src/pages/CreateIdentity.tsx"
      provides: "Identity creation wizard with passphrase and mnemonic"
      contains: "MnemonicGrid"
    - path: "client/src/renderer/src/pages/RecoverIdentity.tsx"
      provides: "Mnemonic-based identity recovery"
      contains: "mnemonicToEntropy"
    - path: "client/src/renderer/src/components/MnemonicVerify.tsx"
      provides: "3-position mnemonic verification step"
      contains: "randomPositions"
    - path: "client/src/renderer/src/components/ServerSettings.tsx"
      provides: "Admin panel for server name, icon, description, registration mode"
      contains: "updateServerSettings"
    - path: "client/src/main/ipc/crypto.ts"
      provides: "Real Ed25519 keypair and BIP39 operations"
      contains: "sodium"
  key_links:
    - from: "client/src/renderer/src/pages/CreateIdentity.tsx"
      to: "window.united.createIdentity"
      via: "IPC to crypto.ts"
      pattern: "createIdentity"
    - from: "client/src/renderer/src/pages/JoinServer.tsx"
      to: "window.united.connectToServer"
      via: "IPC to connection.ts -> REST API"
      pattern: "connectToServer"
    - from: "client/src/renderer/src/hooks/useConnection.ts"
      to: "client/src/renderer/src/components/ConnectionDot.tsx"
      via: "connection status state"
      pattern: "connectionStatus"
    - from: "client/src/renderer/src/components/ServerSettings.tsx"
      to: "window.united.updateServerSettings"
      via: "IPC to REST API"
      pattern: "updateServerSettings"
---

<objective>
Implement the full identity creation and recovery flows, challenge-response authentication against the server, TOTP 2FA enrollment, server settings admin panel, and connection management. Replace IPC stubs with real crypto operations using sodium-native. This completes the client side of Phase 1.

Purpose: Connect the UI shell to real cryptographic operations and server communication. Deliver the complete Phase 1 user experience.
Output: Working identity creation, authentication, TOTP enrollment, server settings, and recovery flows.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/IDENTITY-ARCHITECTURE.md
@.planning/phases/01-foundation/01-CONTEXT-CLIENT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identity creation and recovery with real crypto</name>
  <files>client/src/main/ipc/crypto.ts, client/src/main/ipc/auth.ts, client/src/main/ipc/connection.ts, client/src/renderer/src/pages/CreateIdentity.tsx, client/src/renderer/src/pages/RecoverIdentity.tsx, client/src/renderer/src/pages/JoinServer.tsx, client/src/renderer/src/components/MnemonicGrid.tsx, client/src/renderer/src/components/MnemonicVerify.tsx, client/src/renderer/src/stores/auth.ts</files>
  <action>
Replace stubs in main/ipc/crypto.ts with real sodium-native operations: Ed25519 keypair generation (crypto_sign_keypair), seed extraction (first 32 bytes of secret key), BIP39 mnemonic generation via @scure/bip39 entropyToMnemonic (NOT mnemonicToSeed — Pitfall 3 from research: mnemonicToSeed produces 512-bit PBKDF2 output for HD wallets, not the raw 32-byte seed UNITED needs), Argon2id key derivation (m=256MB, t=3, p=4 per IDENTITY-ARCHITECTURE.md), AES-256-GCM encryption of secret key, SHA-256 fingerprint computation, memory zeroing of sensitive data (sodium_memzero).

Replace stubs in main/ipc/auth.ts: challenge signing (crypto_sign_detached), challenge-response flow against server REST API (POST /api/auth/challenge then POST /api/auth/verify), registration flow (POST /api/auth/register with public_key, fingerprint, display_name, encrypted_blob), JWT storage using Electron safeStorage API.

Replace stubs in main/ipc/connection.ts: Real WebSocket connection to server URL, authentication via query param, protobuf message handling, connection status events pushed to renderer.

Implement CreateIdentity.tsx: Two-step flow. Step 1: passphrase entry (two fields, enter + confirm, 12-char minimum enforced, no strength meter per user decision). Step 2: MnemonicGrid (all 24 words in grid) + MnemonicVerify (select correct words at 3 random positions). After verification, identity created locally. Then: JoinServer step.

Implement RecoverIdentity.tsx: Enter 24 mnemonic words -> recover keypair locally via mnemonicToEntropy -> re-encrypt with new passphrase -> connect to server to download identity blob and restore.

Implement JoinServer.tsx: Server URL entry with inline format validation + connection test button ("Connecting..." loading state). On successful connection, display name entry for registration (or passphrase entry for returning user).

Implement MnemonicGrid.tsx: 24 words in grid layout (4x6 or 6x4), readable font, copy warning.

Implement MnemonicVerify.tsx: Show 3 random positions, user selects correct word from 4 options for each position.

Update stores/auth.ts to use real IPC calls.
  </action>
  <verify>Can create a new identity (passphrase -> mnemonic -> verify). Can recover from mnemonic. Passphrase enforcement works (rejects &lt;12 chars). Fingerprint is consistent between creation and recovery from same mnemonic.</verify>
  <done>Full identity creation and recovery flows work with real cryptographic operations. Mnemonic verification enforces backup.</done>
</task>

<task type="auto">
  <name>Task 2: TOTP enrollment, server settings, and connection UX</name>
  <files>client/src/renderer/src/components/TotpEnrollment.tsx, client/src/renderer/src/components/ServerSettings.tsx, client/src/renderer/src/hooks/useAuth.ts, client/src/renderer/src/hooks/useConnection.ts, client/src/renderer/src/hooks/useServer.ts</files>
  <action>
Implement TotpEnrollment.tsx: Optional TOTP enrollment shown once after account creation (dismissible per user decision). Display QR code via qrcode.react rendering the otpauth:// URI from server. Verify 6-digit code to confirm enrollment. Dismissible permanently.

Implement ServerSettings.tsx: Admin-only panel accessed via server name dropdown in sidebar. Editable fields: server name (text), icon upload (image -> base64), description (textarea), registration mode toggle (open/invite-only). Save calls PUT /api/server/settings.

Implement hooks/useAuth.ts: Orchestrates identity unlock -> server connection -> challenge-response auth -> JWT storage -> store updates. Handles error states per severity-based UX from user decisions.

Implement hooks/useConnection.ts: Manages WebSocket lifecycle, reconnection state, exposes connection status for ConnectionDot. Maps WebSocket close codes to severity-based UX (4001 -> silent refresh attempt, 4002 -> redirect to login with explanation, 4003 -> full-screen ban message).

Implement hooks/useServer.ts: Fetches and caches server info. Manages admin state detection (is current user admin/owner?).

Update channel sidebar: Server name dropdown with "Server Settings" option for admins. Non-admins see dropdown with fewer options.

Implement returning user flow: Passphrase only (app remembers identity and last server). "Connect to different server" link available.
  </action>
  <verify>TOTP enrollment flow works with authenticator app. Server settings panel shows for admin, hidden for non-admin. Connection dot reflects WebSocket state. Returning user can login with passphrase only. Close code handling works (4001 refreshes, 4002 redirects, 4003 shows ban screen).</verify>
  <done>All Phase 1 client flows complete: TOTP, server settings, connection management, returning user login.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full Phase 1 deliverable — Rust coordination server + Electron/React client with identity creation, challenge-response auth, TOTP 2FA, server settings, Discord-style app shell.</what-built>
  <how-to-verify>
1. Start the Rust server: cargo run in server/ — verify setup token printed to console
2. Launch the Electron app: npm run dev in client/
3. Create a new identity — verify passphrase enforces 12-char minimum
4. Verify 24-word mnemonic displayed in a grid
5. Complete mnemonic verification (3 random positions)
6. Connect to server — verify inline URL validation and loading state
7. Register with display name and setup token (becomes admin)
8. Verify triple-column layout appears (server rail, channel sidebar, main content)
9. Verify connection dot is green
10. Verify server name and icon appear correctly (initials in colored circle)
11. Click server name dropdown — verify "Server Settings" appears (admin user)
12. Open Server Settings — change server name — verify it updates
13. Close and relaunch app — verify instant cached loading (no spinner)
14. Verify passphrase-only login works for returning user
15. Verify TOTP enrollment option is available (dismissible)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Identity creation produces valid Ed25519 keypair with BIP39 mnemonic
- Challenge-response auth works against the running server
- JWT tokens are stored securely and used for authenticated requests
- Mnemonic recovery produces identical keypair
- TOTP enrollment generates valid QR code
- Server settings update via admin panel
- Connection dot accurately reflects WebSocket state
- Close code handling matches severity-based UX decisions
- Returning user flow works with passphrase only
- App loads from cache instantly on subsequent launches
</verification>

<success_criteria>
- User can create Ed25519 identity with passphrase and 24-word mnemonic backup
- User can authenticate to coordination server via challenge-response
- User can recover identity from mnemonic
- TOTP 2FA enrollment works with standard authenticator apps
- Server admin can manage server settings from client
- App loads instantly from cache
</success_criteria>

<output>
Create `.planning/phases/01-foundation/01-06-SUMMARY.md` with accomplishments, commits, and metrics.
</output>
