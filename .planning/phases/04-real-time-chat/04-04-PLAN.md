---
phase: 04-real-time-chat
plan: 04
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - server/src/chat/presence.rs
  - server/src/chat/mod.rs
  - server/src/routes.rs
  - server/src/ws/handler.rs
  - server/src/ws/actor.rs
  - client/src/renderer/src/components/MemberListSidebar.tsx
  - client/src/renderer/src/components/PresenceIndicator.tsx
  - client/src/renderer/src/components/UserProfilePopup.tsx
  - client/src/renderer/src/components/MainContent.tsx
autonomous: true
requirements: [MSG-05, MSG-06, APP-05]

must_haves:
  truths:
    - "Server broadcasts presence updates (online/away/dnd/offline) to all WS clients on connection and disconnection events"
    - "User can see who is online/offline/away in the member list sidebar"
    - "Presence dots appear on user avatars in the member list (green=online, yellow=away, red=dnd, gray=offline)"
    - "Member list sidebar shows users grouped by status (Online, Away, Offline)"
    - "User profile popup shows display name, status, and presence indicator"
    - "15-minute idle timeout auto-switches to Away (server or client side)"
    - "Typing indicators flow through server and appear in client"
  artifacts:
    - path: "server/src/chat/presence.rs"
      provides: "Server-side presence tracking and broadcast"
      contains: "broadcast_presence"
    - path: "client/src/renderer/src/components/MemberListSidebar.tsx"
      provides: "Right sidebar member list with presence dots and status grouping"
      contains: "MemberListSidebar"
    - path: "client/src/renderer/src/components/PresenceIndicator.tsx"
      provides: "Colored dot component for presence status"
      contains: "PresenceIndicator"
    - path: "client/src/renderer/src/components/UserProfilePopup.tsx"
      provides: "Profile popup with name, avatar, status"
      contains: "UserProfilePopup"
  key_links:
    - from: "server/src/ws/actor.rs"
      to: "server/src/chat/presence.rs"
      via: "On WS connect, broadcast ONLINE. On WS disconnect, broadcast OFFLINE."
      pattern: "broadcast_presence"
    - from: "client/src/renderer/src/components/MemberListSidebar.tsx"
      to: "client/src/renderer/src/stores/presence.ts"
      via: "Reads userPresence from store for status dots and grouping"
      pattern: "useStore.*userPresence"
    - from: "client/src/renderer/src/components/UserProfilePopup.tsx"
      to: "client/src/renderer/src/components/PresenceIndicator.tsx"
      via: "Shows presence dot in profile popup"
      pattern: "PresenceIndicator"
---

<objective>
Presence system and member list sidebar: server-side presence tracking with WS broadcast on connect/disconnect, client-side member list with presence dots, typing indicator forwarding, user profile popups, and idle timeout.

Purpose: Delivers the social awareness layer -- users see who is online, who is typing, and can view profiles. This transforms the chat from anonymous text exchange to a social space.

Output: Server presence module, MemberListSidebar, PresenceIndicator, UserProfilePopup components.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-real-time-chat/04-CONTEXT.md
@.planning/phases/04-real-time-chat/04-RESEARCH.md
@.planning/phases/04-real-time-chat/04-01-SUMMARY.md
@.planning/phases/04-real-time-chat/04-02-SUMMARY.md

Key existing files to reference:
@server/src/ws/actor.rs (WS connection lifecycle -- connect, message loop, disconnect)
@server/src/ws/handler.rs (WS upgrade handler)
@server/src/ws/broadcast.rs (broadcast_to_all, send_to_user patterns)
@server/src/state.rs (AppState with ConnectionRegistry)
@client/src/renderer/src/components/MemberList.tsx (existing basic member list -- may be replaced or extended)
@client/src/renderer/src/stores/presence.ts (from plan 02)
@client/src/renderer/src/hooks/usePresence.ts (from plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side presence tracking and WS broadcast</name>
  <files>
    server/src/chat/presence.rs
    server/src/chat/mod.rs
    server/src/routes.rs
    server/src/ws/handler.rs
    server/src/ws/actor.rs
  </files>
  <action>
Create `server/src/chat/presence.rs`:
- In-memory presence store: DashMap<String, PresenceStatus> keyed by user_id. Add to AppState (or use a new Arc<PresenceTracker> on AppState).
- `set_user_presence(state, user_id, status)`: Update the presence map and broadcast a PresenceUpdateEvent to all WS clients. Include user_pubkey and display_name in the event (look up from DB or cache).
- `get_all_presence(state)`: Return current presence for all tracked users. Used for initial load when a client connects.
- `broadcast_presence(registry, user_pubkey, display_name, status)`: Construct PresenceUpdateEvent Envelope and call broadcast_to_all.
- `broadcast_typing(registry, typing_indicator)`: Construct TypingEvent Envelope and call broadcast_to_all. Typing events are ephemeral -- no DB persistence.
- REST endpoint: `GET /api/presence` -- Returns current presence for all users. JWT auth required. Returns array of { user_pubkey, display_name, status }.
- REST endpoint: `POST /api/presence` -- Set own presence status. JWT auth required. Body: { status: "online"|"away"|"dnd" }. Broadcasts to all clients.
- REST endpoint: `POST /api/typing` -- Send typing indicator. JWT auth required. Body: { channel_id }. Broadcasts TypingEvent to all clients. This is the WS-alternative path for typing; in Phase 3+, typing also flows via gossipsub, but the REST/WS path ensures reliability even without P2P mesh.

Add `pub mod presence;` to `server/src/chat/mod.rs`.

Add presence routes to `server/src/routes.rs`:
```rust
let presence_routes = Router::new()
    .route("/api/presence", axum::routing::get(chat::presence::get_presence))
    .route("/api/presence", axum::routing::post(chat::presence::set_presence))
    .route("/api/typing", axum::routing::post(chat::presence::send_typing));
```

Modify `server/src/ws/actor.rs` (or handler.rs, wherever the WS lifecycle is managed):
- **On WS connection established** (after JWT auth succeeds): Call `set_user_presence(state, user_id, ONLINE)`. Also send the current presence snapshot to the newly connected client (so they see who's already online).
- **On WS connection closed** (disconnect): Call `set_user_presence(state, user_id, OFFLINE)`. BUT only if this was the user's LAST connection (check ConnectionRegistry -- user may have multiple devices). If they still have other connections, don't set OFFLINE.

Modify `server/src/state.rs`:
- Add `pub presence: Arc<DashMap<String, PresenceInfo>>` to AppState, where PresenceInfo includes status, user_pubkey, display_name.
- Initialize in main.rs as `Arc::new(DashMap::new())`.

Update all test files that construct AppState to include the new presence field (same pattern as Phase 3 -- add a default empty DashMap).
  </action>
  <verify>
`cd server && /c/Users/matts/.cargo/bin/cargo build` -- compiles with presence module and updated AppState.
`cd server && /c/Users/matts/.cargo/bin/cargo test` -- all tests pass (including existing 42+, updated with new AppState field).
  </verify>
  <done>
Server tracks user presence in memory. WS connect triggers ONLINE broadcast, WS disconnect triggers OFFLINE (only for last connection). REST endpoints for get/set presence and typing. All tests pass with updated AppState.
  </done>
</task>

<task type="auto">
  <name>Task 2: Member list sidebar, presence indicator, and user profile popup</name>
  <files>
    client/src/renderer/src/components/MemberListSidebar.tsx
    client/src/renderer/src/components/PresenceIndicator.tsx
    client/src/renderer/src/components/UserProfilePopup.tsx
    client/src/renderer/src/components/MainContent.tsx
  </files>
  <action>
Create `PresenceIndicator.tsx`:
- Small colored dot component. Props: status ('online'|'away'|'dnd'|'offline'), size ('sm'|'md' -- sm for message avatars, md for member list).
- Colors per CONTEXT.md: green (#43b581) for online, yellow (#faa61a) for away, red (#f04747) for DND, gray (#747f8d) for offline.
- Render as a div with rounded-full, appropriate size (w-2.5 h-2.5 for sm, w-3 h-3 for md).
- Member list sidebar version includes text label next to dot: "Online", "Away", "Do Not Disturb", "Offline".

Create `MemberListSidebar.tsx`:
- Right sidebar panel (w-60, bg-[var(--color-bg-secondary)], border-l border-white/5).
- Fetches member list (use existing MEMBERS_FETCH IPC from Phase 2).
- Groups members by presence status: Online first, then Away, then DND, then Offline.
- Each group has a header label: "ONLINE - 3", "AWAY - 1", "OFFLINE - 2" (uppercase, small text, muted).
- Each member row: Avatar (colored circle with initial + PresenceIndicator dot overlay at bottom-right), display name, role badge (if admin/owner).
- Clicking a member opens UserProfilePopup.
- Uses presence store to get real-time status for each member.
- Sort within groups: alphabetical by display name.

Create `UserProfilePopup.tsx`:
- Popup/popover that appears when clicking a member in the sidebar or clicking an @mention in chat.
- Content: Larger avatar (64px circle with initial), display name in bold, role badges, PresenceIndicator with text label, user_pubkey fingerprint (truncated, copyable).
- Presence: Shows the colored dot + status text (e.g., "Online", "Away").
- Per CONTEXT.md decision: Preset statuses only in Phase 4, no custom status text.
- Position: Appears to the left of the member list sidebar (or contextually near the clicked element). Use absolute/fixed positioning.
- Dismiss: Click outside or press Escape.
- Buttons: "Message" (future DM -- disabled/hidden for Phase 4), "Copy ID" (copies user pubkey).

Modify `MainContent.tsx`:
- The chat view layout should include the MemberListSidebar on the right when a channel is selected.
- Layout: `<div className="flex flex-1">` wrapping `<ChatView />` (flex-1) + `<MemberListSidebar />` (fixed width).
- MemberListSidebar should be toggleable (click a "members" icon in the channel header). Default: visible.

Integrate presence loading:
- On app startup / server connection, fetch initial presence via GET /api/presence.
- Store results in the presence Zustand slice.
- Real-time updates come through WS push events (handled by usePresence hook from plan 02).
  </action>
  <verify>
`cd client && npx tsc --noEmit` -- All new components compile without type errors.
Verify PresenceIndicator renders colored dots for each status.
Verify MemberListSidebar groups users by status.
Verify UserProfilePopup has dismiss behavior (Escape key, click outside).
  </verify>
  <done>
MemberListSidebar shows users grouped by presence status with colored dots. PresenceIndicator renders status dots in two sizes (message avatar and member list). UserProfilePopup displays name, avatar, status, and pubkey. Members sidebar integrated into MainContent layout alongside ChatView. Presence data loaded on connection and updated in real-time via WS push events.
  </done>
</task>

</tasks>

<verification>
- Presence dots show correct colors (green/yellow/red/gray)
- Member list groups users by status with correct counts
- User going offline (WS disconnect) updates member list in real-time
- User profile popup appears on member click and dismisses correctly
- Typing events flow from server to client
- Idle timeout (15min) switches to Away
- Multiple device connections don't cause false OFFLINE
</verification>

<success_criteria>
1. Server broadcasts presence on WS connect (ONLINE) and disconnect (OFFLINE)
2. Member list sidebar shows all users grouped by status
3. Presence dots are green/yellow/red/gray for online/away/dnd/offline
4. User profile popup shows name, avatar, status, pubkey
5. GET /api/presence returns current status for all users
6. POST /api/presence sets own status and broadcasts
7. POST /api/typing broadcasts typing indicator
8. All tests pass with updated AppState
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-chat/04-04-SUMMARY.md`
</output>
