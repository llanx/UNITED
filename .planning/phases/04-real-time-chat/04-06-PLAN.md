---
phase: 04-real-time-chat
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/roles/assignment.rs
  - server/src/chat/messages.rs
  - shared/types/ipc-bridge.ts
  - client/src/renderer/src/components/MemberListSidebar.tsx
  - client/src/renderer/src/components/UserProfilePopup.tsx
autonomous: true
requirements: [MSG-06]
gap_closure: true

must_haves:
  truths:
    - "Members in the member list sidebar show correct presence status (green dot for online, gray for offline)"
    - "Reactions on REST-created messages load correctly in message history"
  artifacts:
    - path: "server/src/roles/assignment.rs"
      provides: "MemberResponse with pubkey field"
      contains: "pubkey"
    - path: "shared/types/ipc-bridge.ts"
      provides: "MemberResponse TypeScript type with pubkey field"
      contains: "pubkey: string"
    - path: "client/src/renderer/src/components/MemberListSidebar.tsx"
      provides: "Presence lookup using member.pubkey instead of member.id"
      contains: "member.pubkey"
    - path: "server/src/chat/messages.rs"
      provides: "Create message returns DB row ID, not UUIDv7"
      contains: "last_insert_rowid"
  key_links:
    - from: "server/src/roles/assignment.rs"
      to: "client/src/renderer/src/components/MemberListSidebar.tsx"
      via: "MemberResponse.pubkey field flows through IPC to presence store lookup"
      pattern: "member\\.pubkey"
    - from: "server/src/chat/messages.rs (create_message)"
      to: "server/src/chat/messages.rs (get_channel_messages)"
      via: "Both return integer row ID as message id"
      pattern: "last_insert_rowid"
---

<objective>
Fix two verification gaps from Phase 4: (1) presence display broken because MemberListSidebar looks up presence using member.id (UUID) but the presence store is keyed by pubkey, and (2) message ID mismatch between create (UUIDv7) and history (integer rowid) paths causing reactions to fail for REST-created messages.

Purpose: Close verification gaps blocking MSG-06 (presence display) and fix reaction-history inconsistency.
Output: Working presence dots in member list, consistent message IDs across create and history paths.
</objective>

<execution_context>
@C:/Users/Computer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Computer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-chat/04-VERIFICATION.md
@.planning/phases/04-real-time-chat/04-04-SUMMARY.md
@.planning/phases/04-real-time-chat/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pubkey to MemberResponse and fix presence lookup</name>
  <files>
    server/src/roles/assignment.rs
    shared/types/ipc-bridge.ts
    client/src/renderer/src/components/MemberListSidebar.tsx
    client/src/renderer/src/components/UserProfilePopup.tsx
  </files>
  <action>
    Fix the presence display gap by adding the user's hex-encoded pubkey to MemberResponse.

    **Server (server/src/roles/assignment.rs):**
    1. Add `pub pubkey: String` field to `MemberResponse` struct (after `is_owner`).
    2. Update the SQL query in `list_members()` to include pubkey:
       Change `SELECT id, display_name, is_owner FROM users` to
       `SELECT id, display_name, is_owner, lower(hex(public_key)) FROM users`
    3. In the query_map closure, extract the 4th column: `row.get::<_, String>(3)?`
    4. Add `pubkey` to the MemberResponse construction in the loop.

    **Shared types (shared/types/ipc-bridge.ts):**
    1. Add `pubkey: string;` to the `MemberResponse` interface (after `is_owner`).

    **Client (client/src/renderer/src/components/MemberListSidebar.tsx):**
    1. In the `useMemo` that maps members to presence (around line 83-97), change `userPresence[member.id]` to `userPresence[member.pubkey]`.
    2. In the `UserProfilePopup` section (around line 224), change `userPresence[selectedMember.member.id]` to `userPresence[selectedMember.member.pubkey]`.
    3. Remove or update the comment on lines 83-94 that acknowledges the key mismatch — the mismatch is now fixed.
    4. For avatar color derivation, keep using `member.id` or switch to `member.pubkey` — either is fine for deterministic hue generation, but pubkey is preferred since it's the UNITED identity.

    **Client (client/src/renderer/src/components/UserProfilePopup.tsx):**
    1. If UserProfilePopup uses member.id for any pubkey-related display (fingerprint), update to use member.pubkey instead. Check the pubkey fingerprint section — it may already use a separate field or may need updating.
  </action>
  <verify>
    1. `cd server && cargo build` — compiles without errors
    2. `cd server && cargo test` — all tests pass (the test files may need updating if they construct MemberResponse)
    3. `cd client && npx tsc --noEmit` — TypeScript compiles without errors
    4. Grep for `member.id` in MemberListSidebar.tsx should NOT appear in presence lookups (only in key props and non-presence contexts)
    5. Grep for `member.pubkey` in MemberListSidebar.tsx should appear in presence lookups
  </verify>
  <done>
    MemberResponse includes pubkey field from server through to client. MemberListSidebar uses member.pubkey to look up presence — online members show green dots, offline members show gray dots. The UUID-vs-pubkey key mismatch is eliminated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix message ID consistency between create and history paths</name>
  <files>
    server/src/chat/messages.rs
  </files>
  <action>
    Fix the message ID mismatch: create_message returns UUIDv7 but history returns integer rowid, causing reactions to fail for newly-created messages.

    **In `create_message()` handler (server/src/chat/messages.rs):**
    1. After the `conn.execute("INSERT INTO messages ...")` call (around line 156-169), add:
       `let row_id = conn.last_insert_rowid();`
    2. Replace the UUIDv7 `message_id` usage with `row_id.to_string()` for both:
       - The `MessageResponse.id` field (line ~188): change `id: message_id` to `id: row_id.to_string()`
       - The `ChatMessage` proto `id` field (line ~173): change `id: message_id.clone()` to `id: row_id.to_string()`
    3. Remove the `let message_id = Uuid::now_v7().to_string();` line (line ~132) since it's no longer used.
    4. Check if the `uuid` import is used elsewhere in the file. If not, remove `use uuid::Uuid;` from the imports.

    This ensures:
    - Create response returns the actual DB row ID (integer as string)
    - WS broadcast of NewMessageEvent uses the same integer ID
    - History endpoint already returns integer IDs
    - Reaction endpoints parse integer IDs correctly
    - Deduplication in client by server_sequence is unaffected (msg.id is for reactions, server_sequence is for ordering/dedup)
  </action>
  <verify>
    1. `cd server && cargo build` — compiles without errors (no unused uuid import warnings)
    2. `cd server && cargo test` — all tests pass
    3. Grep for `Uuid::now_v7` in messages.rs — should not appear
    4. Grep for `last_insert_rowid` in messages.rs — should appear in create_message
  </verify>
  <done>
    Message IDs are consistent across create (POST response), broadcast (WS NewMessageEvent), and history (GET response). All use the integer database row ID. Reactions can be added to any message regardless of how it was created.
  </done>
</task>

</tasks>

<verification>
1. Server builds and all tests pass: `cd server && cargo test`
2. Client TypeScript compiles: `cd client && npx tsc --noEmit`
3. MemberListSidebar uses `member.pubkey` for presence lookup (grep confirms)
4. create_message uses `last_insert_rowid()` for message ID (grep confirms)
5. No `Uuid::now_v7` in messages.rs (grep confirms removal)
6. MemberResponse struct in Rust has `pubkey: String` field
7. MemberResponse interface in TypeScript has `pubkey: string` field
</verification>

<success_criteria>
- MSG-06 presence display works: member list shows correct online/offline/away status
- Message ID consistency: create, broadcast, and history all return integer row IDs
- Reactions load correctly in message history for all messages (both REST and gossip paths)
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-chat/04-06-SUMMARY.md`
</output>
