---
phase: 04-real-time-chat
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - client/src/renderer/src/components/ChatView.tsx
  - client/src/renderer/src/components/MessageGroup.tsx
  - client/src/renderer/src/components/MessageRow.tsx
  - client/src/renderer/src/components/MessageComposer.tsx
  - client/src/renderer/src/components/MarkdownContent.tsx
  - client/src/renderer/src/components/HoverToolbar.tsx
  - client/src/renderer/src/components/MainContent.tsx
  - client/src/renderer/src/components/ChannelSidebar.tsx
autonomous: true
requirements: [MSG-01, MSG-02, MSG-03, SEC-03, APP-03]

must_haves:
  truths:
    - "User can see messages in a virtualized scrollable list when they select a channel"
    - "User can type and send a message that appears in the list in real-time"
    - "User can scroll up to load older message history"
    - "Messages from the same user within 5 minutes are collapsed into groups"
    - "Markdown formatting renders correctly (bold, italic, code blocks, lists, quotes)"
    - "Code blocks have syntax highlighting with language detection"
    - "Enter sends message, Shift+Enter inserts newline"
    - "Message composer auto-expands up to 5 lines then scrolls internally"
    - "Hover toolbar appears on message hover with action buttons"
    - "Ed25519 signature verification status shown on messages"
  artifacts:
    - path: "client/src/renderer/src/components/ChatView.tsx"
      provides: "Main chat view with virtualized message list and composer"
      contains: "useVirtualizer"
    - path: "client/src/renderer/src/components/MessageGroup.tsx"
      provides: "Collapsed message group with shared header"
      contains: "MessageGroup"
    - path: "client/src/renderer/src/components/MessageComposer.tsx"
      provides: "Auto-expanding input with Enter-to-send"
      contains: "MessageComposer"
    - path: "client/src/renderer/src/components/MarkdownContent.tsx"
      provides: "react-markdown wrapper with syntax highlighting"
      contains: "rehypeHighlight"
  key_links:
    - from: "client/src/renderer/src/components/ChatView.tsx"
      to: "client/src/renderer/src/hooks/useMessages.ts"
      via: "useMessages hook provides messages array and loadOlder"
      pattern: "useMessages"
    - from: "client/src/renderer/src/components/ChatView.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer for windowed rendering"
      pattern: "useVirtualizer"
    - from: "client/src/renderer/src/components/MainContent.tsx"
      to: "client/src/renderer/src/components/ChatView.tsx"
      via: "Renders ChatView when activePanel is 'chat' and a channel is selected"
      pattern: "ChatView"
    - from: "client/src/renderer/src/components/MessageRow.tsx"
      to: "client/src/renderer/src/components/MarkdownContent.tsx"
      via: "Renders message content through markdown pipeline"
      pattern: "MarkdownContent"
---

<objective>
Core chat UI: virtualized message list with Discord-style grouped messages, markdown rendering with syntax highlighting, auto-expanding composer with Enter-to-send, hover toolbar, and edit/delete flow. Wired to the data layer from plan 02.

Purpose: This is the primary user-facing feature of Phase 4 -- the actual chat experience. Without this, all the server APIs and data layer plumbing have no visible effect.

Output: ChatView, MessageGroup, MessageRow, MessageComposer, MarkdownContent, HoverToolbar components. MainContent updated to render ChatView when a channel is selected.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-real-time-chat/04-CONTEXT.md
@.planning/phases/04-real-time-chat/04-RESEARCH.md
@.planning/phases/04-real-time-chat/04-01-SUMMARY.md
@.planning/phases/04-real-time-chat/04-02-SUMMARY.md

Key existing files to reference:
@client/src/renderer/src/components/MainContent.tsx (current welcome view, needs ChatView integration)
@client/src/renderer/src/components/ChannelSidebar.tsx (channel selection triggers activeChannelId)
@client/src/renderer/src/stores/index.ts (RootStore with new slices)
@client/src/renderer/src/hooks/useMessages.ts (from plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: MarkdownContent, MessageRow, MessageGroup, and HoverToolbar</name>
  <files>
    client/src/renderer/src/components/MarkdownContent.tsx
    client/src/renderer/src/components/MessageRow.tsx
    client/src/renderer/src/components/MessageGroup.tsx
    client/src/renderer/src/components/HoverToolbar.tsx
  </files>
  <action>
Create `MarkdownContent.tsx`:
- Memoized component (React.memo) wrapping react-markdown with remarkGfm and rehypeHighlight plugins.
- Custom component overrides:
  - `a`: Opens in external browser via `window.open(href, '_blank')`, blue-400 color, hover underline, `target="_blank"` `rel="noopener noreferrer"`. Prevent default click.
  - `code`: Detect fenced blocks via className starting with 'language-'. Fenced blocks get rounded bg-black/30, block display, p-3, text-sm. Inline code gets bg-white/10, px-1, py-0.5, text-sm monospace.
  - `pre`: Wrapper for fenced code blocks, ensure no double-padding.
  - `blockquote`: Left border (border-l-2 border-white/20), pl-3, italic text-muted.
- Do NOT enable rehype-raw (prevents XSS per research pitfall).
- Import highlight.js CSS for a dark theme: `import 'highlight.js/styles/github-dark.css'` (or atom-one-dark -- pick a dark theme that fits UNITED's dark-mode-first design).

Create `MessageRow.tsx`:
- Props: message (ChatMessage type), isGrouped (boolean -- true if this is a continuation message in a group), showHoverToolbar state.
- Layout:
  - Full message (not grouped): Avatar area (40px, colored circle with first initial, using hash-derived color from sender_pubkey), display name in bold, timestamp in muted text, then message content below.
  - Grouped message (continuation): No avatar/name/timestamp. Small left margin aligned with content. Hover shows exact time tooltip.
- Content: Render via `<MarkdownContent content={message.content} />`
- Edited indicator: If message.edited, show "(edited)" in small muted text after content.
- Deleted messages: If message.deleted, show "This message has been deleted" in italic muted text instead of content.
- Inline reply: If message.reply_to_id is set, show a compact quoted preview above the message content (smaller font, left border accent, truncated to ~100 chars of original). Clicking the preview should scroll to the original message (emit a callback for this).
- Signature verification: Show a small icon/indicator. Verified = subtle checkmark or lock icon. Unverified = warning icon. Use a simple approach: a tiny icon next to the timestamp area (per Claude's discretion from CONTEXT.md).
- Hover state: On mouse enter, show HoverToolbar positioned at top-right of message.
- Right-click context menu: On right-click, show context menu with options: Reply, Edit (if own message), Delete (if own message or admin), Copy Text, Copy Message ID.
- Mention highlight: If the message's mention_user_ids includes the current user's pubkey, apply a subtle background tint (bg-yellow-500/5 or similar) to the entire message row.

Create `MessageGroup.tsx`:
- Groups consecutive messages from the same sender within a 5-minute window.
- Props: messages (ChatMessage[]), isFirstInDay (boolean).
- If isFirstInDay, render a date separator above: centered "--- February 25, 2026 ---" style divider.
- Renders the first message as a full MessageRow (with avatar, name, timestamp).
- Renders subsequent messages as grouped MessageRows (isGrouped=true, no avatar/name).

Create `HoverToolbar.tsx`:
- Small floating toolbar (absolute positioned) appearing at top-right of a hovered message.
- Buttons (icon-based, small): React (emoji face icon), Reply (arrow icon), More (three dots).
- Click handlers: React opens emoji picker (plan 05), Reply sets reply mode in composer (callback), More opens context menu.
- Styled: bg-[var(--color-bg-secondary)] border border-white/10, rounded, shadow, flex row, gap-1, p-1.
- Icons: Use simple SVG icons or Unicode characters. Keep it minimal.
  </action>
  <verify>
`cd client && npx tsc --noEmit` -- MarkdownContent, MessageRow, MessageGroup, HoverToolbar compile without type errors.
Verify MarkdownContent renders markdown correctly by checking import paths for react-markdown, remark-gfm, rehype-highlight.
  </verify>
  <done>
MarkdownContent renders markdown with GFM and syntax highlighting. MessageRow handles full and grouped display, inline replies, edited/deleted states, mention highlights, and signature verification indicator. MessageGroup groups messages by sender+time with date separators. HoverToolbar shows action buttons on hover.
  </done>
</task>

<task type="auto">
  <name>Task 2: ChatView with virtualized list and MessageComposer</name>
  <files>
    client/src/renderer/src/components/ChatView.tsx
    client/src/renderer/src/components/MessageComposer.tsx
    client/src/renderer/src/components/MainContent.tsx
    client/src/renderer/src/components/ChannelSidebar.tsx
  </files>
  <action>
Create `ChatView.tsx`:
- Main chat view component. Takes channelId as prop (or reads from activeChannelId in store).
- Uses `useMessages(channelId)` hook from plan 02 to get messages, hasMore, loading, loadOlder.
- Uses `@tanstack/react-virtual` useVirtualizer for virtualized rendering.
- Layout structure (full height flex column):
  - Channel header bar (h-12, border-b): "#channel-name" text, channel topic if exists.
  - Virtualized message list (flex-1, overflow-y-auto): Renders MessageGroup components.
  - Typing indicator bar (h-6, fixed above composer): Shows typing users from presence store (plan 02).
  - MessageComposer at bottom.

Virtualizer setup:
- `count`: Number of message groups (not individual messages).
- `estimateSize`: ~60px per group (will vary with content).
- `measureElement`: Enable dynamic measurement for accurate heights.
- "Stick to bottom" behavior: Track whether user is scrolled to bottom. If yes, auto-scroll when new messages arrive. If user has scrolled up, don't auto-scroll.
- "Scroll to bottom" button: When user is scrolled up and new messages arrive, show a floating "New messages" button at bottom that scrolls to latest.
- History loading (infinite scroll up): When virtualizer reports items near index 0 are visible AND hasMore is true AND not currently loading, call loadOlder(). After prepend, maintain scroll position (record scrollOffset before prepend, adjust after).
- Group messages before rendering: Process the flat messages array into MessageGroup[] by grouping consecutive messages from same sender within 5 minutes. Also detect day boundaries for date separators.

Typing indicator rendering:
- Read typingUsers for current channelId from presence store.
- Render in the fixed h-6 bar above composer:
  - 0 users: empty (bar still takes space to prevent layout shift)
  - 1 user: "Alice is typing..."
  - 2 users: "Alice and Bob are typing..."
  - 3+ users: "Several people are typing..."
- Per CONTEXT.md: text-based, fixed position slim bar above composer, no layout jank.

Create `MessageComposer.tsx`:
- Auto-expanding textarea:
  - Starts as 1 line (min-height ~40px).
  - Grows as user types, up to ~5 lines (~120px).
  - Beyond 5 lines, scrolls internally (max-height with overflow-y-auto).
  - Use a ref to measure scrollHeight and adjust height dynamically.
- Key handling:
  - Enter (without Shift): Send message. Prevent default. Call chat.send via IPC. Clear input. Return focus to input.
  - Shift+Enter: Insert newline (default textarea behavior).
  - Escape: Clear reply mode if active.
- Reply mode: When reply is active (set by HoverToolbar or right-click), show a compact preview bar above the textarea showing "Replying to [username]: [truncated content]" with an X to cancel.
- Placeholder: "Message #channel-name"
- Styling: bg-[var(--color-bg-tertiary)] or similar dark input, rounded, border border-white/10, p-3, text-sm.
- On successful send: Clear input, scroll to bottom of message list.

Modify `MainContent.tsx`:
- When `activePanel === 'chat'` (default) AND `activeChannelId` is set, render `<ChatView />` instead of the welcome screen.
- When `activePanel === 'chat'` AND no activeChannelId, show the existing welcome screen.
- Import ChatView component.

Verify integration with `ChannelSidebar.tsx`:
- Clicking a channel in the sidebar calls `setActiveChannel(id)` which updates `activeChannelId` in the store.
- ChatView reads `activeChannelId` and loads messages for that channel.
- Ensure channel switching clears the old channel's view and loads the new one.
  </action>
  <verify>
`cd client && npx tsc --noEmit` -- ChatView, MessageComposer, updated MainContent compile without type errors.
Verify useVirtualizer import from @tanstack/react-virtual.
Verify the message grouping logic handles edge cases: empty messages array, single message, messages spanning multiple days.
  </verify>
  <done>
ChatView renders a virtualized message list with grouped messages, stick-to-bottom auto-scroll, infinite scroll-up for history, typing indicator bar, and reply mode. MessageComposer auto-expands with Enter-to-send and Shift+Enter for newline. MainContent renders ChatView when a channel is selected. Channel switching loads new messages.
  </done>
</task>

</tasks>

<verification>
- Chat view renders when a channel is selected
- Messages display with markdown formatting and syntax highlighting
- Virtualized list handles 500+ messages without performance degradation
- Message grouping follows 5-minute/same-sender rule
- Date separators appear between different days
- Enter sends, Shift+Enter adds newline
- Composer auto-expands up to 5 lines
- Hover toolbar appears on message hover
- Inline reply preview shows above composer when replying
- Edit/delete show correct UI states
- Signature verification indicator visible on messages
</verification>

<success_criteria>
1. User can see messages in virtualized list after selecting a channel
2. User can type and send a message (Enter to send)
3. Messages render with markdown, code highlighting, and date separators
4. Same-user messages within 5min collapse into groups
5. Scrolling up loads older message history
6. New messages auto-scroll when at bottom, show "New messages" button when scrolled up
7. Hover toolbar shows React/Reply/More actions
8. Typing indicator bar shows above composer
9. MainContent routes to ChatView when channel is active
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-chat/04-03-SUMMARY.md`
</output>
