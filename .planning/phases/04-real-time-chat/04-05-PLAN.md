---
phase: 04-real-time-chat
plan: 05
type: execute
wave: 3
depends_on: [04-03, 04-04]
files_modified:
  - client/src/renderer/src/components/EmojiPicker.tsx
  - client/src/renderer/src/components/ReactionPills.tsx
  - client/src/renderer/src/components/MentionAutocomplete.tsx
  - client/src/renderer/src/components/UnreadBadge.tsx
  - client/src/renderer/src/components/MessageComposer.tsx
  - client/src/renderer/src/components/MessageRow.tsx
  - client/src/renderer/src/components/ChannelSidebar.tsx
  - client/src/renderer/src/components/ServerRail.tsx
  - client/src/renderer/src/components/ChatView.tsx
autonomous: true
requirements: [MSG-04, MSG-07, MSG-08, MSG-09, APP-05]

must_haves:
  truths:
    - "User can react to messages with emoji via the emoji picker"
    - "Reactions display as compact pills below messages with emoji + count"
    - "User can click a pill to toggle their reaction on/off"
    - "Hover on reaction pill shows list of who reacted"
    - "User can @mention users and roles with autocomplete dropdown"
    - "@mentions render as highlighted pills in messages"
    - "Messages mentioning the current user have a distinct background tint"
    - "Channels with unread messages show bold name in sidebar"
    - "Channels with @mentions show red badge with mention count"
    - "Server icon shows aggregated mention badge"
    - "Right-click channel or server icon offers 'Mark as read'"
    - "Desktop notifications fire for @mentions when window is not focused"
    - "Clicking a notification navigates to the relevant channel"
  artifacts:
    - path: "client/src/renderer/src/components/EmojiPicker.tsx"
      provides: "Emoji picker popover wrapping emoji-picker-react"
      contains: "EmojiPicker"
    - path: "client/src/renderer/src/components/ReactionPills.tsx"
      provides: "Compact reaction pills below messages"
      contains: "ReactionPills"
    - path: "client/src/renderer/src/components/MentionAutocomplete.tsx"
      provides: "@mention dropdown with user and role filtering"
      contains: "MentionAutocomplete"
    - path: "client/src/renderer/src/components/UnreadBadge.tsx"
      provides: "Unread indicator (bold name + red badge)"
      contains: "UnreadBadge"
  key_links:
    - from: "client/src/renderer/src/components/EmojiPicker.tsx"
      to: "client/src/main/ipc/chat.ts"
      via: "Selecting emoji calls reactions.add IPC"
      pattern: "window.united.reactions.add"
    - from: "client/src/renderer/src/components/MentionAutocomplete.tsx"
      to: "client/src/renderer/src/stores/roles.ts"
      via: "Filters members and roles from existing stores for autocomplete"
      pattern: "useStore.*members"
    - from: "client/src/renderer/src/components/UnreadBadge.tsx"
      to: "client/src/renderer/src/stores/notifications.ts"
      via: "Reads channelMentionCounts for badge numbers"
      pattern: "channelMentionCounts"
    - from: "client/src/renderer/src/components/ChannelSidebar.tsx"
      to: "client/src/renderer/src/components/UnreadBadge.tsx"
      via: "Each channel row includes UnreadBadge"
      pattern: "UnreadBadge"
---

<objective>
Rich chat features: emoji reactions with picker, @mention autocomplete with highlighted rendering, unread badges on channels and server icon, desktop notifications for mentions, and "Mark as read" actions.

Purpose: This plan completes the Phase 4 feature set, delivering the interactive richness that makes a chat app feel complete -- reactions for lightweight feedback, @mentions for directed communication, and unread/notification systems for multi-channel awareness.

Output: EmojiPicker, ReactionPills, MentionAutocomplete, UnreadBadge components. Updated MessageComposer with @mention support. Updated ChannelSidebar and ServerRail with unread indicators. Desktop notification pipeline active.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-real-time-chat/04-CONTEXT.md
@.planning/phases/04-real-time-chat/04-RESEARCH.md
@.planning/phases/04-real-time-chat/04-01-SUMMARY.md
@.planning/phases/04-real-time-chat/04-02-SUMMARY.md
@.planning/phases/04-real-time-chat/04-03-SUMMARY.md
@.planning/phases/04-real-time-chat/04-04-SUMMARY.md

Key existing files to reference:
@client/src/renderer/src/components/MessageComposer.tsx (from plan 03 -- add @mention support)
@client/src/renderer/src/components/MessageRow.tsx (from plan 03 -- add ReactionPills)
@client/src/renderer/src/components/HoverToolbar.tsx (from plan 03 -- wire React button to EmojiPicker)
@client/src/renderer/src/components/ChannelSidebar.tsx (add unread badges)
@client/src/renderer/src/components/ServerRail.tsx (add aggregated mention badge)
@client/src/renderer/src/stores/messages.ts (unread count, mention count)
@client/src/renderer/src/stores/notifications.ts (notification prefs, mention counts)
@client/src/main/ipc/notifications.ts (desktop notification from main process)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Emoji reactions (picker, pills, toggle)</name>
  <files>
    client/src/renderer/src/components/EmojiPicker.tsx
    client/src/renderer/src/components/ReactionPills.tsx
    client/src/renderer/src/components/MessageRow.tsx
    client/src/renderer/src/components/HoverToolbar.tsx
  </files>
  <action>
Create `EmojiPicker.tsx`:
- Wraps `emoji-picker-react` library in a popover/portal component.
- Props: onSelect(emoji: string), onClose(), position (x, y coordinates or anchor element).
- Configuration: Theme.DARK (matches UNITED dark-mode-first design), native Unicode emoji (no CDN images), categories visible, recently-used section at top, search bar enabled.
- Position: Absolute/fixed positioned near the trigger element. Use a portal (createPortal to document.body) to avoid overflow clipping.
- Dismiss: Click outside or Escape key.
- Lazy loaded: Import emoji-picker-react dynamically (`React.lazy`) since the package is ~2.5MB. Show a small loading state while it loads.
- On emoji select: Call onSelect with the Unicode emoji character, then close picker.

Create `ReactionPills.tsx`:
- Props: reactions (array of { emoji, count, users: string[] }), messageId, currentUserPubkey.
- Render compact pills in a flex-wrap row below message content.
- Each pill: `<button>` with emoji character + count (e.g., "thumbs_up 3"). Rounded-full, bg-white/5, hover:bg-white/10, text-xs, px-2, py-0.5, border border-white/10.
- If current user has reacted with this emoji, highlight the pill (bg-blue-500/20, border-blue-400/30).
- Click pill: Toggle reaction. If user already reacted, call `window.united.reactions.remove(messageId, emoji)`. If not, call `window.united.reactions.add(messageId, emoji)`.
- Hover pill: Show tooltip with list of display names who reacted (max 10, then "and N more").
- "+" button at end of pills row: Opens EmojiPicker to add a new reaction.

Update `MessageRow.tsx`:
- Add ReactionPills below message content. Pass reactions from the message data (reactions come with message history from plan 01, and update via WS push events from plan 02).
- ReactionPills render only if message has reactions or on hover (the "+" button).

Update `HoverToolbar.tsx`:
- Wire the "React" button: On click, open EmojiPicker positioned near the button. On emoji select, call `window.united.reactions.add(messageId, emoji)`.
  </action>
  <verify>
`cd client && npx tsc --noEmit` -- EmojiPicker, ReactionPills, updated MessageRow, updated HoverToolbar compile.
Verify emoji-picker-react is imported with React.lazy for code splitting.
Verify ReactionPills toggle logic: click when reacted = remove, click when not reacted = add.
  </verify>
  <done>
Emoji picker opens from hover toolbar and reaction "+" button. Reactions render as compact pills with emoji + count. Clicking a pill toggles the reaction. Hovering shows who reacted. Current user's reactions are highlighted. Picker is lazy-loaded for bundle efficiency.
  </done>
</task>

<task type="auto">
  <name>Task 2: @mentions, unread badges, and desktop notifications</name>
  <files>
    client/src/renderer/src/components/MentionAutocomplete.tsx
    client/src/renderer/src/components/UnreadBadge.tsx
    client/src/renderer/src/components/MessageComposer.tsx
    client/src/renderer/src/components/ChannelSidebar.tsx
    client/src/renderer/src/components/ServerRail.tsx
    client/src/renderer/src/components/ChatView.tsx
    client/src/renderer/src/components/MessageRow.tsx
  </files>
  <action>
**@Mention Autocomplete:**

Create `MentionAutocomplete.tsx`:
- Positioned dropdown that appears when user types '@' in the composer.
- Props: query (text after '@'), onSelect(type: 'user'|'role', id: string, displayName: string), onClose(), position (caret coordinates).
- Data source: Members from the existing member list store (fetched in Phase 2). Roles from the existing roles store. Filter in-memory by substring match on display name or role name. Pre-sort by alphabetical.
- Display: Each item shows avatar + display name for users, role color dot + role name for roles.
- Keyboard navigation per CONTEXT.md: Arrow keys to navigate, Enter/Tab to select, Escape to dismiss.
- Limit dropdown to 10 results for performance.
- Debounce filter by 100ms to avoid lag.

Update `MessageComposer.tsx`:
- Detect '@' keystroke: When user types '@', capture the position and start filtering.
- Track the mention query (text after '@' until space or selection).
- Show MentionAutocomplete dropdown positioned at the caret location.
- On select: Replace '@query' with a mention token in the text: `@[display_name](user:pubkey)` or `@[role_name](role:id)`. This format is parsed during rendering and extracted by the server for notification routing.
- Close autocomplete on: Escape, clicking outside, backspace past '@', typing space without selecting.

**@Mention Rendering in Messages:**

Update `MessageRow.tsx` (or MarkdownContent.tsx):
- Parse mention tokens `@[name](user:id)` and `@[name](role:id)` in message content BEFORE passing to react-markdown.
- Replace them with styled spans: highlighted pill/chip with bg-blue-500/20, rounded, px-1, font-medium. The name is the visible text.
- Messages that contain a mention of the current user's pubkey: Apply bg-yellow-500/5 (or similar warm tint) to the entire message row per CONTEXT.md decision.
- Clicking a mention: Open UserProfilePopup for user mentions. For role mentions, no action (or show role info tooltip).

**Unread Badges:**

Create `UnreadBadge.tsx`:
- Props: unreadCount (number), mentionCount (number).
- Render: If mentionCount > 0, show red badge (bg-red-500, text-white, rounded-full, min-w-5, text-xs, font-bold) with the count. If unreadCount > 0 but no mentions, just bold the channel name (handled by parent).
- Used inline in channel list items.

Update `ChannelSidebar.tsx`:
- For each channel in the sidebar, compute unread state:
  - Read lastReadSequence for the channel from messages store (or dedicated last_read store).
  - Compare to the latest server_sequence from the messages store.
  - If latest > lastRead, channel is unread: bold the channel name.
  - Count mentions: from the notifications store mentionCount for this channel.
  - Render UnreadBadge with mentionCount next to channel name.
- Right-click context menu on channel: Add "Mark as Read" option. On click, calls `markChannelRead(channelId)` which updates lastReadSequence to the latest server_sequence and calls `window.united.lastRead.update(channelId, seq)`.
- Right-click context menu also available on existing options (rename, delete for admins).

Update `ServerRail.tsx`:
- Aggregate mention counts across all channels for each server.
- If any channel has mentions, show a small red badge on the server icon.
- Right-click context menu on server icon: Add "Mark All as Read" which iterates all channels and marks them read.

**Desktop Notifications:**

Update `ChatView.tsx` or the message event handler:
- When a new message arrives (via PUSH_CHAT_EVENT) that mentions the current user:
  - Check notification preferences for the channel (muted? notify-all vs mentions-only?).
  - If notification should fire, call `window.united.notifications.show({ title, body, channelId })` (IPC to main process).
  - Per CONTEXT.md: Default trigger is @mentions and role mentions only. Per-channel opt-in for all messages.
- Coalescing: Main process handles coalescing (from plan 02 notifications.ts). Renderer just sends the request.
- Don't notify for the active channel if the window is focused (check via document.hasFocus() and activeChannelId).

Update `ChatView.tsx`:
- When ChatView mounts for a channel, mark the channel as read (update lastReadSequence).
- When new messages arrive while viewing the channel AND user is at the bottom, mark as read.
- When user scrolls to bottom, mark as read.

**Per CONTEXT.md locked decisions:**
- Full preview content in notifications: server name, channel name, sender name, first ~100 chars.
- Per-user setting for minimal notifications (sender + "mentioned you in #channel") -- store this preference.
- Clicking notification opens the relevant channel: main process sends navigate IPC to renderer.
  </action>
  <verify>
`cd client && npx tsc --noEmit` -- All new and updated components compile.
Verify MentionAutocomplete handles keyboard navigation (arrow keys, enter, escape).
Verify UnreadBadge renders red badge for mentions.
Verify ChannelSidebar shows bold names for unread channels.
Verify notification flow: message with mention -> check prefs -> send to main -> Electron Notification.
  </verify>
  <done>
@mention autocomplete appears on '@' keystroke with filtered user/role list. Mentions render as highlighted pills. User's own mentions get background tint. Unread channels show bold name + red mention badge. Server icon shows aggregated badge. Right-click "Mark as Read" on channels and server icon. Desktop notifications fire for @mentions when window unfocused. Clicking notification navigates to channel.
  </done>
</task>

</tasks>

<verification>
- Emoji picker opens, shows categories and search, selects emoji
- Reaction pills appear below messages with correct count
- Clicking a pill toggles the user's reaction
- '@' triggers autocomplete with filtered user/role list
- Arrow keys navigate autocomplete, Enter selects, Escape dismisses
- Mentions render as highlighted chips in messages
- Messages mentioning current user have background tint
- Unread channels have bold names in sidebar
- Mention channels have red badge with count
- Server icon aggregates mention badges
- Right-click "Mark as Read" clears unread state
- Desktop notification fires for @mentions
- Clicking notification navigates to correct channel
</verification>

<success_criteria>
1. Emoji reactions: picker works, pills render, toggle on click, hover shows who reacted
2. @mention autocomplete: triggers on '@', filters, keyboard nav, inserts mention token
3. @mention rendering: highlighted pills, own-mention row tint, clickable
4. Unread indicators: bold name for unread, red badge for mentions, server aggregation
5. Mark as read: right-click channel, right-click server icon, auto-mark on view
6. Desktop notifications: fire for @mentions, coalesced, click navigates, respect prefs
7. All 12 Phase 4 requirement IDs covered across plans 01-05
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-chat/04-05-SUMMARY.md`
</output>
