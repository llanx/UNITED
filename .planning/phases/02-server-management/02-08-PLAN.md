---
phase: 02-server-management
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/roles/assignment.rs
  - server/src/routes.rs
  - shared/types/ipc-bridge.ts
  - client/src/main/ipc/channels.ts
  - client/src/main/ipc/roles-api.ts
  - client/src/preload/index.ts
  - client/src/renderer/src/stores/roles.ts
  - client/src/renderer/src/components/RoleManagement.tsx
  - client/src/renderer/src/components/MemberList.tsx
autonomous: true
gap_closure: true
requirements: [SRVR-04]

must_haves:
  truths:
    - "Admin can see a list of server members in the role management panel"
    - "Admin can toggle role assignment for any member by clicking a role badge"
    - "assignRole and removeRole store actions are called from the UI when toggling"
    - "Member list reflects current role assignments fetched from the server"
  artifacts:
    - path: "server/src/roles/assignment.rs"
      provides: "GET /api/members endpoint returning user list with role IDs"
      contains: "list_members"
    - path: "client/src/renderer/src/components/RoleManagement.tsx"
      provides: "Member assignment section with per-member role toggles"
      min_lines: 380
    - path: "client/src/renderer/src/components/MemberList.tsx"
      provides: "Reusable member list component (no longer placeholder)"
      min_lines: 30
    - path: "client/src/renderer/src/stores/roles.ts"
      provides: "members state, fetchMembers action"
      contains: "fetchMembers"
  key_links:
    - from: "client/src/renderer/src/components/RoleManagement.tsx"
      to: "stores/roles.ts"
      via: "useStore((s) => s.assignRole) and useStore((s) => s.removeRole)"
      pattern: "assignRole|removeRole"
    - from: "stores/roles.ts"
      to: "window.united.members.fetch()"
      via: "IPC bridge"
      pattern: "window\\.united\\.members\\.fetch"
    - from: "client/src/main/ipc/roles-api.ts"
      to: "GET /api/members"
      via: "fetch API call"
      pattern: "/api/members"
---

<objective>
Close the SRVR-04 gap: add member listing with per-member role toggle UI.

Purpose: The 02-06 verification found that assignRole/removeRole store actions and IPC handlers exist but no UI component calls them. MemberList.tsx is a placeholder. This plan adds the full vertical slice: server endpoint to list members, client IPC/store to fetch them, and UI to display members with role toggle buttons.

Output: Server members endpoint, client members IPC bridge, members state in Zustand store, and a member assignment section in RoleManagement.tsx with per-member role toggle badges.
</objective>

<execution_context>
@C:/Users/Computer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Computer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-06-SUMMARY.md
@.planning/phases/02-server-management/02-06-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server members endpoint + client IPC/store wiring</name>
  <files>
    server/src/roles/assignment.rs
    server/src/routes.rs
    shared/types/ipc-bridge.ts
    client/src/main/ipc/channels.ts
    client/src/main/ipc/roles-api.ts
    client/src/preload/index.ts
    client/src/renderer/src/stores/roles.ts
  </files>
  <action>
    **Server: Add GET /api/members endpoint**

    In `server/src/roles/assignment.rs`, add a `list_members` handler:
    - Query: `SELECT u.id, u.display_name, u.is_owner FROM users u ORDER BY u.is_owner DESC, u.display_name ASC`
    - For each user, also query their assigned roles: `SELECT role_id FROM user_roles WHERE user_id = ?1`
    - Return JSON array: `[{ "id": "...", "display_name": "...", "is_owner": bool, "role_ids": ["..."] }]`
    - Requires JWT auth (Claims extractor) but no special permission — any authenticated user can see the member list
    - Follow the existing pattern in assignment.rs: `State(state)`, `claims: Claims`, `spawn_blocking` for DB access
    - Define `MemberResponse` struct with `id: String`, `display_name: String`, `is_owner: bool`, `role_ids: Vec<String>`
    - Implement `serde::Serialize` on MemberResponse

    In `server/src/routes.rs`:
    - Add route: `.route("/api/members", axum::routing::get(role_assignment::list_members))` inside the existing `role_routes` Router (which already requires auth via Claims extractor)

    **Client IPC bridge types**

    In `shared/types/ipc-bridge.ts`:
    - Add `MemberResponse` interface: `{ id: string; display_name: string; is_owner: boolean; role_ids: string[] }`
    - Add `members` section to `UnitedAPI` interface: `members: { fetch(): Promise<MemberResponse[]> }`

    **Client IPC constants**

    In `client/src/main/ipc/channels.ts`:
    - Add `MEMBERS_FETCH: 'members:fetch'` to the IPC constants object

    **Client IPC handler**

    In `client/src/main/ipc/roles-api.ts`:
    - Import `MemberResponse` from `@shared/ipc-bridge`
    - Add handler: `ipcMain.handle(IPC.MEMBERS_FETCH, async (): Promise<MemberResponse[]> => { ... })` using the same `getServerUrl()`/`getAccessToken()` pattern, calling `GET /api/members`
    - Add this inside the existing `registerRoleHandlers` function

    **Client preload**

    In `client/src/preload/index.ts`:
    - Add `members: { fetch: () => ipcRenderer.invoke(IPC.MEMBERS_FETCH) }` section

    **Client store**

    In `client/src/renderer/src/stores/roles.ts`:
    - Import `MemberResponse` from `@shared/ipc-bridge`
    - Add to `RolesSlice` interface: `members: MemberResponse[]`, `membersLoading: boolean`, `fetchMembers: () => Promise<void>`
    - Implement `fetchMembers` in the slice creator: calls `window.united.members.fetch()`, sets `members` state
    - Update `assignRole` to call `fetchMembers()` after successful assignment (so UI refreshes)
    - Update `removeRole` to call `fetchMembers()` after successful removal (so UI refreshes)
    - Initialize `members: []` and `membersLoading: false` in default state
  </action>
  <verify>
    - `cargo check` passes in server directory (new endpoint compiles)
    - `npx electron-vite build` passes in client directory (IPC types resolve)
    - Grep for `list_members` in server/src/roles/assignment.rs confirms endpoint exists
    - Grep for `MEMBERS_FETCH` in client/src/main/ipc/channels.ts confirms IPC constant
    - Grep for `fetchMembers` in client/src/renderer/src/stores/roles.ts confirms store action
  </verify>
  <done>
    Server exposes GET /api/members returning user list with role_ids. Client can fetch members via window.united.members.fetch(). Store has members state and fetchMembers action. assignRole/removeRole re-fetch members after mutation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Member role assignment UI in RoleManagement</name>
  <files>
    client/src/renderer/src/components/RoleManagement.tsx
    client/src/renderer/src/components/MemberList.tsx
  </files>
  <action>
    **RoleManagement.tsx: Add member assignment section**

    After the existing "Roles" list section, add a new "Member Roles" section:

    1. Import `MemberResponse` from `@shared/ipc-bridge`
    2. Pull from store: `const members = useStore((s) => s.members)`, `const fetchMembers = useStore((s) => s.fetchMembers)`, `const assignRole = useStore((s) => s.assignRole)`, `const removeRole = useStore((s) => s.removeRole)`, `const getUserRoles = ... (if needed, or use members[].role_ids directly)`
    3. Call `fetchMembers()` in a `useEffect` on mount (similar to how useRoles fetches roles)
    4. Render a "Member Roles" section heading, then for each member:
       - Show display name (bold if is_owner, with "(Owner)" tag)
       - Show a row of role badges — one for each non-default role
       - Each badge is clickable: if the member has the role, clicking removes it (calls `removeRole(member.id, role.id)`). If the member doesn't have it, clicking assigns it (calls `assignRole(member.id, role.id)`).
       - Role badges use the role's color as background when assigned, muted/outlined when not assigned
       - Owner members are shown but their roles are not editable (owner has all permissions implicitly per CONTEXT.md)
       - Default @everyone role is not shown as a toggleable badge (it's auto-assigned to all)
    5. Add loading and error states for the member assignment section
    6. Style using existing Tailwind patterns from the file (border-white/10, bg-white/5, text-sm, etc.)

    **MemberList.tsx: Replace placeholder with real component**

    Replace the entire placeholder content with a proper member list:
    1. Accept props: `members: MemberResponse[]`, `roles: RoleResponse[]`
    2. Render each member with their display name and colored role badges
    3. No editing controls here (editing is in RoleManagement) — this is the read-only member list shown from the "Members" panel in the server dropdown
    4. Show member count in heading
    5. Group or annotate the owner
    6. Remove the placeholder comment and "will be available" text
  </action>
  <verify>
    - `npx electron-vite build` passes in client directory
    - Grep for `assignRole` in RoleManagement.tsx confirms it is called from UI
    - Grep for `removeRole` in RoleManagement.tsx confirms it is called from UI
    - Grep for `fetchMembers` in RoleManagement.tsx confirms members are fetched on mount
    - Grep for `placeholder` (the code comment, not HTML attribute) in MemberList.tsx returns no results
  </verify>
  <done>
    RoleManagement.tsx has a "Member Roles" section listing all server members with per-member role toggle badges. Clicking a badge calls assignRole or removeRole. MemberList.tsx is a real component showing member names with role badges (read-only). SRVR-04 is fully satisfied from the client UI.
  </done>
</task>

</tasks>

<verification>
1. `cargo check` passes — server compiles with new members endpoint
2. `npx electron-vite build` passes — client compiles with new IPC bridge and UI
3. Grep confirms `assignRole` and `removeRole` are called from RoleManagement.tsx (not just imported)
4. Grep confirms MemberList.tsx no longer contains placeholder comment
5. GET /api/members returns the expected JSON shape (testable with curl against running server)
</verification>

<success_criteria>
- Server has GET /api/members returning [{id, display_name, is_owner, role_ids}]
- Client can fetch members through IPC bridge (window.united.members.fetch())
- RoleManagement.tsx shows a member list with per-member role toggle badges
- Clicking a role badge on a member calls assignRole or removeRole
- MemberList.tsx is a real component, not a placeholder
- electron-vite build passes all 3 targets
- SRVR-04 ("Server admin can assign roles to users") is fully achievable from the UI
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-08-SUMMARY.md`
</output>
