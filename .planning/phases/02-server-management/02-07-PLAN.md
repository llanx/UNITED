---
phase: 02-server-management
plan: 07
type: execute
wave: 3
depends_on: ["02-04", "02-06"]
files_modified:
  - client/src/renderer/src/pages/JoinServer.tsx
  - client/src/renderer/src/components/WelcomeOverlay.tsx
  - client/src/renderer/src/components/ServerSettings.tsx
  - client/src/renderer/src/stores/ui.ts
  - client/src/renderer/src/stores/server.ts
  - client/src/main/protocol.ts
  - client/src/main/index.ts
autonomous: true
requirements:
  - SRVR-09

must_haves:
  truths:
    - "New user can join a server via invite code in the client and land directly in #general"
    - "Admin can toggle a welcome overlay on/off in Server Settings"
    - "When welcome overlay is enabled, new joiners see it with server name, description, and a Jump In button"
    - "After dismissing the welcome overlay (or if disabled), user lands in #general with channel sidebar visible"
    - "Invite deep links via united:// protocol open the app and start the join flow"
  artifacts:
    - path: "client/src/renderer/src/pages/JoinServer.tsx"
      provides: "Invite-code-aware join flow that routes to #general after completion"
      contains: "inviteCode"
    - path: "client/src/renderer/src/components/WelcomeOverlay.tsx"
      provides: "Optional welcome overlay shown to new joiners"
      contains: "WelcomeOverlay"
    - path: "client/src/main/protocol.ts"
      provides: "united:// custom protocol handler for invite deep links"
      contains: "registerProtocol"
  key_links:
    - from: "client/src/renderer/src/pages/JoinServer.tsx"
      to: "client/src/renderer/src/stores/channels.ts"
      via: "After join, fetch channels and set activeChannelId to #general"
      pattern: "fetchChannels.*activeChannelId"
    - from: "client/src/renderer/src/components/WelcomeOverlay.tsx"
      to: "client/src/renderer/src/stores/ui.ts"
      via: "Dismiss overlay sets showWelcomeOverlay to false"
      pattern: "showWelcomeOverlay"
    - from: "client/src/main/protocol.ts"
      to: "client/src/main/index.ts"
      via: "Protocol handler registered on app ready"
      pattern: "setAsDefaultProtocolClient"
---

<objective>
Implement the invite-based join flow in the client, post-join routing to #general, the optional welcome overlay for new joiners, and the `united://` custom protocol handler for invite deep links.

Purpose: This plan fulfills the locked context decision "Onboarding: straight to #general by default" and SRVR-09 (join via invite link). Without this, users who join via invite have no client-side path, and the onboarding experience is incomplete.

Output: Updated join flow with invite code support, welcome overlay component, admin toggle for welcome overlay, `united://` protocol registration, and post-join routing.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT-CLIENT.md
@.planning/phases/02-server-management/02-04-SUMMARY.md
@.planning/phases/02-server-management/02-06-SUMMARY.md
@client/src/renderer/src/pages/JoinServer.tsx
@client/src/renderer/src/components/ServerSettings.tsx
@client/src/renderer/src/stores/ui.ts
@client/src/renderer/src/stores/server.ts
@client/src/renderer/src/stores/channels.ts
@client/src/main/index.ts
@client/src/preload/index.ts
@shared/types/ipc-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invite join flow, post-join routing to #general, and united:// protocol handler</name>
  <files>
    client/src/renderer/src/pages/JoinServer.tsx
    client/src/renderer/src/stores/ui.ts
    client/src/renderer/src/stores/server.ts
    client/src/main/protocol.ts
    client/src/main/index.ts
  </files>
  <action>
  1. Update `client/src/renderer/src/pages/JoinServer.tsx`:
     - Add an `inviteCode` field to the join flow. The invite code can come from:
       a. Manual entry: add an "Invite Code" input field in the registration step (when server is invite-only or user has a code)
       b. URL parameter: parse invite code from `united://invite/{code}` deep link
       c. Query parameter: parse from `?invite={code}` in the URL
     - When an invite code is present, call `window.united.joinViaInvite({ inviteCode, fingerprint, publicKey, displayName, genesisSignature, encryptedBlob })` instead of the regular register endpoint.
     - This maps to the server's `POST /api/invite/join` endpoint.
     - On successful join:
       a. Fetch the channel list: `await window.united.channels.list()`
       b. Find the #general channel (first text channel in the first category, or specifically named "general")
       c. Set `activeChannelId` to #general's ID in the store
       d. Navigate to `/app` (the main application view)
       e. If server has welcome overlay enabled, set `showWelcomeOverlay: true` in the UI store
     - Per locked decision: "Onboarding: straight to #general by default — no welcome screen unless admin explicitly enables it."

  2. Add `joinViaInvite` to the IPC bridge in `shared/types/ipc-bridge.ts` and implement in `client/src/preload/index.ts`:
     ```typescript
     joinViaInvite: (req: {
       inviteCode: string
       fingerprint: string
       publicKey: string
       displayName: string
       genesisSignature: string
       encryptedBlob: string
     }) => Promise<{ accessToken: string; refreshToken: string; isOwner: boolean }>
     ```

  3. Update `client/src/renderer/src/stores/ui.ts`:
     - Add `showWelcomeOverlay: boolean` to UISlice (default false)
     - Add `dismissWelcomeOverlay: () => void` action that sets it to false

  4. Update `client/src/renderer/src/stores/server.ts`:
     - Add `welcomeOverlayEnabled: boolean` to ServerSlice (from server settings)
     - Add `welcomeMessage: string | null` (optional server welcome text/rules)

  5. Create `client/src/main/protocol.ts`:
     - Register `united://` as a custom protocol handler using Electron's `app.setAsDefaultProtocolClient('united')`
     - Per research Open Question 4: "Register the united:// custom protocol handler in the Electron main process as part of Phase 2 client work."
     - Handle `united://invite/{code}` links:
       - On macOS: listen for `open-url` event on app
       - On Windows/Linux: parse the protocol URL from `process.argv` (second instance) or handle via `second-instance` event
       - Extract the invite code from the URL
       - Send invite code to renderer via IPC push event
       - Renderer stores the invite code and navigates to the join flow with it pre-filled
     - Implementation:
       ```typescript
       export function registerProtocolHandler(mainWindow: BrowserWindow) {
         app.setAsDefaultProtocolClient('united')

         // macOS
         app.on('open-url', (event, url) => {
           event.preventDefault()
           handleProtocolUrl(url, mainWindow)
         })

         // Windows/Linux: handle second-instance
         app.on('second-instance', (event, argv) => {
           const url = argv.find(arg => arg.startsWith('united://'))
           if (url) handleProtocolUrl(url, mainWindow)
           mainWindow.focus()
         })
       }

       function handleProtocolUrl(url: string, window: BrowserWindow) {
         const parsed = new URL(url)
         if (parsed.pathname.startsWith('/invite/') || parsed.pathname.startsWith('invite/')) {
           const code = parsed.pathname.replace(/^\/?(invite\/)/, '')
           window.webContents.send('invite-code', code)
         }
       }
       ```

  6. Update `client/src/main/index.ts`:
     - Call `registerProtocolHandler(mainWindow)` after window creation
     - Ensure `requestSingleInstanceLock()` is used for the second-instance handling

  Commit: `feat(02-07): invite join flow, post-join routing to #general, and united:// protocol`
  </action>
  <verify>
  - `npx tsc --noEmit` passes in client directory
  - Invite code field appears in JoinServer page when invite code is available
  - After successful join via invite, app navigates to /app with #general selected
  - `united://invite/abc123` protocol URL is parseable by the handler
  </verify>
  <done>
  JoinServer page updated with invite code support. Post-join flow fetches channels and routes to #general. united:// protocol handler registered in Electron main process. Invite deep links parsed and forwarded to renderer. UI store tracks welcome overlay state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Welcome overlay component and admin toggle</name>
  <files>
    client/src/renderer/src/components/WelcomeOverlay.tsx
    client/src/renderer/src/components/ServerSettings.tsx
    client/src/renderer/src/pages/Main.tsx
  </files>
  <action>
  1. Create `client/src/renderer/src/components/WelcomeOverlay.tsx`:
     - Full-screen overlay (absolute positioned over the main content area, not blocking the sidebar)
     - Per locked decision: "Admin can configure a welcome overlay (server name + description + optional rules) in server settings. If enabled, new joiners see the overlay with a 'Jump in' button."
     - Content:
       - Server name (large, centered)
       - Server description (below name)
       - Optional rules/guidelines text (if configured by admin)
       - "Jump In" button at the bottom — calls `dismissWelcomeOverlay()` on the UI store
     - Dark theme, semi-transparent backdrop
     - Shown ONLY when `showWelcomeOverlay === true` in the UI store
     - After clicking "Jump In", the overlay disappears and user sees #general with the full channel sidebar
     - Styling: centered card on a dark overlay backdrop, consistent with existing modal patterns

  2. Update `client/src/renderer/src/components/ServerSettings.tsx`:
     - In the "General" tab (or a new "Onboarding" section within General), add:
       - Toggle switch: "Show welcome overlay for new members" (on/off)
       - When enabled, show a text area: "Welcome message / rules" (optional, shown in the overlay)
     - Save these settings via the existing server settings update IPC call
     - The server needs a `welcome_overlay_enabled` and `welcome_message` field in server_settings table (the executor should add these to the server settings if not already present, or store client-side if the server API doesn't support it yet — use Claude's discretion on the simplest working approach)

  3. Update `client/src/renderer/src/pages/Main.tsx`:
     - Import and render WelcomeOverlay when `showWelcomeOverlay === true`
     - The overlay renders ON TOP of the main content area (not replacing it — the channel sidebar and server rail remain visible beneath/beside it)
     - After dismissal, the main content area shows normally (#general selected)

  Commit: `feat(02-07): welcome overlay for new joiners and admin toggle in settings`
  </action>
  <verify>
  - Client builds: `npm run build` passes
  - WelcomeOverlay renders when showWelcomeOverlay is true
  - Clicking "Jump In" dismisses the overlay and reveals #general
  - Admin toggle in Server Settings controls welcome overlay
  - Non-admin users do not see the toggle
  - Overlay does not block the channel sidebar
  </verify>
  <done>
  Welcome overlay shows server name, description, and optional rules with "Jump In" dismiss button. Admin can toggle overlay on/off in Server Settings. New joiners see overlay (if enabled) then land in #general after dismissal. Overlay is correctly layered over main content without blocking sidebar navigation.
  </done>
</task>

</tasks>

<verification>
- Client builds without errors
- Invite code join flow works end-to-end: enter code → register → land in #general
- Welcome overlay shows (when enabled) and dismisses correctly
- Admin can toggle welcome overlay in Server Settings
- united:// protocol handler parses invite links
- Post-join routing always selects #general as the active channel
- Non-admin users do not see welcome overlay toggle
</verification>

<success_criteria>
- New user joins via invite code and lands directly in #general
- Welcome overlay shown to new joiners when admin enables it
- "Jump In" button dismisses overlay and reveals #general with full channel sidebar
- Admin toggle for welcome overlay in Server Settings General tab
- united:// custom protocol registered for invite deep links
- Invite code pre-filled when arriving via deep link
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-07-SUMMARY.md`
</output>
