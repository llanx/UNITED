---
phase: 02-server-management
plan: 07
type: execute
wave: 3
depends_on: ["02-04"]
files_modified:
  - client/src/renderer/src/pages/JoinServer.tsx
  - client/src/renderer/src/components/WelcomeOverlay.tsx
  - client/src/renderer/src/components/InviteJoin.tsx
  - client/src/renderer/src/components/ModerationNotice.tsx
  - client/src/main/ipc/invite.ts
  - client/src/main/index.ts
  - shared/types/ipc-bridge.ts
  - client/src/preload/index.ts
  - client/src/renderer/src/App.tsx
  - client/src/renderer/src/stores/server.ts
  - client/src/renderer/src/hooks/useConnection.ts
autonomous: true
requirements:
  - SRVR-05
  - SRVR-06
  - SRVR-08
  - SRVR-09

must_haves:
  truths:
    - "User can join a server by entering an invite code or clicking an invite link"
    - "Invite join flow validates code, registers user, and navigates to #general"
    - "Admin can configure a welcome overlay (server name + description + optional rules)"
    - "New joiners see welcome overlay if admin enabled it, with 'Jump in' button"
    - "Kicked user sees reconnection prompt (can rejoin with valid invite)"
    - "Banned user sees full-screen ban notice with reason and close code 4003"
    - "Custom protocol handler (united://) enables invite deep links from browser"
  artifacts:
    - path: "client/src/renderer/src/components/InviteJoin.tsx"
      provides: "Invite code entry and validation UI"
      contains: "InviteJoin"
    - path: "client/src/renderer/src/components/WelcomeOverlay.tsx"
      provides: "Admin-configurable welcome overlay for new joiners"
      contains: "WelcomeOverlay"
    - path: "client/src/renderer/src/components/ModerationNotice.tsx"
      provides: "Kick/ban notice UI with appropriate severity"
      contains: "ModerationNotice"
    - path: "client/src/main/ipc/invite.ts"
      provides: "IPC handlers for invite join flow"
      contains: "joinViaInvite"
  key_links:
    - from: "client/src/renderer/src/components/InviteJoin.tsx"
      to: "client/src/main/ipc/invite.ts"
      via: "IPC bridge: window.united.invite.joinViaInvite()"
      pattern: "joinViaInvite"
    - from: "client/src/main/index.ts"
      to: "client/src/renderer/src/App.tsx"
      via: "Custom protocol handler sends deep link to renderer"
      pattern: "united://invite"
    - from: "client/src/renderer/src/hooks/useConnection.ts"
      to: "client/src/renderer/src/components/ModerationNotice.tsx"
      via: "WS close code 4003/4004 triggers moderation notice"
      pattern: "4003|4004"
---

<objective>
Build the client invite join flow, welcome overlay, moderation notices, and custom protocol handler for invite deep links.

Purpose: New users need a smooth onboarding path: enter an invite code (or click a link), join the server, and land on #general. Admins can optionally show a welcome overlay. Kicked/banned users need clear, sovereignty-aligned notices explaining what happened.

Output: Invite join UI, welcome overlay component, kick/ban notice components, united:// deep link handler, IPC bridge for invites.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-04-SUMMARY.md
@.planning/phases/01-foundation/01-06-SUMMARY.md
@client/src/renderer/src/pages/JoinServer.tsx
@client/src/renderer/src/App.tsx
@client/src/main/index.ts
@client/src/renderer/src/hooks/useConnection.ts
@shared/types/ipc-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invite IPC, deep link handler, and join flow</name>
  <files>
    client/src/main/ipc/invite.ts
    client/src/main/index.ts
    shared/types/ipc-bridge.ts
    client/src/preload/index.ts
    client/src/renderer/src/pages/JoinServer.tsx
    client/src/renderer/src/components/InviteJoin.tsx
    client/src/renderer/src/App.tsx
    client/src/renderer/src/stores/server.ts
  </files>
  <action>
1. Create `client/src/main/ipc/invite.ts`:
   - `joinViaInvite(serverUrl: string, inviteCode: string)`:
     a. Validate invite code format (8 chars alphanumeric)
     b. Call server registration endpoint with invite_code parameter (reuse existing auth flow: generate keypair if needed, challenge-response, register with invite code)
     c. On success, fetch channel list and role list
     d. Return server info, channel list, and assigned roles
   - `validateInvite(serverUrl: string, inviteCode: string)`:
     a. GET /invite/{code} on the server to check if invite is valid (check HTTP status)
     b. Parse server name from response if available
     c. Return { valid: boolean, serverName?: string }

2. Register IPC handlers in `client/src/main/index.ts`:
   - `united:invite:join` → calls joinViaInvite()
   - `united:invite:validate` → calls validateInvite()

3. Register `united://` custom protocol handler in `client/src/main/index.ts`, following Pattern 11 from research:
   - Before app.whenReady(): `protocol.registerSchemesAsPrivileged([{ scheme: 'united', privileges: { standard: true, secure: true } }])`
   - After app.whenReady(): `app.setAsDefaultProtocolClient('united')`
   - Handle `second-instance` event (Windows/Linux): parse argv for `united://` URLs
   - Handle `open-url` event (macOS): parse URL
   - For `united://invite/{code}`: extract server URL and invite code, send to renderer via IPC to navigate to join flow with code pre-filled
   - Use `app.requestSingleInstanceLock()` to ensure deep links go to existing instance

4. Update `shared/types/ipc-bridge.ts`:
   ```typescript
   invite: {
     joinViaInvite: (serverUrl: string, inviteCode: string) => Promise<JoinResult>
     validateInvite: (serverUrl: string, inviteCode: string) => Promise<{ valid: boolean, serverName?: string }>
   }
   ```

5. Update `client/src/preload/index.ts` to expose invite IPC methods.

6. Create `client/src/renderer/src/components/InviteJoin.tsx`:
   - Input for invite link or code (parse both full URL `https://server:1984/invite/abc123` and bare code `abc123`)
   - Server URL input (if not embedded in invite link)
   - "Validate" step: calls validateInvite, shows server name if valid, error if invalid
   - "Join" button: calls joinViaInvite, shows loading state
   - Success: redirects to main app (router navigation to #general channel)
   - Error handling: clear messages for expired invites, exhausted invites, ban status

7. Update `client/src/renderer/src/pages/JoinServer.tsx`:
   - Integrate InviteJoin component
   - Support pre-filled invite code (from deep link)
   - Both "first server join" (during onboarding) and "add another server" flows

8. Update `client/src/renderer/src/App.tsx`:
   - Listen for deep link events from main process
   - Navigate to JoinServer page with pre-filled invite code when deep link received

9. Update `client/src/renderer/src/stores/server.ts`:
   - Add `setActiveChannel(channelId)` action
   - On join success, auto-select the first text channel in the first category (#general from starter template)
  </action>
  <verify>
Client builds: `cd /c/Users/matts/UNITED/client && npx electron-vite build`. Verify InviteJoin renders with input field and join button. Custom protocol registration code is present in main process. Deep link handling code parses `united://invite/code` correctly.
  </verify>
  <done>IPC invite module handles join and validate flows. Custom protocol handler registered for united:// deep links. InviteJoin component renders with input, validation, and join flow. JoinServer page supports pre-filled invite codes. Auto-navigates to #general on join success.</done>
</task>

<task type="auto">
  <name>Task 2: Welcome overlay, moderation notices, and connection UX</name>
  <files>
    client/src/renderer/src/components/WelcomeOverlay.tsx
    client/src/renderer/src/components/ModerationNotice.tsx
    client/src/renderer/src/hooks/useConnection.ts
    client/src/renderer/src/pages/Main.tsx
    client/src/renderer/src/stores/server.ts
  </files>
  <action>
1. Create `client/src/renderer/src/components/WelcomeOverlay.tsx`:
   - Semi-transparent overlay shown on first visit to a server (when admin has enabled it)
   - Displays: server name (large), server description, optional rules text
   - "Jump in" button dismisses overlay and navigates to #general
   - Stores dismissal state locally (so it doesn't show on every reconnect)
   - Dark themed, centered card layout, matching UNITED's design language
   - Per CONTEXT.md: "no welcome screen unless admin explicitly enables it"
   - Triggered when: server info has welcome_enabled=true AND user hasn't dismissed for this server

2. Update server settings to support welcome overlay configuration:
   - The welcome overlay config (enabled, description/rules text) should be stored in server_settings. If the server-side settings API from Phase 1 already supports arbitrary key-value pairs, use keys like `welcome_enabled` (boolean) and `welcome_text` (string).
   - If server-side changes are needed, add them via the existing settings PUT endpoint (no new endpoint needed — just new keys).
   - Admin configures welcome overlay in the existing ServerSettings component (from Phase 1) — add a "Welcome Overlay" section with enable toggle and text area.

3. Create `client/src/renderer/src/components/ModerationNotice.tsx`:
   - **Kick notice (WS close code 4004):** "You have been kicked from [server name]". Subtitle: "You can rejoin with a valid invite link." Action buttons: "Rejoin" (if has invite), "Close". Uses the warning severity level — yellow/amber accent. Not full-screen blocking.
   - **Ban notice (WS close code 4003):** "You have been banned from [server name]". Shows ban reason if provided (from close frame reason field). No rejoin option. "Close" button only. Uses error severity level — red accent. Full-screen blocking overlay per Phase 1 context decisions (4003 = full-screen ban message).
   - Both notices follow the severity-based error UX from Phase 1 decisions.

4. Update `client/src/renderer/src/hooks/useConnection.ts`:
   - Enhance existing WS close code handling:
     - 4001: silent refresh (already implemented in Phase 1)
     - 4002: redirect with explanation (already implemented)
     - 4003: show ModerationNotice (ban) — extract reason from close frame, display full-screen ban notice. PREVENT automatic reconnection for 4003.
     - 4004: show ModerationNotice (kick) — display kick notice. Allow manual rejoin but do NOT auto-reconnect immediately.
   - Parse close frame reason for 4003/4004 and pass to ModerationNotice component.

5. Update `client/src/renderer/src/pages/Main.tsx`:
   - Show WelcomeOverlay on first server visit when admin has enabled it
   - Render ModerationNotice when connection closes with 4003/4004
   - Ensure moderation notices overlay on top of main content

6. Update `client/src/renderer/src/stores/server.ts`:
   - Add `welcomeDismissed: Record<string, boolean>` (serverId → dismissed flag)
   - Add `dismissWelcome(serverId)` action
   - Add `moderationNotice: { type: 'kick' | 'ban', reason?: string } | null`
   - Add `setModerationNotice()` and `clearModerationNotice()` actions

Follow existing component patterns: dark theme, Tailwind CSS, consistent with Phase 1 UI. Per CONTEXT.md: onboarding goes straight to #general by default, welcome overlay only if admin enables it.
  </action>
  <verify>
Client builds: `cd /c/Users/matts/UNITED/client && npx electron-vite build`. Visual inspection: WelcomeOverlay renders with server info and "Jump in" button. ModerationNotice renders appropriately for kick (warning) and ban (error/full-screen). Connection hook handles 4003/4004 close codes.
  </verify>
  <done>Welcome overlay renders when admin enables it, dismissable per server. Kick notice shows warning with rejoin option. Ban notice shows full-screen error with reason. WS close codes 4003/4004 trigger appropriate notices. Auto-reconnect prevented for bans.</done>
</task>

</tasks>

<verification>
- Client builds without errors
- InviteJoin component handles full URL and bare code formats
- Custom protocol handler parses united://invite/{code} deep links
- Join flow: validate invite → register with code → fetch channels → navigate to #general
- Welcome overlay appears only when admin-enabled and not previously dismissed
- Kick notice (4004) shows warning with rejoin option
- Ban notice (4003) shows full-screen error with reason, no auto-reconnect
- Server settings panel includes welcome overlay configuration
</verification>

<success_criteria>
New users can join via invite code or deep link, land on #general, and optionally see a welcome overlay. Kicked users see a warning notice and can rejoin. Banned users see a full-screen notice with reason. Custom protocol handler enables invite link deep linking from browsers.
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-07-SUMMARY.md`
</output>
