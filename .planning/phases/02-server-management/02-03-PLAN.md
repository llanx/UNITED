---
phase: 02-server-management
plan: 03
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - server/src/roles/crud.rs
  - server/src/roles/assignment.rs
  - server/src/roles/mod.rs
  - server/src/routes.rs
  - server/src/identity/registration.rs
  - server/src/ws/protocol.rs
  - server/tests/roles_test.rs
autonomous: true
requirements:
  - SRVR-03
  - SRVR-04

must_haves:
  truths:
    - "Server admin can create roles with specific permissions"
    - "Server admin can update role name, permissions, and color"
    - "Server admin can delete non-default roles"
    - "Server admin can assign and remove roles to/from users"
    - "Every new user is auto-assigned the @everyone role on join"
    - "Permission checks use union resolution (bitwise OR of all role permissions)"
    - "All role mutations broadcast WS events to connected clients"
  artifacts:
    - path: "server/src/roles/crud.rs"
      provides: "Role CRUD REST handlers"
      contains: "create_role"
    - path: "server/src/roles/assignment.rs"
      provides: "Role assignment and removal handlers"
      contains: "assign_role"
    - path: "server/tests/roles_test.rs"
      provides: "Integration tests for role CRUD and assignment"
      contains: "test"
  key_links:
    - from: "server/src/roles/crud.rs"
      to: "server/src/roles/permissions.rs"
      via: "require_permission(ADMIN) guard on role management"
      pattern: "require_permission.*ADMIN"
    - from: "server/src/roles/assignment.rs"
      to: "server/src/ws/broadcast.rs"
      via: "broadcast RoleAssignedEvent after assignment"
      pattern: "broadcast_to_all"
    - from: "server/src/identity/registration.rs"
      to: "server/src/roles/assignment.rs"
      via: "@everyone auto-assignment on user join"
      pattern: "everyone"
---

<objective>
Implement role CRUD operations, role assignment/removal, @everyone auto-assignment on join, and integration tests.

Purpose: Roles are the foundation of the permission system. Admins need to create roles with specific permissions and assign them to users. The @everyone default role ensures all users have baseline permissions. This enables plans 02-04 (moderation, invites) to enforce kick/ban permissions via the role system.

Output: REST endpoints for role CRUD and assignment, @everyone auto-assignment in registration flow, WS broadcast events, and integration tests.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-01-SUMMARY.md
@server/src/roles/permissions.rs
@server/src/identity/registration.rs
@server/src/routes.rs
@shared/proto/roles.proto
@server/src/ws/broadcast.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing integration tests for roles</name>
  <files>
    server/tests/roles_test.rs
  </files>
  <action>
Write integration tests using the existing `start_test_server()` pattern. Register as owner first, then exercise role endpoints.

Tests to write (all should FAIL at this point):

1. `test_everyone_role_created_on_seed` — Register as owner, GET /api/roles, assert @everyone role exists with is_default=true and SEND_MESSAGES permission (0x01).

2. `test_create_role` — POST /api/roles with {name: "Moderator", permissions: 0x0C (KICK_MEMBERS | BAN_MEMBERS), color: "#ff0000"}, assert 201 with role object.

3. `test_update_role_permissions` — Create a role, PUT /api/roles/{id} with {permissions: 0x1F (all)}, assert 200 with updated permissions.

4. `test_delete_role` — Create a role, DELETE /api/roles/{id}, assert 200. GET /api/roles and verify it's gone.

5. `test_cannot_delete_everyone_role` — Try DELETE /api/roles/{everyone_id}, assert 400 error.

6. `test_assign_role_to_user` — Create a role, register a second user (requires open registration or invite), POST /api/roles/assign with {user_id, role_id}, assert 200.

7. `test_remove_role_from_user` — Assign a role, POST /api/roles/remove with {user_id, role_id}, assert 200.

8. `test_permission_union_resolution` — Create two roles (role_a with SEND_MESSAGES, role_b with KICK_MEMBERS), assign both to a user, verify user can access endpoints requiring either permission. This tests bitwise OR resolution.

9. `test_role_crud_requires_admin_permission` — Register as non-owner user, attempt POST /api/roles, assert 403 FORBIDDEN.

10. `test_new_user_gets_everyone_role` — Register a second user, GET /api/roles/user/{user_id}/roles (or query user roles), verify @everyone is auto-assigned.
  </action>
  <verify>
Run `cd /c/Users/matts/UNITED/server && /c/Users/matts/.cargo/bin/cargo test --test roles_test -- --nocapture 2>&1 | head -50` — tests should compile but FAIL (RED phase).
  </verify>
  <done>10 integration tests compile and fail with expected errors. Tests cover role CRUD, assignment, @everyone, permission resolution, and access control.</done>
</task>

<task type="auto">
  <name>Task 2: Implement role CRUD, assignment, and @everyone auto-assign</name>
  <files>
    server/src/roles/crud.rs
    server/src/roles/assignment.rs
    server/src/roles/mod.rs
    server/src/routes.rs
    server/src/identity/registration.rs
    server/src/ws/protocol.rs
  </files>
  <action>
1. Update `server/src/roles/mod.rs` to add `pub mod crud; pub mod assignment;`.

2. Create `server/src/roles/crud.rs` with axum REST handlers:
   - `GET /api/roles` — authenticated. Returns all roles ordered by position. Include is_default flag so client knows which is @everyone.
   - `POST /api/roles` — require_permission(ADMIN). Create role with name, permissions (u32), optional color, position (next_position after max). Broadcast RoleCreatedEvent. Return 201.
   - `PUT /api/roles/{id}` — require_permission(ADMIN). Update name, permissions, and/or color. Cannot change is_default flag. Broadcast RoleUpdatedEvent. Return 200.
   - `DELETE /api/roles/{id}` — require_permission(ADMIN). Reject deletion of default role (is_default=1, return 400 "Cannot delete the default role"). Delete all user_roles entries for this role first, then delete the role. Broadcast RoleDeletedEvent. Return 200.

   All admin endpoints require ADMIN permission (not just MANAGE_CHANNELS). Owner always passes per require_permission() logic.

3. Create `server/src/roles/assignment.rs` with:
   - `POST /api/roles/assign` — require_permission(ADMIN). Accept {user_id, role_id}. Insert into user_roles (ignore if already exists). Broadcast RoleAssignedEvent. Return 200.
   - `POST /api/roles/remove` — require_permission(ADMIN). Accept {user_id, role_id}. Cannot remove the @everyone role from users (check is_default, return 400 "Cannot remove the default role"). Delete from user_roles. Broadcast RoleRemovedEvent. Return 200.
   - `GET /api/roles/user/{user_id}` — authenticated. Return all roles assigned to a user (including @everyone via UNION with default roles).

4. Modify `server/src/identity/registration.rs`:
   - After a new user is created (non-owner), auto-assign the @everyone role: query for the default role (is_default=1), insert into user_roles. This ensures every user has baseline permissions immediately.
   - NOTE: For owner registration, seed_starter_template (from 02-02) creates the @everyone role AND the owner implicitly has all permissions via is_owner flag, so explicit role assignment is not needed for the owner. But the owner should also be assigned @everyone for consistency.

5. Wire role routes into `server/src/routes.rs`:
   - Add role CRUD routes (GET, POST, PUT, DELETE /api/roles/...) to the role_routes group.
   - Add assignment routes (POST /api/roles/assign, POST /api/roles/remove, GET /api/roles/user/{user_id}).
   - All behind JWT auth (Claims extractor).

6. Update `server/src/ws/protocol.rs` to recognize new role-related Envelope payload variants.
  </action>
  <verify>
Run `cd /c/Users/matts/UNITED/server && /c/Users/matts/.cargo/bin/cargo test --test roles_test -- --nocapture` — all 10 tests should PASS. Also run `cargo test` for full suite to ensure no regressions.
  </verify>
  <done>All role CRUD endpoints work. @everyone role is auto-assigned on user join. Permission union resolution works via bitwise OR. Admin permission required for role management. All 10 tests pass. No regressions.</done>
</task>

</tasks>

<verification>
- `cargo test` passes all tests (Phase 1 + channel tests from 02-02 + new role tests)
- GET /api/roles returns @everyone role after owner registration
- POST/PUT/DELETE roles return correct status codes
- Role assignment and removal work with WS broadcast
- @everyone is auto-assigned to new users on registration
- Permission checks require ADMIN for role management
- Non-default role deletion cascades user_roles entries
</verification>

<success_criteria>
Server admin can create, update, and delete roles with specific permissions. Roles can be assigned to and removed from users. @everyone is auto-assigned on join. Permission union resolution correctly computes effective permissions. 10+ integration tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-03-SUMMARY.md`
</output>
