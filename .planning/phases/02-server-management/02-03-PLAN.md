---
phase: 02-server-management
plan: 03
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - server/src/roles/mod.rs
  - server/src/roles/crud.rs
  - server/src/roles/assignment.rs
  - server/src/ws/protocol.rs
  - server/tests/roles_test.rs
  - server/src/identity/registration.rs
autonomous: true
requirements:
  - SRVR-03
  - SRVR-04

must_haves:
  truths:
    - "Admin can create a role with specific permission flags via REST API"
    - "Admin can update role name, permissions, and color via REST API"
    - "Admin can delete a non-default role via REST API"
    - "Admin can assign and remove roles to/from users via REST API"
    - "New users are auto-assigned the @everyone default role on registration"
    - "Permission computation uses bitwise OR of all user roles with ADMIN-implies-all"
    - "Role mutations broadcast delta events to connected WebSocket clients"
  artifacts:
    - path: "server/src/roles/crud.rs"
      provides: "Role CRUD REST endpoint handlers"
      contains: "create_role"
    - path: "server/src/roles/assignment.rs"
      provides: "Role assignment and removal handlers"
      contains: "assign_role"
    - path: "server/tests/roles_test.rs"
      provides: "Integration tests for role CRUD and assignment"
      contains: "async fn test_create_role"
  key_links:
    - from: "server/src/roles/assignment.rs"
      to: "server/src/db/models.rs"
      via: "Insert/delete user_roles junction table"
      pattern: "INSERT INTO user_roles"
    - from: "server/src/roles/crud.rs"
      to: "server/src/roles/permissions.rs"
      via: "Validate permission bits on role creation/update"
      pattern: "Permissions::from_bits"
    - from: "server/src/identity/registration.rs"
      to: "server/src/roles/assignment.rs"
      via: "Auto-assign @everyone role on user registration"
      pattern: "assign_default_role"
---

<objective>
Implement role CRUD, role assignment, and automatic @everyone role assignment on user registration, with WebSocket push events for all mutations.

Purpose: Roles and permissions gate all admin actions. Without roles, there is no way to distinguish who can manage channels, kick users, or perform admin tasks. The @everyone default role provides baseline permissions to all members.

Output: Working role CRUD and assignment endpoints, auto-assignment on registration, WebSocket events, and integration tests.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-01-SUMMARY.md
@server/src/roles/mod.rs
@server/src/roles/permissions.rs
@server/src/db/migrations.rs
@server/src/db/models.rs
@server/src/state.rs
@server/src/ws/mod.rs
@server/src/identity/registration.rs
@server/src/auth/middleware.rs
@server/tests/auth_test.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration tests for role CRUD and assignment (RED phase)</name>
  <files>
    server/tests/roles_test.rs
  </files>
  <action>
  Write integration tests FIRST (TDD RED phase) following the existing test pattern.

  Tests to write:

  1. `test_create_role` -- Owner creates POST /api/roles with { name: "Moderator", permissions: 0x0C (KICK_MEMBERS | BAN_MEMBERS), color: "#00ff00" }. Expect 201 with role JSON.

  2. `test_update_role` -- Create a role, then PUT /api/roles/{id} with updated name and permissions. Expect 200.

  3. `test_delete_role` -- Create a role, DELETE /api/roles/{id}. Expect 200. Cannot delete the default @everyone role (expect 400).

  4. `test_list_roles` -- GET /api/roles (authenticated). Expect role list including @everyone default role (created by starter template).

  5. `test_assign_role` -- Create a role and a second user. POST /api/roles/assign with { user_id, role_id }. Expect 200.

  6. `test_remove_role` -- Assign a role, then POST /api/roles/remove with { user_id, role_id }. Expect 200. Cannot remove @everyone role (expect 400).

  7. `test_permission_check` -- Create "Moderator" role with KICK_MEMBERS. Assign to user. Verify user can perform a kick-related action (or check a permissions endpoint). Unassign role, verify permission revoked.

  8. `test_invalid_permissions` -- Try to create a role with permissions value that has invalid bits set (e.g., 0xFFFF). Expect 400.

  9. `test_non_admin_cannot_manage_roles` -- Register as non-owner without ADMIN permission. Try POST /api/roles. Expect 403.

  10. `test_everyone_role_auto_assigned` -- Register a new (non-owner) user. GET /api/roles/user/{user_id} or check user's roles. The @everyone role should be automatically assigned.

  Commit: `test(02-03): add failing role CRUD and assignment integration tests`
  </action>
  <verify>
  `cargo test --test roles_test` -- tests compile but FAIL (RED state) because endpoints don't exist.
  </verify>
  <done>
  10 integration tests written and committed. Tests compile but fail because role endpoints are not yet implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Role CRUD, assignment, and auto-assign implementation (GREEN phase)</name>
  <files>
    server/src/roles/mod.rs
    server/src/roles/crud.rs
    server/src/roles/assignment.rs
    server/src/ws/protocol.rs
    server/src/identity/registration.rs
  </files>
  <action>
  Implement all role CRUD and assignment to make the RED tests pass.

  1. Create `server/src/roles/crud.rs` with these handlers:
     - `GET /api/roles` -- List all roles ordered by position. Authenticated.
     - `POST /api/roles` -- Create role. Requires ADMIN permission. Validates: name non-empty, permissions value is valid (only known bits set -- use `Permissions::from_bits(value).is_some()` check). Position = max + 1000. Returns 201.
     - `PUT /api/roles/{id}` -- Update role. Requires ADMIN. Cannot change is_default. Returns 200.
     - `DELETE /api/roles/{id}` -- Delete role. Requires ADMIN. Cannot delete default role (is_default = 1 -> return 400 "Cannot delete the default role"). Also removes all user_roles entries for this role. Returns 200.

     Use the `require_permission` helper from Plan 02-02 (or implement a shared version in a common module if 02-02 hasn't been executed yet -- make it available from roles/permissions.rs or a shared auth helper). Permission check needs: db pool, user_id, is_owner, required Permissions flag.

  2. Create `server/src/roles/assignment.rs` with these handlers:
     - `POST /api/roles/assign` -- Assign role to user. Requires ADMIN. Insert into user_roles. Returns 200.
     - `POST /api/roles/remove` -- Remove role from user. Requires ADMIN. Cannot remove default @everyone role (return 400). Delete from user_roles. Returns 200.
     - `GET /api/roles/user/{user_id}` -- Get roles for a specific user. Authenticated. Returns list of roles.
     - `assign_default_role(conn: &Connection, user_id: &str)` -- Helper function that assigns the @everyone role (WHERE is_default = 1) to a user. Used during registration.

  3. Update `server/src/identity/registration.rs`:
     - After successful user registration (both owner and non-owner paths), call `assign_default_role(conn, user_id)` to auto-assign the @everyone role.
     - This ensures ALL users get @everyone automatically on join.

  4. Broadcast WebSocket delta events on role mutations:
     - RoleCreated, RoleUpdated, RoleDeleted on role CRUD
     - RoleAssigned, RoleRemoved on assignment changes
     - Update `server/src/ws/protocol.rs` if needed for new envelope handling

  5. Update `server/src/roles/mod.rs` to expose `pub mod crud; pub mod assignment;` and update the `routes()` function to wire all endpoints.

  NOTE: Per Pitfall 7 in research -- JWT claims contain is_admin from Phase 1. Do NOT rely on JWT claims alone for permission checks. Always compute permissions from the database (user_roles + roles tables). The JWT proves identity; the DB provides current permissions.

  Commit: `feat(02-03): implement role CRUD, assignment, and auto-assign @everyone`
  </action>
  <verify>
  - `cargo test --test roles_test` -- ALL 10 tests pass (GREEN state)
  - `cargo test` -- ALL existing tests still pass (Phase 1 + channels if already built)
  - Register new user, confirm @everyone role auto-assigned
  </verify>
  <done>
  All 10 role integration tests pass. Roles can be created, updated, deleted, assigned, and removed. @everyone auto-assigned on registration. Permission validation rejects invalid bit values. Default role protected from deletion. WebSocket events broadcast on mutations.
  </done>
</task>

</tasks>

<verification>
- `cargo test --test roles_test` -- All 10 tests pass
- `cargo test` -- All tests pass (roles + channels + Phase 1)
- @everyone role auto-assigned on registration
- Permission computation uses bitwise OR across all user roles
- ADMIN permission implies all other permissions
- Non-admin users get 403 on role management endpoints
</verification>

<success_criteria>
- Role CRUD: create, update, delete roles with permission flags via REST
- Assignment: assign/remove roles to/from users via REST
- Auto-assign: @everyone default role assigned on registration
- Validation: invalid permission bits rejected, default role protected
- Permission computation: correct bitwise OR union resolution
- WebSocket push: delta events for all role mutations
- TDD: Tests written first, all passing
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-03-SUMMARY.md`
</output>
