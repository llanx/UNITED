---
phase: 02-server-management
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - server/src/channels/mod.rs
  - server/src/channels/crud.rs
  - server/src/channels/ordering.rs
  - server/src/channels/seed.rs
  - server/src/routes.rs
  - server/src/main.rs
  - server/src/ws/protocol.rs
  - server/tests/channels_test.rs
autonomous: true
requirements:
  - SRVR-01
  - SRVR-02

must_haves:
  truths:
    - "Server admin can create a text or voice channel in a specific category"
    - "Server admin can rename and delete channels"
    - "Server admin can create, rename, and delete categories"
    - "Channels and categories have position integers and can be reordered"
    - "Server starts with starter template (General category with #general + #introductions, Voice category with General voice channel)"
    - "All channel/category mutations broadcast WS events to connected clients"
    - "GET /api/channels returns full channel list with categories"
  artifacts:
    - path: "server/src/channels/crud.rs"
      provides: "Channel and category CRUD REST handlers"
      contains: "create_channel"
    - path: "server/src/channels/ordering.rs"
      provides: "Position gap strategy and renormalization"
      contains: "position_between"
    - path: "server/src/channels/seed.rs"
      provides: "Starter template seeding"
      contains: "seed_starter_template"
    - path: "server/tests/channels_test.rs"
      provides: "Integration tests for channel CRUD"
      contains: "test"
  key_links:
    - from: "server/src/channels/crud.rs"
      to: "server/src/roles/permissions.rs"
      via: "require_permission(MANAGE_CHANNELS) guard on admin endpoints"
      pattern: "require_permission.*MANAGE_CHANNELS"
    - from: "server/src/channels/crud.rs"
      to: "server/src/ws/broadcast.rs"
      via: "broadcast_to_all after mutations"
      pattern: "broadcast_to_all"
    - from: "server/src/channels/seed.rs"
      to: "server/src/identity/registration.rs"
      via: "Called after owner registration"
      pattern: "seed_starter_template"
---

<objective>
Implement channel and category CRUD operations with the starter template, position-based ordering, and real-time WS event broadcasting.

Purpose: Channels and categories are the core structural building blocks of a server. Users need to see an organized channel list on join, and admins need to create/rename/delete/reorder them. The starter template ensures every server starts with a usable structure.

Output: REST endpoints for all channel/category operations, starter template seeding on first boot, position reordering with gap strategy, WS broadcast events, and integration tests.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-01-SUMMARY.md
@server/src/routes.rs
@server/src/db/migrations.rs
@server/src/roles/permissions.rs
@shared/proto/channels.proto
@server/src/ws/broadcast.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing integration tests for channel/category CRUD</name>
  <files>
    server/tests/channels_test.rs
  </files>
  <action>
Write integration tests using the existing `start_test_server()` pattern from Phase 1 (see server/tests/auth_test.rs for the pattern — starts server on random port, returns base_url and setup_token). Each test should register as owner first (using setup_token), then exercise channel/category endpoints.

Tests to write (all should FAIL at this point since endpoints don't exist):

1. `test_get_channels_returns_starter_template` — Register as owner, GET /api/channels, assert response contains General category with #general and #introductions text channels, Voice category with one voice channel, and the @everyone role.

2. `test_create_channel` — Register as owner, POST /api/channels with {name: "test-channel", channel_type: "text", category_id: <general_cat_id>}, assert 201 with channel object containing id, name, position.

3. `test_rename_channel` — Create a channel, PUT /api/channels/{id} with {name: "renamed"}, assert 200 with updated name.

4. `test_delete_channel` — Create a channel, DELETE /api/channels/{id}, assert 200. GET /api/channels and verify it's gone.

5. `test_create_category` — POST /api/categories with {name: "New Category"}, assert 201 with category object.

6. `test_delete_category_fails_if_has_channels` — Try to DELETE a category that still has channels, assert 400 error.

7. `test_reorder_channels` — Create 3 channels, PUT /api/channels/reorder with new position list, GET /api/channels and verify new ordering.

8. `test_channel_crud_requires_manage_channels_permission` — Register as a non-owner user (need a second registration with an invite or open registration), attempt POST /api/channels without manage_channels permission, assert 403 FORBIDDEN.

Use the `random_signing_key()` pattern from existing tests for Ed25519 keypair generation. Use reqwest for HTTP calls (already a dev-dependency).
  </action>
  <verify>
Run `cd /c/Users/matts/UNITED/server && /c/Users/matts/.cargo/bin/cargo test --test channels_test -- --nocapture 2>&1 | head -50` — tests should compile but FAIL (RED phase of TDD). Compilation success is required; runtime failures expected.
  </verify>
  <done>8 integration tests compile and fail with expected errors (404 for non-existent endpoints or similar). Tests cover CRUD, starter template, reordering, and permission checks.</done>
</task>

<task type="auto">
  <name>Task 2: Implement channel/category CRUD, starter template, and WS events</name>
  <files>
    server/src/channels/mod.rs
    server/src/channels/crud.rs
    server/src/channels/ordering.rs
    server/src/channels/seed.rs
    server/src/routes.rs
    server/src/main.rs
    server/src/ws/protocol.rs
  </files>
  <action>
1. Create `server/src/channels/mod.rs` with `pub mod crud; pub mod ordering; pub mod seed;`.

2. Create `server/src/channels/ordering.rs` with:
   - `const POSITION_GAP: i64 = 1000;`
   - `pub fn next_position(max_current: i64) -> i64` — returns max_current + POSITION_GAP
   - `pub fn position_between(before: i64, after: i64) -> i64` — midpoint, with guard for collision
   - `pub fn renormalize_positions(item_ids: &[String], conn: &rusqlite::Connection, table: &str)` — reassign positions at POSITION_GAP intervals
   Use code from Pattern 2 in research.

3. Create `server/src/channels/seed.rs` with:
   - `pub fn seed_starter_template(conn: &rusqlite::Connection) -> Result<(), rusqlite::Error>` — guard with COUNT(*) from categories, then create: General category (position 1000), #general text (position 1000), #introductions text (position 2000), Voice category (position 2000), General voice channel (position 1000), @everyone role (permissions = 0x01 for SEND_MESSAGES, is_default = 1, position 0). Use UUIDv7 for all IDs. Use exact code from Pattern 4 in research.
   - Call this function after owner registration succeeds. Modify the registration handler in `server/src/identity/registration.rs` to call `seed_starter_template(&conn)` after creating the owner user row. Guard: only run if user is_owner AND categories table is empty.

4. Create `server/src/channels/crud.rs` with axum REST handlers:
   - `GET /api/channels` — public (any authenticated user). Returns full channel list grouped by categories. Query all categories ordered by position, then all channels ordered by category_id + position. Return as ChannelListResponse protobuf or JSON.
   - `POST /api/channels` — require_permission(MANAGE_CHANNELS). Create channel in specified category. Validate category exists. Assign next_position. Broadcast ChannelCreatedEvent via WS. Return 201 + channel object.
   - `PUT /api/channels/{id}` — require_permission(MANAGE_CHANNELS). Rename channel (update name and/or topic). Broadcast ChannelUpdatedEvent. Return 200.
   - `DELETE /api/channels/{id}` — require_permission(MANAGE_CHANNELS). Delete channel. Broadcast ChannelDeletedEvent. Return 200.
   - `PUT /api/channels/reorder` — require_permission(MANAGE_CHANNELS). Accept list of {id, position} pairs. Update all positions in a transaction. Broadcast full channel list update via WS.
   - `POST /api/categories` — require_permission(MANAGE_CHANNELS). Create category with next_position. Broadcast CategoryCreatedEvent. Return 201.
   - `PUT /api/categories/{id}` — require_permission(MANAGE_CHANNELS). Rename category. Broadcast CategoryUpdatedEvent. Return 200.
   - `DELETE /api/categories/{id}` — require_permission(MANAGE_CHANNELS). Reject if category has channels (return 400 "Category still has channels"). Broadcast CategoryDeletedEvent. Return 200.
   - `PUT /api/categories/reorder` — require_permission(MANAGE_CHANNELS). Accept list of {id, position} pairs. Update positions. Broadcast update.

   All admin endpoints use `require_permission()` from 02-01. All mutations broadcast events using `broadcast_to_all()` from 02-01. Use `spawn_blocking` for all DB operations (established pattern).

5. Add `pub mod channels;` to server/src/main.rs (or lib.rs).

6. Wire channel and category routes into `server/src/routes.rs` — add routes to the channel_routes and merge into the main router. Channel list GET is authenticated (uses Claims extractor). All mutation endpoints are authenticated.

7. Update `server/src/ws/protocol.rs` to dispatch new channel/category event types from the protobuf Envelope (if WS-initiated requests are supported — at minimum, the protocol module should recognize the new payload variants).
  </action>
  <verify>
Run `cd /c/Users/matts/UNITED/server && /c/Users/matts/.cargo/bin/cargo test --test channels_test -- --nocapture` — all 8 tests should PASS (GREEN phase of TDD). Also run `cargo test` for full test suite to ensure no regressions in Phase 1 tests.
  </verify>
  <done>All channel/category CRUD endpoints work. Starter template seeds on first boot. Position reordering works. Permission checks enforce MANAGE_CHANNELS. WS broadcast events fire after mutations. All 8 integration tests pass. No Phase 1 test regressions.</done>
</task>

</tasks>

<verification>
- `cargo test` passes all tests (Phase 1 + new channel tests)
- GET /api/channels returns starter template after owner registration
- POST/PUT/DELETE channels and categories return correct status codes
- Permission checks reject non-admin users with 403
- Reorder endpoint updates positions correctly
- Starter template includes @everyone role with SEND_MESSAGES permission
</verification>

<success_criteria>
Server admin can create, rename, delete, and reorder text and voice channels organized into categories. Server starts with starter template. All mutations broadcast WS events. 8+ integration tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-02-SUMMARY.md`
</output>
