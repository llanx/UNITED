---
phase: 02-server-management
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - server/src/channels/mod.rs
  - server/src/channels/crud.rs
  - server/src/channels/ordering.rs
  - server/src/channels/seed.rs
  - server/src/ws/protocol.rs
  - server/tests/channels_test.rs
  - server/src/identity/registration.rs
autonomous: true
requirements:
  - SRVR-01
  - SRVR-02

must_haves:
  truths:
    - "Admin can create a text or voice channel in a specified category via REST API"
    - "Admin can rename and delete channels via REST API"
    - "Admin can create, rename, and delete categories via REST API"
    - "Channels are ordered within categories via position integers with gap strategy"
    - "Server boots with starter template: General category (#general, #introductions) + Voice category (one voice channel) + @everyone role"
    - "All channel/category mutations broadcast delta events to connected WebSocket clients"
  artifacts:
    - path: "server/src/channels/crud.rs"
      provides: "Channel and category CRUD REST endpoint handlers"
      contains: "create_channel"
    - path: "server/src/channels/ordering.rs"
      provides: "Position integer gap strategy with renormalization"
      contains: "position_between"
    - path: "server/src/channels/seed.rs"
      provides: "Starter template seeding function"
      contains: "seed_starter_template"
    - path: "server/tests/channels_test.rs"
      provides: "Integration tests for channel/category CRUD"
      contains: "async fn test_create_channel"
  key_links:
    - from: "server/src/channels/crud.rs"
      to: "server/src/roles/permissions.rs"
      via: "Permission check before mutation"
      pattern: "require_permission.*MANAGE_CHANNELS"
    - from: "server/src/channels/seed.rs"
      to: "server/src/identity/registration.rs"
      via: "Seed called after first owner registration"
      pattern: "seed_starter_template"
    - from: "server/src/channels/crud.rs"
      to: "server/src/ws/mod.rs"
      via: "Broadcast channel events to connected clients"
      pattern: "broadcast_to_all"
---

<objective>
Implement channel and category CRUD with position-based ordering, starter template seeding, and real-time WebSocket push events for all mutations.

Purpose: Channels and categories are the structural backbone of a server community. Without them, there is nothing to organize messages into. The starter template ensures new servers have a usable default structure immediately.

Output: Working channel/category CRUD endpoints, starter template, reorder endpoints, WebSocket push events, and integration tests.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-01-SUMMARY.md
@server/src/channels/mod.rs
@server/src/roles/permissions.rs
@server/src/db/migrations.rs
@server/src/db/models.rs
@server/src/state.rs
@server/src/ws/mod.rs
@server/src/ws/protocol.rs
@server/src/identity/registration.rs
@server/src/auth/middleware.rs
@server/tests/auth_test.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration tests for channel/category CRUD (RED phase)</name>
  <files>
    server/tests/channels_test.rs
  </files>
  <action>
  Write integration tests FIRST (TDD RED phase) using the existing test pattern from `server/tests/auth_test.rs` (start_test_server, random port, register owner via setup token).

  Per project decision: "REST endpoints: write Rust integration tests against proto contracts FIRST, then implement to pass."

  Tests to write (all should FAIL initially since endpoints don't exist yet):

  1. `test_create_channel` -- Register as owner, POST /api/channels with { name: "test", channel_type: "text", category_id: (use General category from starter template) }. Expect 201 with channel JSON including id, name, channel_type, category_id, position.

  2. `test_rename_channel` -- Create a channel, then PUT /api/channels/{id} with { name: "renamed" }. Expect 200.

  3. `test_delete_channel` -- Create a channel, then DELETE /api/channels/{id}. Expect 200. Then GET /api/channels should not include it.

  4. `test_create_category` -- POST /api/categories with { name: "New Category" }. Expect 201 with category JSON.

  5. `test_rename_category` -- Create category, PUT /api/categories/{id} with { name: "Renamed" }. Expect 200.

  6. `test_delete_category` -- Create empty category (no channels), DELETE /api/categories/{id}. Expect 200. Deleting a category with channels should return 400 ("Move or delete channels first").

  7. `test_channel_list` -- GET /api/channels (no auth required -- channel list is public for server members). Expect response with categories, each containing their channels, ordered by position.

  8. `test_starter_template_exists` -- After owner registration, GET /api/channels. Expect 2 categories (General, Voice), 3 channels (#general, #introductions, General voice).

  9. `test_reorder_channels` -- Create multiple channels, POST /api/channels/reorder with array of { id, position } pairs. Expect 200. GET /api/channels should reflect new order.

  10. `test_permission_required` -- Register as non-owner user (no manage_channels permission). Try POST /api/channels. Expect 403.

  Use the existing `random_signing_key()` helper and test server setup pattern from auth_test.rs. Each test should be independent (own server instance on random port).

  Commit: `test(02-02): add failing channel/category CRUD integration tests`
  </action>
  <verify>
  `cargo test --test channels_test` -- tests should COMPILE but FAIL (404 or connection refused since endpoints don't exist yet). If tests don't compile, fix compilation errors before proceeding.
  </verify>
  <done>
  10 integration tests written and committed. Tests compile but fail (RED state) because channel/category endpoints are not yet implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Channel/category CRUD implementation, starter template, and WebSocket events (GREEN phase)</name>
  <files>
    server/src/channels/mod.rs
    server/src/channels/crud.rs
    server/src/channels/ordering.rs
    server/src/channels/seed.rs
    server/src/ws/protocol.rs
    server/src/identity/registration.rs
  </files>
  <action>
  Implement all channel/category CRUD to make the RED tests pass (TDD GREEN phase).

  1. Create `server/src/channels/ordering.rs`:
     - `const POSITION_GAP: i64 = 1000;`
     - `position_between(before: i64, after: i64) -> i64` -- returns midpoint
     - `next_position(max_pos: i64) -> i64` -- returns `max_pos + POSITION_GAP`
     - `renormalize_positions(item_ids: &[String], conn: &Connection, table: &str)` -- reassign with even gaps

  2. Create `server/src/channels/seed.rs`:
     - `seed_starter_template(conn: &Connection) -> Result<(), rusqlite::Error>` per Research Pattern 4:
       - General category (position 1000): #general (text, position 1000), #introductions (text, position 2000)
       - Voice category (position 2000): General (voice, position 1000)
       - @everyone default role: permissions = 0x01 (SEND_MESSAGES), is_default = 1
     - Guard: check `SELECT COUNT(*) FROM categories` before seeding (Pitfall 5 -- prevent double-seeding)

  3. Create `server/src/channels/crud.rs` with these axum handlers:
     - `GET /api/channels` -- Return all categories with their channels, ordered by position. Public (any authenticated user).
     - `POST /api/channels` -- Create channel. Requires MANAGE_CHANNELS permission. Validates category_id exists. Assigns position = max_pos + 1000 in that category. Returns 201 with channel JSON.
     - `PUT /api/channels/{id}` -- Rename channel. Requires MANAGE_CHANNELS. Returns 200.
     - `DELETE /api/channels/{id}` -- Delete channel. Requires MANAGE_CHANNELS. Returns 200.
     - `POST /api/categories` -- Create category. Requires MANAGE_CHANNELS. Returns 201.
     - `PUT /api/categories/{id}` -- Rename category. Requires MANAGE_CHANNELS. Returns 200.
     - `DELETE /api/categories/{id}` -- Delete category. Requires MANAGE_CHANNELS. Returns 400 if category has channels ("Move or delete channels first"). Returns 200 if empty.
     - `POST /api/channels/reorder` -- Reorder channels within a category. Accepts array of { id, position }. Requires MANAGE_CHANNELS. Returns 200.

     Permission check: Create a `require_permission` async helper (per Research Example 1) that:
     - Returns Ok(()) for owner (claims.is_owner)
     - Queries user_roles + default role permissions from DB
     - Computes effective permissions via `compute_user_permissions`
     - Returns Err(StatusCode::FORBIDDEN) if required permission not present

     Export this helper from channels/crud.rs or a shared location so roles/moderation/invite modules can reuse it.

  4. After each mutation (create, rename, delete channel/category), broadcast a delta WebSocket event to all connected clients:
     - Encode the appropriate protobuf message (ChannelCreated, ChannelUpdated, ChannelDeleted, CategoryCreated, CategoryUpdated, CategoryDeleted) into an Envelope
     - Use the ConnectionRegistry to broadcast_to_all
     - Update `server/src/ws/protocol.rs` to handle ChannelListRequest: when received, query DB and send back ChannelListResponse

  5. Update `server/src/channels/mod.rs` to expose `pub mod crud; pub mod ordering; pub mod seed;` and update the `routes()` function to wire all endpoints.

  6. Call `seed_starter_template()` from the owner registration flow in `server/src/identity/registration.rs` -- after the first owner is created (setup token consumed), seed the default categories/channels/role. Check if categories table is empty first to avoid double-seeding.

  Commit: `feat(02-02): implement channel/category CRUD with starter template and WS events`
  </action>
  <verify>
  - `cargo test --test channels_test` -- ALL 10 tests pass (GREEN state)
  - `cargo test` -- ALL existing Phase 1 tests still pass
  - Start server, register as owner, verify starter template channels visible at GET /api/channels
  </verify>
  <done>
  All 10 channel/category integration tests pass. Starter template seeds correctly on first owner registration. WebSocket delta events broadcast on all mutations. Existing Phase 1 tests unaffected. Permission guard prevents unauthorized access.
  </done>
</task>

</tasks>

<verification>
- `cargo test --test channels_test` -- All 10 tests pass
- `cargo test` -- All tests pass (channels + Phase 1)
- Server boots, creates starter template on owner registration
- GET /api/channels returns categories with channels ordered by position
- Non-admin user gets 403 on mutation endpoints
- Channel/category CRUD operations broadcast WS events
</verification>

<success_criteria>
- Channel CRUD: create, rename, delete text and voice channels via REST
- Category CRUD: create, rename, delete categories via REST
- Starter template: General (#general, #introductions) + Voice (General) categories seeded on first boot
- Position ordering: gap strategy (1000 increments), reorder endpoint
- Permission gating: MANAGE_CHANNELS required for all mutations
- WebSocket push: delta events for all channel/category mutations
- TDD: Tests written first, all passing
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-02-SUMMARY.md`
</output>
