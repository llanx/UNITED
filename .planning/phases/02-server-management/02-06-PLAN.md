---
phase: 02-server-management
plan: 06
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - client/src/renderer/src/components/ChannelSidebar.tsx
  - client/src/renderer/src/components/ChannelList.tsx
  - client/src/renderer/src/components/CategoryHeader.tsx
  - client/src/renderer/src/components/ChannelManagement.tsx
  - client/src/renderer/src/components/RoleManagement.tsx
  - client/src/renderer/src/components/MemberList.tsx
  - client/src/renderer/src/stores/channels.ts
  - client/src/renderer/src/stores/roles.ts
  - client/src/renderer/src/hooks/useChannels.ts
  - client/src/renderer/src/hooks/useRoles.ts
  - client/src/main/ipc/channels.ts
  - client/src/main/ipc/roles.ts
  - shared/types/ipc-bridge.ts
  - client/src/preload/index.ts
  - client/src/renderer/src/pages/Main.tsx
autonomous: true
requirements:
  - SRVR-01
  - SRVR-02
  - SRVR-03
  - SRVR-04

must_haves:
  truths:
    - "User sees channel sidebar with categories and channels organized by position"
    - "Categories are collapsible and show channel count"
    - "Text and voice channels display with appropriate icons"
    - "Admin sees channel management panel (create/rename/delete channels and categories)"
    - "Admin sees role management panel (create/update/delete roles, assign/remove)"
    - "Channel and role state updates in real-time via WS events"
    - "Non-admin users see channel list but cannot access management panels"
  artifacts:
    - path: "client/src/renderer/src/components/ChannelList.tsx"
      provides: "Channel sidebar with categories, positions, and channel type icons"
      contains: "ChannelList"
    - path: "client/src/renderer/src/components/ChannelManagement.tsx"
      provides: "Admin panel for channel/category CRUD"
      contains: "ChannelManagement"
    - path: "client/src/renderer/src/components/RoleManagement.tsx"
      provides: "Admin panel for role CRUD and assignment"
      contains: "RoleManagement"
    - path: "client/src/renderer/src/stores/channels.ts"
      provides: "Zustand store for channels/categories with WS event handlers"
      contains: "useChannelStore"
    - path: "client/src/renderer/src/stores/roles.ts"
      provides: "Zustand store for roles with WS event handlers"
      contains: "useRoleStore"
  key_links:
    - from: "client/src/renderer/src/stores/channels.ts"
      to: "server REST API"
      via: "IPC bridge: window.united.channels.*"
      pattern: "fetchChannels|createChannel"
    - from: "client/src/renderer/src/components/ChannelList.tsx"
      to: "client/src/renderer/src/stores/channels.ts"
      via: "Zustand useChannelStore"
      pattern: "useChannelStore"
    - from: "client/src/renderer/src/components/RoleManagement.tsx"
      to: "client/src/renderer/src/stores/roles.ts"
      via: "Zustand useRoleStore"
      pattern: "useRoleStore"
---

<objective>
Build the client UI for channel management and role management: channel sidebar with categories, admin panels for CRUD operations, and Zustand stores with real-time WS event handling.

Purpose: Users need to see and navigate the server's channel structure. Admins need management panels to create/edit/delete channels, categories, and roles. Real-time updates via WebSocket keep all clients in sync when an admin makes changes.

Output: Enhanced channel sidebar with categories and position ordering, channel management panel, role management panel, Zustand stores, IPC bridge extensions, and WS event handlers.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-02-SUMMARY.md
@.planning/phases/02-server-management/02-03-SUMMARY.md
@.planning/phases/01-foundation/01-06-SUMMARY.md
@client/src/renderer/src/components/ChannelSidebar.tsx
@client/src/renderer/src/stores/channels.ts
@client/src/renderer/src/pages/Main.tsx
@shared/types/ipc-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: IPC bridge, Zustand stores, and hooks for channels and roles</name>
  <files>
    client/src/main/ipc/channels.ts
    client/src/main/ipc/roles.ts
    client/src/renderer/src/stores/channels.ts
    client/src/renderer/src/stores/roles.ts
    client/src/renderer/src/hooks/useChannels.ts
    client/src/renderer/src/hooks/useRoles.ts
    shared/types/ipc-bridge.ts
    client/src/preload/index.ts
    client/src/main/index.ts
  </files>
  <action>
1. Create `client/src/main/ipc/channels.ts` — IPC handlers that proxy REST calls to server:
   - `fetchChannels()` → GET /api/channels, return categories with nested channels
   - `createChannel(name, channelType, categoryId)` → POST /api/channels
   - `renameChannel(id, name)` → PUT /api/channels/{id}
   - `deleteChannel(id)` → DELETE /api/channels/{id}
   - `reorderChannels(positions: {id, position}[])` → PUT /api/channels/reorder
   - `createCategory(name)` → POST /api/categories
   - `renameCategory(id, name)` → PUT /api/categories/{id}
   - `deleteCategory(id)` → DELETE /api/categories/{id}
   - `reorderCategories(positions: {id, position}[])` → PUT /api/categories/reorder

   Follow the existing IPC-to-REST bridge pattern from client/src/main/ipc/auth.ts (use stored JWT token, base URL from connection state, fetch with proper headers).

2. Create `client/src/main/ipc/roles.ts` — IPC handlers:
   - `fetchRoles()` → GET /api/roles
   - `createRole(name, permissions, color?)` → POST /api/roles
   - `updateRole(id, name?, permissions?, color?)` → PUT /api/roles/{id}
   - `deleteRole(id)` → DELETE /api/roles/{id}
   - `assignRole(userId, roleId)` → POST /api/roles/assign
   - `removeRole(userId, roleId)` → POST /api/roles/remove
   - `getUserRoles(userId)` → GET /api/roles/user/{userId}

3. Update `shared/types/ipc-bridge.ts` to add channels and roles methods to UnitedAPI interface.

4. Update `client/src/preload/index.ts` to expose new IPC methods.

5. Register new IPC handlers in `client/src/main/index.ts`.

6. Update `client/src/renderer/src/stores/channels.ts` (existing file, currently may be a stub):
   - Zustand store with state: `categories: Category[]`, `channels: Channel[]`, `loading: boolean`
   - Actions: `fetchChannels()`, `createChannel()`, `renameChannel()`, `deleteChannel()`, `createCategory()`, `renameCategory()`, `deleteCategory()`, `reorderChannels()`, `reorderCategories()`
   - WS event handlers: `handleChannelCreated(event)`, `handleChannelUpdated(event)`, `handleChannelDeleted(event)`, etc. — update local state on real-time events (insert/update/remove from arrays, maintaining sort order by position)
   - Selector: `getChannelsByCategory()` — returns channels grouped by category_id, both sorted by position

7. Create `client/src/renderer/src/stores/roles.ts`:
   - Zustand store with state: `roles: Role[]`, `userRoles: Map<string, string[]>`, `loading: boolean`
   - Actions: `fetchRoles()`, `createRole()`, `updateRole()`, `deleteRole()`, `assignRole()`, `removeRole()`
   - WS event handlers for all role events
   - Selector: `getUserPermissions(userId)` — compute effective permissions from assigned roles (client-side mirror of server logic for UI gating only, NOT for security enforcement)

8. Create `client/src/renderer/src/hooks/useChannels.ts` — fetch on mount, subscribe to WS events.
9. Create `client/src/renderer/src/hooks/useRoles.ts` — fetch on mount, subscribe to WS events.
  </action>
  <verify>
Client TypeScript compiles: `cd /c/Users/matts/UNITED/client && npx tsc --noEmit` (or `npx electron-vite build`). Verify Zustand stores export correct types and actions.
  </verify>
  <done>IPC bridge exposes all channel and role methods. Zustand stores manage channels, categories, and roles state with WS event handlers for real-time updates. Hooks provide convenient data access with auto-fetching.</done>
</task>

<task type="auto">
  <name>Task 2: Channel sidebar UI and admin management panels</name>
  <files>
    client/src/renderer/src/components/ChannelSidebar.tsx
    client/src/renderer/src/components/ChannelList.tsx
    client/src/renderer/src/components/CategoryHeader.tsx
    client/src/renderer/src/components/ChannelManagement.tsx
    client/src/renderer/src/components/RoleManagement.tsx
    client/src/renderer/src/components/MemberList.tsx
    client/src/renderer/src/pages/Main.tsx
  </files>
  <action>
1. Create `client/src/renderer/src/components/CategoryHeader.tsx`:
   - Renders category name with collapse/expand chevron
   - Click toggles channel list visibility for that category
   - Shows channel count badge when collapsed
   - Admin: right-click context menu with Rename/Delete options
   - Tailwind: uppercase text, muted color, small font (Discord-style category headers)

2. Create `client/src/renderer/src/components/ChannelList.tsx`:
   - Renders full channel structure: categories (ordered by position) containing channels (ordered by position)
   - Each channel shows: type icon (# for text, speaker icon for voice), channel name
   - Selected channel highlighted with active background color
   - Click sets active channel in Zustand store
   - Admin: right-click context menu with Rename/Delete/Move to Category options
   - Voice channels show connected user count (placeholder for Phase 8)

3. Update `client/src/renderer/src/components/ChannelSidebar.tsx`:
   - Replace any stub/placeholder channel list with the real ChannelList component
   - Add "+" button at top for creating channels/categories (admin only, gated by permissions)
   - Server name at top (existing), channel list below
   - Server name dropdown menu: add "Channel Management" and "Role Management" options (admin only)

4. Create `client/src/renderer/src/components/ChannelManagement.tsx`:
   - Modal/panel for channel and category management (admin only)
   - Section 1: Categories list with Add/Rename/Delete buttons
   - Section 2: Channels grouped by category with Add/Rename/Delete buttons
   - "Create Channel" form: name input, type dropdown (text/voice), category dropdown
   - "Create Category" form: name input
   - Delete confirmation dialogs
   - Position reordering: up/down arrow buttons for each item (drag-and-drop can be a future enhancement)
   - Accessible from server name dropdown menu

5. Create `client/src/renderer/src/components/RoleManagement.tsx`:
   - Modal/panel for role management (admin only)
   - Role list with color indicators
   - "Create Role" form: name, permission checkboxes (send_messages, manage_channels, kick_members, ban_members, admin), optional color picker
   - "Edit Role" form: same fields, pre-filled
   - Delete button (disabled for @everyone)
   - Member assignment section: list of server members, toggle role assignment per member
   - Permission checkboxes should use the 5 named permissions from CONTEXT.md
   - Accessible from server name dropdown menu

6. Create `client/src/renderer/src/components/MemberList.tsx`:
   - Server member list (used in role assignment panel)
   - Shows display name + assigned roles as colored badges
   - Placeholder for now — full member list API may need to be added to server or derived from existing data

7. Update `client/src/renderer/src/pages/Main.tsx`:
   - Wire ChannelList into the sidebar area
   - Use useChannels() and useRoles() hooks for data
   - Gate admin UI elements behind permission checks (use client-side permission computation from roles store — UI gating only)

   Follow existing component patterns: dark theme, Tailwind CSS, Discord-style spacing. No animations (not in scope).
  </action>
  <verify>
Client builds: `cd /c/Users/matts/UNITED/client && npx electron-vite build`. Visual inspection: channel sidebar shows categories with channels, collapsible categories, channel type icons. Admin panels render with forms and permission controls. Non-admin view hides management options.
  </verify>
  <done>Channel sidebar renders real categories and channels from server, ordered by position. Categories are collapsible. Admin users see management options in server dropdown. Channel management panel supports CRUD with position reordering. Role management panel supports CRUD with permission checkboxes and member assignment. Non-admin users see channel list only.</done>
</task>

</tasks>

<verification>
- Client builds without errors
- Channel sidebar shows starter template channels on first load
- Categories collapse/expand correctly
- Channel type icons display (# for text, speaker for voice)
- Admin management panels are accessible from server dropdown
- Channel CRUD operations update UI in real-time via WS events
- Role CRUD operations update UI in real-time
- Permission checkboxes map to the 5 named permissions
- Non-admin users cannot access management panels
</verification>

<success_criteria>
Users see a fully functional channel sidebar with categories and channels. Admins can manage channels, categories, and roles through dedicated UI panels. All changes propagate in real-time via WebSocket events. Non-admins see channel list without management options.
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-06-SUMMARY.md`
</output>
