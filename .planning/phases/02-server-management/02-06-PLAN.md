---
phase: 02-server-management
plan: 06
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03", "02-04"]
files_modified:
  - client/src/renderer/src/stores/channels.ts
  - client/src/renderer/src/stores/roles.ts
  - client/src/renderer/src/stores/index.ts
  - client/src/renderer/src/components/ChannelSidebar.tsx
  - client/src/renderer/src/components/admin/ChannelManager.tsx
  - client/src/renderer/src/components/admin/RoleManager.tsx
  - client/src/renderer/src/components/admin/ModerationPanel.tsx
  - client/src/renderer/src/components/admin/InviteManager.tsx
  - client/src/renderer/src/components/ServerSettings.tsx
  - client/src/renderer/src/pages/Main.tsx
  - client/src/preload/index.ts
  - shared/types/ipc-bridge.ts
autonomous: true
requirements:
  - SRVR-01
  - SRVR-02
  - SRVR-03
  - SRVR-04
  - SRVR-05
  - SRVR-06
  - SRVR-08

must_haves:
  truths:
    - "Channel sidebar renders categories with their channels grouped and ordered by position"
    - "Admin can manage channels and categories from the Server Settings panel"
    - "Admin can manage roles and assign them to users from the Server Settings panel"
    - "Admin can kick and ban users from the moderation panel"
    - "Admin can generate and manage invite links from the Server Settings panel"
    - "Non-admin users see channel list but not admin management panels"
    - "WebSocket push events update the channel/role/member state in real-time"
  artifacts:
    - path: "client/src/renderer/src/components/ChannelSidebar.tsx"
      provides: "Category-grouped channel list with position ordering"
      contains: "categories.map"
    - path: "client/src/renderer/src/components/admin/ChannelManager.tsx"
      provides: "Admin UI for creating, renaming, deleting channels and categories"
      contains: "createChannel"
    - path: "client/src/renderer/src/components/admin/RoleManager.tsx"
      provides: "Admin UI for managing roles, permissions, and assignments"
      contains: "createRole"
    - path: "client/src/renderer/src/components/admin/ModerationPanel.tsx"
      provides: "Admin UI for kick/ban/unban with ban list"
      contains: "kickUser"
    - path: "client/src/renderer/src/components/admin/InviteManager.tsx"
      provides: "Admin UI for creating and managing invite links"
      contains: "createInvite"
    - path: "client/src/renderer/src/stores/channels.ts"
      provides: "Category-aware channel state with WS event handlers"
      contains: "Category"
  key_links:
    - from: "client/src/renderer/src/components/ChannelSidebar.tsx"
      to: "client/src/renderer/src/stores/channels.ts"
      via: "Zustand subscription for category-grouped channel data"
      pattern: "useStore.*categories"
    - from: "client/src/renderer/src/components/admin/ChannelManager.tsx"
      to: "client/src/preload/index.ts"
      via: "IPC bridge for REST API calls"
      pattern: "window.united"
    - from: "client/src/renderer/src/stores/channels.ts"
      to: "shared/types/ipc-bridge.ts"
      via: "WS push event handlers for channel/category mutations"
      pattern: "ChannelCreated|ChannelDeleted|CategoryCreated"
---

<objective>
Build the client-side UI for Phase 2 server management: upgrade the channel sidebar to render categories with grouped channels, and create admin management panels for channels, categories, roles, moderation, and invites.

Purpose: The server-side APIs from plans 02-01 through 02-04 need a client to be usable. Success criterion 5 ("A newly joined user sees the channel list, category structure, and their assigned permissions immediately") requires client rendering. Admins need UI to manage their community without raw API calls.

Output: Category-grouped channel sidebar, admin panels for channel/category/role/moderation/invite management, Zustand store upgrades, IPC bridge extensions, and real-time WS event handling.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT-CLIENT.md
@.planning/phases/02-server-management/02-01-SUMMARY.md
@.planning/phases/02-server-management/02-02-SUMMARY.md
@.planning/phases/02-server-management/02-03-SUMMARY.md
@.planning/phases/02-server-management/02-04-SUMMARY.md
@client/src/renderer/src/stores/index.ts
@client/src/renderer/src/stores/channels.ts
@client/src/renderer/src/components/ChannelSidebar.tsx
@client/src/renderer/src/components/ServerSettings.tsx
@client/src/renderer/src/pages/Main.tsx
@client/src/preload/index.ts
@shared/types/ipc-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zustand store upgrades, IPC bridge extensions, and WS event handlers</name>
  <files>
    client/src/renderer/src/stores/channels.ts
    client/src/renderer/src/stores/roles.ts
    client/src/renderer/src/stores/index.ts
    client/src/preload/index.ts
    shared/types/ipc-bridge.ts
  </files>
  <action>
  1. Update `shared/types/ipc-bridge.ts` to add Phase 2 IPC methods to the UnitedAPI interface:
     ```typescript
     // Channel/Category management
     channels: {
       list: () => Promise<Category[]>  // GET /api/channels — returns categories with nested channels
       createChannel: (req: { name: string; channelType: 'text' | 'voice'; categoryId: string }) => Promise<Channel>
       renameChannel: (channelId: string, name: string) => Promise<void>
       deleteChannel: (channelId: string) => Promise<void>
       createCategory: (name: string) => Promise<Category>
       renameCategory: (categoryId: string, name: string) => Promise<void>
       deleteCategory: (categoryId: string) => Promise<void>
       reorderChannels: (items: { id: string; position: number }[]) => Promise<void>
     }
     // Role management
     roles: {
       list: () => Promise<Role[]>
       create: (req: { name: string; permissions: number; color?: string }) => Promise<Role>
       update: (roleId: string, req: { name?: string; permissions?: number; color?: string }) => Promise<void>
       delete: (roleId: string) => Promise<void>
       assign: (userId: string, roleId: string) => Promise<void>
       remove: (userId: string, roleId: string) => Promise<void>
       getUserRoles: (userId: string) => Promise<Role[]>
     }
     // Moderation
     moderation: {
       kick: (userId: string) => Promise<void>
       ban: (userId: string, reason?: string, durationSeconds?: number) => Promise<void>
       unban: (userId: string) => Promise<void>
       listBans: () => Promise<BanInfo[]>
     }
     // Invites
     invites: {
       create: (req: { maxUses?: number; expiresInSeconds?: number }) => Promise<InviteInfo>
       list: () => Promise<InviteInfo[]>
       delete: (code: string) => Promise<void>
     }
     ```

     Add TypeScript types for Category, Channel, Role, BanInfo, InviteInfo matching the protobuf message definitions from 02-01.

  2. Update `client/src/preload/index.ts`:
     - Add IPC handlers for all Phase 2 methods listed above
     - Each method invokes the main process which calls the server REST API
     - Expose through contextBridge under `window.united.channels`, `window.united.roles`, `window.united.moderation`, `window.united.invites`

  3. Upgrade `client/src/renderer/src/stores/channels.ts`:
     - Replace flat `CachedChannel[]` with category-aware structure:
       ```typescript
       export interface Category {
         id: string
         name: string
         position: number
         channels: Channel[]
       }
       export interface Channel {
         id: string
         name: string
         channelType: 'text' | 'voice'
         categoryId: string
         position: number
         topic?: string
       }
       export interface ChannelsSlice {
         categories: Category[]
         activeChannelId: string | null
         fetchChannels: () => Promise<void>
       }
       ```
     - Add `fetchChannels` action that calls `window.united.channels.list()` and updates categories state
     - Add WS event handlers (called from main process push events via IPC):
       - `handleChannelCreated(channel)`: insert into correct category, maintain position order
       - `handleChannelUpdated(channel)`: update in place
       - `handleChannelDeleted(channelId)`: remove from categories
       - `handleCategoryCreated(category)`: add to categories list
       - `handleCategoryUpdated(category)`: update in place
       - `handleCategoryDeleted(categoryId)`: remove from list

  4. Create `client/src/renderer/src/stores/roles.ts`:
     ```typescript
     export interface Role {
       id: string
       name: string
       permissions: number
       color?: string
       position: number
       isDefault: boolean
     }
     export interface RolesSlice {
       roles: Role[]
       fetchRoles: () => Promise<void>
     }
     ```
     - Add `fetchRoles` action
     - Add WS event handlers for role mutations

  5. Update `client/src/renderer/src/stores/index.ts`:
     - Import and merge the new RolesSlice
     - Update hydration to fetch categories (replacing flat channel list) and roles on startup
     - Preserve backward compatibility: derive a flat `channels` array from categories for any existing components that use it

  Commit: `feat(02-06): extend stores and IPC bridge for Phase 2 server management`
  </action>
  <verify>
  - `npx tsc --noEmit` passes in client directory (TypeScript compiles)
  - Stores create without errors (import test)
  - IPC bridge types are correctly defined
  </verify>
  <done>
  Channels store upgraded to category-aware structure. Roles store created. IPC bridge extended with all Phase 2 methods. WS event handlers wired for real-time updates. Store hydration fetches categories and roles on startup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Channel sidebar upgrade and admin management panels</name>
  <files>
    client/src/renderer/src/components/ChannelSidebar.tsx
    client/src/renderer/src/components/admin/ChannelManager.tsx
    client/src/renderer/src/components/admin/RoleManager.tsx
    client/src/renderer/src/components/admin/ModerationPanel.tsx
    client/src/renderer/src/components/admin/InviteManager.tsx
    client/src/renderer/src/components/ServerSettings.tsx
    client/src/renderer/src/pages/Main.tsx
  </files>
  <action>
  1. Upgrade `client/src/renderer/src/components/ChannelSidebar.tsx`:
     - Replace flat channel list with category-grouped rendering:
       ```tsx
       categories.map(cat => (
         <div key={cat.id}>
           <CategoryHeader name={cat.name} />
           {cat.channels.sort(byPosition).map(ch => (
             <ChannelItem key={ch.id} channel={ch} active={ch.id === activeChannelId} />
           ))}
         </div>
       ))
       ```
     - Show text channels with `#` prefix, voice channels with a speaker icon prefix
     - Maintain existing server name header dropdown with settings access
     - Categories are collapsible (click category name to toggle)
     - Channels ordered by position within each category, categories ordered by position
     - Per context decision: "Every channel must belong to a category"

  2. Create `client/src/renderer/src/components/admin/ChannelManager.tsx`:
     - Admin panel accessible from Server Settings
     - List all categories with their channels in a tree view
     - "Create Channel" form: name input, type selector (text/voice), category selector dropdown. Calls `window.united.channels.createChannel()`.
     - "Create Category" form: name input. Calls `window.united.channels.createCategory()`.
     - Inline rename: click channel/category name to edit. Calls renameChannel/renameCategory.
     - Delete: X button with confirmation dialog. Calls deleteChannel/deleteCategory.
     - Per context: "Deleting a category with channels should return 400" — show error message if server rejects.
     - Per context: "Manual drag-and-drop ordering" — implement drag-and-drop reorder for channels within categories using HTML5 drag-and-drop API (no external library). On drop, compute new position integers and call `window.united.channels.reorderChannels()`.

  3. Create `client/src/renderer/src/components/admin/RoleManager.tsx`:
     - Admin panel accessible from Server Settings
     - List all roles ordered by position. Show @everyone role as non-deletable.
     - "Create Role" form: name input, permission checkboxes (send_messages, manage_channels, kick_members, ban_members, admin), optional color picker. Calls `window.united.roles.create()`.
     - Edit role: click role name to expand/edit. Toggle individual permission checkboxes. Save calls `window.united.roles.update()`.
     - Delete role: X button with confirmation. Cannot delete @everyone (button disabled/hidden).
     - Assign role to user: user search/select + role selector. Calls `window.united.roles.assign()`.
     - Remove role from user: in user's role list, click X. Calls `window.united.roles.remove()`. Cannot remove @everyone.
     - Permission names displayed as human-readable labels: "Send Messages", "Manage Channels", "Kick Members", "Ban Members", "Administrator"

  4. Create `client/src/renderer/src/components/admin/ModerationPanel.tsx`:
     - Admin panel accessible from Server Settings
     - **Members list** section: Show all server members with their roles. For each member (except owner), show action buttons based on caller's permissions.
     - **Kick** button: Confirmation dialog ("Kick [username]? They can rejoin with an invite."). Calls `window.united.moderation.kick()`.
     - **Ban** button: Dialog with optional reason text field and optional duration selector (1h, 24h, 7d, permanent). Per context: "Optional ban reason — admin can write a reason when banning." Calls `window.united.moderation.ban()`.
     - **Ban list** section: Shows all active bans with fingerprint, reason, expiration, admin who banned. "Unban" button calls `window.united.moderation.unban()`.
     - Per context: "Clear ban notice — banned user sees 'You have been banned from [server name]' with the optional reason." Handle 4003 WS close code on the client side: show full-screen ban message.

  5. Create `client/src/renderer/src/components/admin/InviteManager.tsx`:
     - Admin panel accessible from Server Settings
     - "Create Invite" form: optional max uses selector (1, 5, 10, 25, 100, unlimited), optional expiration selector (1h, 24h, 7d, never). Calls `window.united.invites.create()`.
     - Per context: "Expiration + use count limits — both optional."
     - Display generated invite link in a copyable format: `https://[serverUrl]/invite/[code]`
     - Copy-to-clipboard button for the invite URL
     - List all existing invites with code, creator, uses (use_count/max_uses), expiration, creation date
     - Delete invite: X button with confirmation. Calls `window.united.invites.delete()`.

  6. Update `client/src/renderer/src/components/ServerSettings.tsx`:
     - Add tab navigation within Server Settings: "General" (existing settings), "Channels", "Roles", "Moderation", "Invites"
     - Each tab renders the corresponding admin panel component
     - Only show admin tabs if user has the appropriate permissions (isOwner or has ADMIN permission)
     - Existing server name/description/registration mode settings stay in "General" tab

  7. Update `client/src/renderer/src/pages/Main.tsx`:
     - Ensure the settings panel routes to the tabbed ServerSettings when activePanel === 'settings'
     - No other changes needed — existing layout pattern handles it

  All components use the existing dark theme CSS variables and Tailwind classes consistent with Phase 1 components (see ChannelSidebar.tsx, ServerSettings.tsx patterns for styling reference).

  Commit: `feat(02-06): channel sidebar with categories and admin management UI`
  </action>
  <verify>
  - `npm run build` passes in client directory
  - Channel sidebar renders categories with grouped channels
  - Admin panels render with correct forms and actions
  - Server Settings has tab navigation between General/Channels/Roles/Moderation/Invites
  - Non-admin users see only the channel sidebar, not admin management tabs
  </verify>
  <done>
  Channel sidebar upgraded to render categories with position-ordered channels. Admin management panels created for channels, categories, roles, moderation, and invites. Server Settings has tabbed navigation. All IPC calls wired to server REST APIs. WS events update UI in real-time. Non-admins see channel list but not admin controls.
  </done>
</task>

</tasks>

<verification>
- Client builds without errors
- Channel sidebar renders categories with grouped, position-ordered channels
- Text channels show `#` prefix, voice channels show speaker icon
- Admin can access Channel/Role/Moderation/Invite management via Server Settings tabs
- Channel CRUD operations succeed via IPC and update sidebar in real-time
- Role CRUD and assignment works through admin panel
- Kick and ban actions work with confirmation dialogs
- Invite generation produces copyable links with correct format
- WS push events update all connected client UIs in real-time
- Non-admin users cannot see or access admin management tabs
</verification>

<success_criteria>
- Category-grouped channel sidebar with position ordering replaces flat channel list
- Admin management panels: channels, categories, roles, moderation, invites
- Server Settings tabbed interface with permission-gated admin tabs
- All REST API calls wired through IPC bridge
- Real-time WS event handling keeps client state synchronized
- Dark theme styling consistent with Phase 1 components
- Non-admin users see channels but not management UI
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-06-SUMMARY.md`
</output>
