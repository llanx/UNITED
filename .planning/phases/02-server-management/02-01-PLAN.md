---
phase: 02-server-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/db/migrations.rs
  - server/src/db/models.rs
  - server/src/roles/mod.rs
  - server/src/roles/permissions.rs
  - server/Cargo.toml
  - shared/proto/channels.proto
  - shared/proto/roles.proto
  - shared/proto/moderation.proto
  - shared/proto/invite.proto
  - shared/proto/ws.proto
  - server/src/routes.rs
  - server/src/channels/mod.rs
  - server/src/moderation/mod.rs
  - server/src/invite/mod.rs
  - server/src/lib.rs
autonomous: true
requirements:
  - SRVR-01
  - SRVR-02
  - SRVR-03
  - SRVR-04
  - SRVR-05
  - SRVR-06
  - SRVR-08
  - SRVR-09

must_haves:
  truths:
    - "Migration 2 applies cleanly on top of Migration 1 creating all 6 new tables"
    - "Permissions bitflags type correctly computes union resolution and ADMIN implies all"
    - "All new protobuf messages compile for both Rust (prost) and TypeScript (bufbuild)"
    - "Server boots successfully with the new migration applied"
  artifacts:
    - path: "server/src/db/migrations.rs"
      provides: "Migration 2 with categories, channels, roles, user_roles, bans, invites tables"
      contains: "Migration 2"
    - path: "server/src/roles/permissions.rs"
      provides: "Permissions bitflags with SEND_MESSAGES, MANAGE_CHANNELS, KICK_MEMBERS, BAN_MEMBERS, ADMIN"
      contains: "bitflags!"
    - path: "shared/proto/channels.proto"
      provides: "Channel and category protobuf messages"
      contains: "message Channel"
    - path: "shared/proto/roles.proto"
      provides: "Role and permission protobuf messages"
      contains: "message Role"
  key_links:
    - from: "server/src/roles/permissions.rs"
      to: "server/src/db/migrations.rs"
      via: "Permission bits stored as INTEGER in roles table"
      pattern: "permissions INTEGER"
    - from: "server/src/routes.rs"
      to: "server/src/channels/mod.rs"
      via: "Module router merge"
      pattern: "channels::routes"
---

<objective>
Create the database schema extension (Migration 2), the permission bitflags system, all protobuf message definitions for Phase 2 domains, and the route scaffold with per-module Router functions.

Purpose: Every subsequent plan (channels, roles, moderation, invites) depends on these shared foundations. Building them first eliminates circular dependencies and enables parallel execution of feature plans.

Output: Migration 2 SQL, Permissions type with bitflags, 4 new proto files, module stubs with route functions, updated main router.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@server/src/db/migrations.rs
@server/src/db/models.rs
@server/src/state.rs
@server/src/routes.rs
@server/src/lib.rs
@server/Cargo.toml
@shared/proto/ws.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration, permission bitflags, and database models</name>
  <files>
    server/src/db/migrations.rs
    server/src/db/models.rs
    server/src/roles/mod.rs
    server/src/roles/permissions.rs
    server/Cargo.toml
  </files>
  <action>
  1. Add `bitflags = "2.11"` to server/Cargo.toml dependencies.

  2. In `server/src/roles/permissions.rs`, create the Permissions bitflags type:
     - `SEND_MESSAGES = 1 << 0` (0x01)
     - `MANAGE_CHANNELS = 1 << 1` (0x02)
     - `KICK_MEMBERS = 1 << 2` (0x04)
     - `BAN_MEMBERS = 1 << 3` (0x08)
     - `ADMIN = 1 << 4` (0x10)
     - Add `effective()` method: if ADMIN is set, return `Permissions::all()`
     - Add `compute_user_permissions(is_owner: bool, role_permissions: &[u32]) -> Permissions` function that returns `Permissions::all()` for owner, or bitwise OR of all role_permissions with `.effective()` applied.
     - Per user decision: "Union resolution -- if ANY role grants a permission, the user has it. Bitwise OR of all role permission flags."
     - Per user decision: "Owner role has all permissions implicitly -- not represented as a regular role."

  3. Create `server/src/roles/mod.rs` with `pub mod permissions;`

  4. Append Migration 2 to `server/src/db/migrations.rs` (NEVER modify Migration 1 -- append only):
     ```sql
     -- Migration 2: Server Management (Phase 2)
     CREATE TABLE categories (
         id TEXT PRIMARY KEY,
         name TEXT NOT NULL,
         position INTEGER NOT NULL DEFAULT 0,
         created_at TEXT NOT NULL
     );

     CREATE TABLE channels (
         id TEXT PRIMARY KEY,
         name TEXT NOT NULL,
         channel_type TEXT NOT NULL DEFAULT 'text' CHECK(channel_type IN ('text', 'voice')),
         category_id TEXT NOT NULL,
         position INTEGER NOT NULL DEFAULT 0,
         topic TEXT,
         created_at TEXT NOT NULL,
         FOREIGN KEY (category_id) REFERENCES categories(id)
     );

     CREATE INDEX idx_channels_category ON channels(category_id);

     CREATE TABLE roles (
         id TEXT PRIMARY KEY,
         name TEXT NOT NULL,
         permissions INTEGER NOT NULL DEFAULT 0,
         color TEXT,
         position INTEGER NOT NULL DEFAULT 0,
         is_default INTEGER NOT NULL DEFAULT 0,
         created_at TEXT NOT NULL,
         updated_at TEXT NOT NULL
     );

     CREATE TABLE user_roles (
         user_id TEXT NOT NULL,
         role_id TEXT NOT NULL,
         assigned_at TEXT NOT NULL,
         PRIMARY KEY (user_id, role_id),
         FOREIGN KEY (user_id) REFERENCES users(id),
         FOREIGN KEY (role_id) REFERENCES roles(id)
     );

     CREATE INDEX idx_user_roles_user ON user_roles(user_id);
     CREATE INDEX idx_user_roles_role ON user_roles(role_id);

     CREATE TABLE bans (
         id TEXT PRIMARY KEY,
         fingerprint TEXT NOT NULL,
         banned_by TEXT NOT NULL,
         reason TEXT,
         expires_at TEXT,
         created_at TEXT NOT NULL,
         FOREIGN KEY (banned_by) REFERENCES users(id)
     );

     CREATE UNIQUE INDEX idx_bans_fingerprint ON bans(fingerprint);

     CREATE TABLE invites (
         code TEXT PRIMARY KEY,
         created_by TEXT NOT NULL,
         max_uses INTEGER,
         use_count INTEGER NOT NULL DEFAULT 0,
         expires_at TEXT,
         created_at TEXT NOT NULL,
         FOREIGN KEY (created_by) REFERENCES users(id)
     );
     ```
     Note: No ON DELETE CASCADE on any FK -- per Pitfall 2 in research, kick should NOT cascade delete user data.

  5. Add model structs to `server/src/db/models.rs`:
     - `CategoryRow { id, name, position, created_at }`
     - `ChannelRow { id, name, channel_type, category_id, position, topic, created_at }`
     - `RoleRow { id, name, permissions, color, position, is_default, created_at, updated_at }`
     - `UserRoleRow { user_id, role_id, assigned_at }`
     - `BanRow { id, fingerprint, banned_by, reason, expires_at, created_at }`
     - `InviteRow { code, created_by, max_uses, use_count, expires_at, created_at }`
  </action>
  <verify>
  Run `cargo check` from server/ directory to confirm:
  - Migration 2 compiles (no SQL syntax errors surface at compile time, but schema is valid SQL)
  - bitflags! macro expands correctly
  - All model structs compile
  - Cargo.toml resolves bitflags dependency
  </verify>
  <done>
  Migration 2 appended with 6 tables (categories, channels, roles, user_roles, bans, invites). Permissions bitflags type defined with 5 flags and compute_user_permissions helper. All 6 model structs added. `cargo check` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Protobuf message definitions and route scaffold</name>
  <files>
    shared/proto/channels.proto
    shared/proto/roles.proto
    shared/proto/moderation.proto
    shared/proto/invite.proto
    shared/proto/ws.proto
    server/src/channels/mod.rs
    server/src/moderation/mod.rs
    server/src/invite/mod.rs
    server/src/routes.rs
    server/src/lib.rs
    server/build.rs
  </files>
  <action>
  1. Create `shared/proto/channels.proto` (package `united.channels`):
     - `Channel` message: id, name, channel_type (enum TEXT/VOICE), category_id, position, topic
     - `Category` message: id, name, position, channels (repeated Channel)
     - `CreateChannelRequest`: name, channel_type, category_id
     - `RenameChannelRequest`: channel_id, name
     - `DeleteChannelRequest`: channel_id
     - `CreateCategoryRequest`: name
     - `RenameCategoryRequest`: category_id, name
     - `DeleteCategoryRequest`: category_id
     - `ReorderRequest`: repeated items (id + new_position pairs)
     - `ChannelListResponse`: repeated Category (each containing its channels)
     - WS push events: `ChannelCreated`, `ChannelUpdated`, `ChannelDeleted`, `CategoryCreated`, `CategoryUpdated`, `CategoryDeleted`

  2. Create `shared/proto/roles.proto` (package `united.roles`):
     - `Role` message: id, name, permissions (uint32), color, position, is_default
     - `CreateRoleRequest`: name, permissions, color
     - `UpdateRoleRequest`: role_id, name, permissions, color
     - `DeleteRoleRequest`: role_id
     - `AssignRoleRequest`: user_id, role_id
     - `RemoveRoleRequest`: user_id, role_id
     - `RoleListResponse`: repeated Role
     - WS push events: `RoleCreated`, `RoleUpdated`, `RoleDeleted`, `RoleAssigned`, `RoleRemoved`

  3. Create `shared/proto/moderation.proto` (package `united.moderation`):
     - `KickRequest`: user_id
     - `BanRequest`: user_id, reason (optional), duration_seconds (optional, 0 = permanent)
     - `UnbanRequest`: user_id
     - `BanInfo`: id, fingerprint, reason, expires_at, created_at, banned_by
     - `BanListResponse`: repeated BanInfo
     - WS push events: `UserKicked`, `UserBanned`, `UserUnbanned`

  4. Create `shared/proto/invite.proto` (package `united.invite`):
     - `CreateInviteRequest`: max_uses (optional), expires_in_seconds (optional)
     - `InviteInfo`: code, created_by, max_uses, use_count, expires_at, created_at
     - `InviteListResponse`: repeated InviteInfo
     - `DeleteInviteRequest`: code
     - `JoinServerRequest`: invite_code, (include registration fields from auth.proto -- fingerprint, public_key, display_name, genesis_signature, encrypted_blob)

  5. Update `shared/proto/ws.proto` to add new payload variants to the Envelope oneof:
     - Add imports for channels.proto, roles.proto, moderation.proto, invite.proto
     - Add payload variants for all WS push events (ChannelCreated, ChannelUpdated, ChannelDeleted, CategoryCreated, CategoryUpdated, CategoryDeleted, RoleCreated, RoleUpdated, RoleDeleted, RoleAssigned, RoleRemoved, UserKicked, UserBanned, UserUnbanned)
     - Add a ChannelListRequest payload (client requests full channel/category list)

  6. Update `server/build.rs` to include the new proto files in prost compilation.

  7. Create module stubs with empty route functions that return `Router::new()`:
     - `server/src/channels/mod.rs`: `pub fn routes(_state: AppState) -> Router { Router::new() }`
     - `server/src/moderation/mod.rs`: `pub fn routes(_state: AppState) -> Router { Router::new() }`
     - `server/src/invite/mod.rs`: `pub fn routes(_state: AppState) -> Router { Router::new() }`
     Note: roles/mod.rs already exists from Task 1 -- add `pub fn routes(_state: AppState) -> Router { Router::new() }` to it.

  8. Update `server/src/routes.rs` to merge the new module routers:
     ```rust
     .merge(channels::routes(state.clone()))
     .merge(roles::routes(state.clone()))
     .merge(moderation::routes(state.clone()))
     .merge(invite::routes(state.clone()))
     ```

  9. Update `server/src/lib.rs` to add `pub mod channels; pub mod roles; pub mod moderation; pub mod invite;`

  10. Run `buf generate` from shared/ directory to regenerate TypeScript protobuf types.
  </action>
  <verify>
  - `cargo check` passes (all proto files compile via prost-build, all modules resolve)
  - `cargo build` succeeds (full compilation including generated protobuf types)
  - Run the server briefly to confirm it boots and Migration 2 applies: `cargo run -- --generate-config` or just start and check log output
  - Verify TypeScript types generated: `ls shared/types/generated/` should show new proto output files
  </verify>
  <done>
  4 new proto files define all Phase 2 messages. ws.proto Envelope extended with new payload variants. 4 module stubs with empty route functions. Main router merges all module routers. Server boots and Migration 2 applies to SQLite. TypeScript protobuf types regenerated.
  </done>
</task>

</tasks>

<verification>
- `cargo build` passes with no errors
- `cargo test` (existing Phase 1 tests) still passes -- Migration 2 is additive only
- Server starts, applies Migration 2, and responds to `/health` check
- All 6 new tables visible in SQLite database after boot
- Permissions bitflags compile and `compute_user_permissions` returns correct results
</verification>

<success_criteria>
- Migration 2 creates 6 tables (categories, channels, roles, user_roles, bans, invites) with correct schema
- Permissions type has 5 named flags with union resolution and ADMIN-implies-all
- All protobuf messages for channels, roles, moderation, and invites are defined and compile
- Module router scaffold enables subsequent plans to add endpoints without touching routes.rs
- Existing Phase 1 tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-01-SUMMARY.md`
</output>
