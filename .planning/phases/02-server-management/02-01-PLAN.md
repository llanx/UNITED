---
phase: 02-server-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/Cargo.toml
  - server/src/db/migrations.rs
  - server/src/db/models.rs
  - server/src/roles/mod.rs
  - server/src/roles/permissions.rs
  - shared/proto/channels.proto
  - shared/proto/roles.proto
  - shared/proto/moderation.proto
  - shared/proto/invite.proto
  - shared/proto/ws.proto
  - server/src/ws/broadcast.rs
  - server/src/ws/mod.rs
  - server/src/routes.rs
  - server/src/state.rs
  - server/build.rs
autonomous: true
requirements:
  - SRVR-01
  - SRVR-02
  - SRVR-03
  - SRVR-04
  - SRVR-05
  - SRVR-06
  - SRVR-08
  - SRVR-09

must_haves:
  truths:
    - "Server starts successfully with Migration 2 applied (6 new tables created)"
    - "Permissions bitflags type provides named flags and union resolution"
    - "Protobuf messages compile for channels, roles, moderation, and invites"
    - "WS envelope has new payload variants for all Phase 2 event types"
    - "Broadcast helpers can send events to all connected clients or specific users"
  artifacts:
    - path: "server/src/db/migrations.rs"
      provides: "Migration 2 with categories, channels, roles, user_roles, bans, invites tables"
      contains: "Migration 2"
    - path: "server/src/roles/permissions.rs"
      provides: "Permissions bitflags type with 5 flags and compute_user_permissions()"
      contains: "bitflags"
    - path: "shared/proto/channels.proto"
      provides: "Channel and category protobuf messages"
      contains: "message Channel"
    - path: "shared/proto/roles.proto"
      provides: "Role and permission protobuf messages"
      contains: "message Role"
    - path: "shared/proto/moderation.proto"
      provides: "Kick and ban protobuf messages"
      contains: "message Ban"
    - path: "shared/proto/invite.proto"
      provides: "Invite protobuf messages"
      contains: "message Invite"
    - path: "server/src/ws/broadcast.rs"
      provides: "broadcast_to_all, send_to_user, force_close_user helpers"
      contains: "broadcast_to_all"
  key_links:
    - from: "server/src/roles/permissions.rs"
      to: "server/src/db/migrations.rs"
      via: "permissions INTEGER column stores bitflags value"
      pattern: "Permissions::from_bits_truncate"
    - from: "shared/proto/ws.proto"
      to: "shared/proto/channels.proto"
      via: "import and oneof payload variants"
      pattern: "import.*channels.proto"
---

<objective>
Create the foundational schema, permission system, protobuf definitions, and broadcast infrastructure that all subsequent Phase 2 plans depend on.

Purpose: Every Phase 2 feature (channels, roles, moderation, invites) needs the database tables, permission types, protobuf message definitions, and WebSocket broadcast helpers. Building this shared foundation first enables plans 02-02 through 02-04 to run in parallel without file conflicts.

Output: Migration 2 with 6 new tables, Permissions bitflags type with require_permission() guard, 4 new .proto files with WS envelope extensions, and broadcast_to_all/send_to_user/force_close_user helpers.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-management/02-RESEARCH.md
@.planning/phases/02-server-management/02-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@server/src/db/migrations.rs
@server/src/db/models.rs
@server/src/state.rs
@server/src/routes.rs
@server/src/ws/mod.rs
@shared/proto/ws.proto
@server/build.rs
@server/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration, permission bitflags, and model types</name>
  <files>
    server/Cargo.toml
    server/src/db/migrations.rs
    server/src/db/models.rs
    server/src/roles/mod.rs
    server/src/roles/permissions.rs
  </files>
  <action>
1. Add `bitflags = "2"` to server/Cargo.toml dependencies.

2. In `server/src/db/migrations.rs`, append Migration 2 to the existing migrations vector (do NOT modify Migration 1). Migration 2 creates 6 tables:

   - `categories` (id TEXT PK, name TEXT NOT NULL, position INTEGER NOT NULL DEFAULT 0, created_at TEXT NOT NULL)
   - `channels` (id TEXT PK, name TEXT NOT NULL, channel_type TEXT NOT NULL DEFAULT 'text', category_id TEXT NOT NULL FK→categories, position INTEGER NOT NULL DEFAULT 0, topic TEXT, created_at TEXT NOT NULL) with index on category_id
   - `roles` (id TEXT PK, name TEXT NOT NULL, permissions INTEGER NOT NULL DEFAULT 0, color TEXT, position INTEGER NOT NULL DEFAULT 0, is_default INTEGER NOT NULL DEFAULT 0, created_at TEXT NOT NULL, updated_at TEXT NOT NULL)
   - `user_roles` (user_id TEXT NOT NULL FK→users, role_id TEXT NOT NULL FK→roles, assigned_at TEXT NOT NULL, PRIMARY KEY (user_id, role_id)) with indexes on user_id and role_id
   - `bans` (id TEXT PK, fingerprint TEXT NOT NULL, banned_by TEXT NOT NULL FK→users, reason TEXT, expires_at TEXT, created_at TEXT NOT NULL) with unique index on fingerprint
   - `invites` (code TEXT PK, created_by TEXT NOT NULL FK→users, max_uses INTEGER, use_count INTEGER NOT NULL DEFAULT 0, expires_at TEXT, created_at TEXT NOT NULL)

   Use exact SQL from Pattern 3 in 02-RESEARCH.md. Ensure all FKs reference correct tables.

3. Create `server/src/roles/mod.rs` with `pub mod permissions;`.

4. Create `server/src/roles/permissions.rs` with:
   - `bitflags!` macro defining `Permissions: u32` with 5 flags: `SEND_MESSAGES = 1 << 0`, `MANAGE_CHANNELS = 1 << 1`, `KICK_MEMBERS = 1 << 2`, `BAN_MEMBERS = 1 << 3`, `ADMIN = 1 << 4`
   - `Permissions::effective()` method: if ADMIN is set, return `Permissions::all()`
   - `pub fn compute_user_permissions(is_owner: bool, role_permissions: &[u32]) -> Permissions` — owner returns all(), otherwise bitwise OR of all role permission values then call .effective()
   - `pub async fn require_permission(db: &DbPool, user_id: &str, is_owner: bool, required: Permissions) -> Result<(), StatusCode>` — spawn_blocking, query all permissions from user_roles JOIN roles UNION ALL default roles (is_default=1), compute effective, check contains(required). Return FORBIDDEN on failure. Use exact SQL from Pattern 5 in research.
   - Import DbPool from `crate::db`.

5. Add model structs to `server/src/db/models.rs`:
   - `Category { id, name, position, created_at }`
   - `Channel { id, name, channel_type, category_id, position, topic, created_at }`
   - `Role { id, name, permissions, color, position, is_default, created_at, updated_at }`
   - `Ban { id, fingerprint, banned_by, reason, expires_at, created_at }`
   - `Invite { code, created_by, max_uses, use_count, expires_at, created_at }`

6. Add `pub mod roles;` to `server/src/main.rs` (or lib.rs as appropriate for the module tree).
  </action>
  <verify>
Run `cd /c/Users/matts/UNITED/server && /c/Users/matts/.cargo/bin/cargo check` — must compile with no errors. Verify Migration 2 SQL is syntactically correct by inspecting the file.
  </verify>
  <done>Migration 2 creates 6 tables with correct FKs and indexes. Permissions bitflags type compiles with 5 named flags. compute_user_permissions() and require_permission() are available as public functions. All model structs defined.</done>
</task>

<task type="auto">
  <name>Task 2: Protobuf definitions, WS envelope extension, and broadcast helpers</name>
  <files>
    shared/proto/channels.proto
    shared/proto/roles.proto
    shared/proto/moderation.proto
    shared/proto/invite.proto
    shared/proto/ws.proto
    server/src/ws/broadcast.rs
    server/src/ws/mod.rs
    server/src/routes.rs
    server/build.rs
  </files>
  <action>
1. Create `shared/proto/channels.proto` (package `united.channels`):
   - `Channel` message: id, name, channel_type, category_id, position (int64), topic
   - `Category` message: id, name, position (int64)
   - Request/response messages: `CreateChannelRequest`, `RenameChannelRequest`, `DeleteChannelRequest`, `ReorderChannelsRequest` (list of {id, position} pairs), `CreateCategoryRequest`, `RenameCategoryRequest`, `DeleteCategoryRequest`, `ReorderCategoriesRequest`
   - Event messages (server→client push): `ChannelCreatedEvent`, `ChannelUpdatedEvent`, `ChannelDeletedEvent`, `CategoryCreatedEvent`, `CategoryUpdatedEvent`, `CategoryDeletedEvent`, `ChannelListResponse` (full list of categories with nested channels)

2. Create `shared/proto/roles.proto` (package `united.roles`):
   - `Role` message: id, name, permissions (uint32), color, position (int64), is_default (bool)
   - Request/response: `CreateRoleRequest`, `UpdateRoleRequest`, `DeleteRoleRequest`, `AssignRoleRequest` (user_id, role_id), `RemoveRoleRequest`, `RoleListResponse`
   - Events: `RoleCreatedEvent`, `RoleUpdatedEvent`, `RoleDeletedEvent`, `RoleAssignedEvent`, `RoleRemovedEvent`

3. Create `shared/proto/moderation.proto` (package `united.moderation`):
   - `BanInfo` message: id, fingerprint, banned_by, reason, expires_at, created_at
   - `KickRequest` (user_id, reason), `BanRequest` (user_id, reason, expires_at), `UnbanRequest` (fingerprint)
   - Events: `UserKickedEvent`, `UserBannedEvent`, `UserUnbannedEvent`

4. Create `shared/proto/invite.proto` (package `united.invite`):
   - `Invite` message: code, created_by, max_uses, use_count, expires_at, created_at
   - `CreateInviteRequest` (max_uses, expires_at), `DeleteInviteRequest` (code), `InviteListResponse`
   - `JoinServerRequest` (invite_code), `JoinServerResponse` (success, channel_list, role_list)

5. Update `shared/proto/ws.proto`:
   - Add imports for channels.proto, roles.proto, moderation.proto, invite.proto
   - Add new payload variants to the Envelope oneof using RESERVED field number blocks: channels 50-59, roles 60-69, moderation 70-79, invites 80-89. Add a comment documenting this allocation.
   - Include all request, response, and event message types as payload variants.

6. Update `server/build.rs` to compile the 4 new .proto files (add to the prost_build compile_protos list).

7. Create `server/src/ws/broadcast.rs` with three functions (use exact code from Pattern 10 in research):
   - `pub fn broadcast_to_all(registry: &ConnectionRegistry, envelope: &Envelope)` — encode envelope, iterate all registry entries, send to each
   - `pub fn send_to_user(registry: &ConnectionRegistry, user_id: &str, envelope: &Envelope)` — encode, lookup user, send to all their connections
   - `pub fn force_close_user(registry: &ConnectionRegistry, user_id: &str, close_code: u16, reason: &str)` — send Close frame with code and reason to all user connections

8. Update `server/src/ws/mod.rs` to add `pub mod broadcast;` and re-export the broadcast functions.

9. Update `server/src/routes.rs` to add placeholder route groups (empty routers) for channels, roles, moderation, and invites — so subsequent plans can add routes without modifying the router merge structure. Add:
   - `let channel_routes = Router::new();` (merged into main router)
   - `let role_routes = Router::new();`
   - `let moderation_routes = Router::new();`
   - `let invite_routes = Router::new();`
   These are empty scaffolds that plans 02-02, 02-03, 02-04 will populate.
  </action>
  <verify>
Run `cd /c/Users/matts/UNITED/server && /c/Users/matts/.cargo/bin/cargo check` — must compile with all new proto types available. Verify proto compilation generates types for all 4 new packages. Run `cd /c/Users/matts/UNITED/shared && npx buf generate` to regenerate TypeScript types (if buf is available).
  </verify>
  <done>Four new .proto files compile via prost. WS envelope has new payload variants in reserved field number blocks (50-89). broadcast_to_all, send_to_user, and force_close_user are available. Route scaffold has placeholder groups for channels, roles, moderation, and invites. Server compiles clean.</done>
</task>

</tasks>

<verification>
- `cargo check` passes with zero errors and zero warnings related to Phase 2 code
- Migration 2 SQL is valid (6 CREATE TABLE + indexes)
- `Permissions::all()` returns all 5 flags OR'd
- `require_permission()` is callable from any handler
- All 4 new .proto files are compiled by prost-build
- WS envelope field numbers don't collide with Phase 1 (10-43, 99)
- Broadcast functions compile and reference ConnectionRegistry correctly
</verification>

<success_criteria>
Server compiles with Migration 2 schema, Permissions bitflags, 4 new proto packages, WS envelope extensions, and broadcast helpers. All subsequent plans (02-02, 02-03, 02-04) can import these types without modification.
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-management/02-01-SUMMARY.md`
</output>
