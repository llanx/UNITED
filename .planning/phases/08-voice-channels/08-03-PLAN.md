---
phase: 08-voice-channels
plan: 03
type: execute
wave: 3
depends_on:
  - "08-02"
files_modified:
  - client/src/renderer/src/components/VoiceBar.tsx
  - client/src/renderer/src/components/VoiceParticipant.tsx
  - client/src/renderer/src/components/VoiceSettings.tsx
  - client/src/renderer/src/components/ChannelList.tsx
  - client/src/renderer/src/components/ChannelSidebar.tsx
  - client/src/renderer/src/components/Main.tsx
  - docker-compose.yml
  - server/Dockerfile
autonomous: true
requirements:
  - VOICE-01
  - VOICE-02
  - VOICE-03
  - VOICE-04

must_haves:
  truths:
    - "User can click a voice channel in the sidebar to join immediately with no confirmation"
    - "Persistent voice bar at bottom-left shows channel name, quality icon, mute/deafen/disconnect buttons"
    - "Participants appear inline under the voice channel in the sidebar with speaking glow indicators"
    - "User can right-click a participant for per-user volume slider (0-200%)"
    - "Voice Settings panel has device selection, mic test, VAD sensitivity slider, PTT key configuration"
    - "docker-compose.yml ships coturn as a sidecar with TURN relay for NAT traversal"
  artifacts:
    - path: "client/src/renderer/src/components/VoiceBar.tsx"
      provides: "Persistent bottom-left voice controls"
      contains: "VoiceBar"
    - path: "client/src/renderer/src/components/VoiceParticipant.tsx"
      provides: "Sidebar participant entry with speaking indicator"
      contains: "speaking"
    - path: "client/src/renderer/src/components/VoiceSettings.tsx"
      provides: "Settings > Voice panel"
      contains: "vadSensitivity"
    - path: "docker-compose.yml"
      provides: "Docker compose with coturn sidecar"
      contains: "coturn"
  key_links:
    - from: "client/src/renderer/src/components/ChannelList.tsx"
      to: "client/src/renderer/src/stores/voice.ts"
      via: "joinVoiceChannel on voice channel click"
      pattern: "joinVoiceChannel"
    - from: "client/src/renderer/src/components/VoiceBar.tsx"
      to: "client/src/renderer/src/stores/voice.ts"
      via: "toggleMute, toggleDeafen, leaveVoiceChannel"
      pattern: "toggleMute"
    - from: "client/src/renderer/src/components/VoiceParticipant.tsx"
      to: "client/src/renderer/src/stores/voice.ts"
      via: "voiceParticipants map for speaking state"
      pattern: "speaking"
    - from: "docker-compose.yml"
      to: "server/Dockerfile"
      via: "united-server and coturn services"
      pattern: "coturn/coturn"
---

<objective>
Build the voice UI components and Docker deployment: VoiceBar (persistent bottom-left controls), voice participants in sidebar with speaking indicators, VoiceSettings panel, per-user volume context menu, voice channel click-to-join behavior, and docker-compose.yml with coturn TURN relay sidecar.

Purpose: Delivers the user-facing voice experience that connects to the voice engine from plan 08-02. Also completes the deployment story by shipping coturn alongside the coordination server for NAT traversal.

Output: VoiceBar, VoiceParticipant, VoiceSettings components, updated ChannelList/ChannelSidebar, docker-compose.yml with coturn.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-voice-channels/08-CONTEXT.md
@.planning/phases/08-voice-channels/08-RESEARCH.md
@.planning/phases/08-voice-channels/08-01-SUMMARY.md
@.planning/phases/08-voice-channels/08-02-SUMMARY.md

@client/src/renderer/src/components/ChannelList.tsx
@client/src/renderer/src/components/ChannelSidebar.tsx
@client/src/renderer/src/stores/voice.ts
@server/Dockerfile

<interfaces>
<!-- Key types from voice store and existing components -->

From client/src/renderer/src/stores/voice.ts (created in 08-02):
```typescript
interface VoiceSlice {
  voiceChannelId: string | null
  voiceParticipants: Map<string, VoiceParticipantState>
  localMuted: boolean
  localDeafened: boolean
  voiceMode: VoiceMode
  vadSensitivity: number
  pttActive: boolean
  connectionQuality: ConnectionQuality
  qualityMetrics: VoiceQualityMetrics | null
  inputDeviceId: string | null
  outputDeviceId: string | null
  outputVolume: number
  userVolumes: Record<string, number>

  joinVoiceChannel: (channelId: string) => Promise<void>
  leaveVoiceChannel: () => void
  toggleMute: () => void
  toggleDeafen: () => void
  setVoiceMode: (mode: VoiceMode) => void
  setVadSensitivity: (value: number) => void
  setUserVolume: (userId: string, volume: number) => void
  setInputDevice: (deviceId: string) => void
  setOutputDevice: (deviceId: string) => void
  setOutputVolume: (volume: number) => void
}
```

From client/src/renderer/src/components/ChannelList.tsx:
```typescript
interface ChannelListProps {
  categoriesWithChannels: CategoryWithChannelsResponse[]
  activeChannelId: string | null
  isAdmin: boolean
  channelUnreadState?: Record<string, { unreadCount: number; mentionCount: number }>
  onSelectChannel: (id: string) => void
  // ... edit/delete callbacks
}

function ChannelItem({ channel, active, ... })  // Individual channel entry
function ChannelIcon({ type }: { type: string })  // Already has voice icon
```

From client/src/renderer/src/components/ChannelSidebar.tsx:
- Bottom section has user panel area
- Uses useStore for all state access
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Voice UI components (VoiceBar, VoiceParticipant, VoiceSettings) and sidebar integration</name>
  <files>
    client/src/renderer/src/components/VoiceBar.tsx
    client/src/renderer/src/components/VoiceParticipant.tsx
    client/src/renderer/src/components/VoiceSettings.tsx
    client/src/renderer/src/components/ChannelList.tsx
    client/src/renderer/src/components/ChannelSidebar.tsx
    client/src/renderer/src/components/Main.tsx
  </files>
  <action>
    **1. Create `client/src/renderer/src/components/VoiceBar.tsx`:**
    Persistent bottom-left voice bar, shown only when connected to a voice channel (voiceChannelId !== null). Positioned above the user panel in the ChannelSidebar.

    Layout (per CONTEXT.md):
    - Channel name (left side)
    - Connection quality icon (signal-strength bars, colored: green/yellow/red). Hover tooltip shows RTT in ms and packet loss %.
    - Mute button: mic icon / slashed-mic icon. Toggles localMuted via store.
    - Deafen button: headphones icon / slashed-headphones icon. Toggles localDeafened via store.
    - Disconnect button: red phone/X icon. Calls leaveVoiceChannel(). No confirmation dialog (per CONTEXT.md).

    Styling: Use CSS variables consistent with the existing dark theme. Compact horizontal bar. Icons should be SVG inline (consistent with existing ChannelIcon pattern). Green = `#43b581`, Yellow = `#faa61a`, Red = `#f04747` for quality indicator.

    Behaviors:
    - Mute/deafen are toggles with immediate visual feedback.
    - Deafen implies mute (if deafening, mute icon also shows slashed).
    - Connection quality reads from `connectionQuality` and `qualityMetrics` in voice store.

    **2. Create `client/src/renderer/src/components/VoiceParticipant.tsx`:**
    Single participant entry shown inline in the sidebar under a voice channel.

    Layout (per CONTEXT.md):
    - Small avatar (24-28px circle, pubkey hash-derived color like chat avatars)
    - Display name
    - Status icons on the right: slashed mic if muted, slashed headphone if deafened
    - Green glowing border ring on avatar when speaking (per CONTEXT.md: "green glowing border ring on participant's avatar in the sidebar list when they're speaking. Immediate, recognizable.")

    Speaking glow: CSS `box-shadow: 0 0 0 2px #43b581, 0 0 8px #43b581` on the avatar circle when `speaking` is true. Use CSS transition for smooth on/off (~150ms).

    Right-click context menu (per CONTEXT.md):
    - Volume slider: 0-200% range input. Reads/writes `userVolumes[userId]` from voice store.
    - Use the same context menu pattern as the existing right-click menus in ChannelList (fixed-position portal-style overlay via client coordinates).

    **3. Create `client/src/renderer/src/components/VoiceSettings.tsx`:**
    Settings > Voice panel. Accessible from the existing Settings infrastructure.

    Sections:
    - **Voice Mode:** Radio buttons for "Voice Activity" and "Push to Talk". Reads/writes `voiceMode` in store.
    - **VAD Sensitivity** (shown only when mode = 'vad'): Slider from "Sensitive" to "Aggressive". Reads/writes `vadSensitivity`. Below the slider, a real-time indicator bar showing current mic RMS level (so user can see when their voice is being detected). This uses the AudioPipeline's local RMS value updated at ~50ms intervals.
    - **Push to Talk Key** (shown only when mode = 'ptt'): Display current key name. "Click to change" button that enters listening mode, captures next keypress, and saves via `voice.setPttKey(keycode)`. Default: Backtick (`` ` ``).
    - **Input Device:** Dropdown listing available audio input devices from `navigator.mediaDevices.enumerateDevices()`. Reads/writes `inputDeviceId`.
    - **Output Device:** Dropdown listing available audio output devices. Reads/writes `outputDeviceId`.
    - **Output Volume:** Slider 0-100%. Reads/writes `outputVolume`.
    - **Mic Test:** Button that captures mic and plays back through the selected output device for a few seconds so user can hear themselves. Shows live volume bar during test.

    Device enumeration: Call `navigator.mediaDevices.enumerateDevices()` on panel mount. Filter by `kind === 'audioinput'` and `kind === 'audiooutput'`. Refresh on `devicechange` event.

    **4. Update `client/src/renderer/src/components/ChannelList.tsx`:**
    - When a voice channel is clicked (`channel.channel_type === 'voice'`):
      - Call `joinVoiceChannel(channel.id)` from voice store instead of `onSelectChannel`. Do NOT change activeChannelId (per CONTEXT.md: "Clicking a text channel does NOT disconnect" â€” the text channel remains active for reading).
      - If already in a different voice channel, the store's `joinVoiceChannel` auto-disconnects from the current one first (per CONTEXT.md).
      - If already in this voice channel, clicking it again does nothing (already connected).
    - Below each voice channel entry, render `VoiceParticipant` components for users in that channel. Read from `voiceParticipants` in voice store, filtered by channel_id.
    - Voice channel entries should look slightly different from text channels: no unread badge (voice channels don't have messages), but show participant count if > 0.
    - When soft participant cap exceeded (> 8), show a one-time toast: "Voice quality may be reduced with more than 8 participants." (per CONTEXT.md and research). Use a simple toast pattern or inline warning.

    **5. Update `client/src/renderer/src/components/ChannelSidebar.tsx`:**
    - Render VoiceBar between the channel list and the user panel at the bottom. Only shown when `voiceChannelId !== null`.
    - The VoiceBar should be positioned consistently at the bottom of the sidebar, not scrolling with the channel list.

    **6. Update `client/src/renderer/src/components/Main.tsx`:**
    - Initialize `useVoice()` hook here (from 08-02) so voice persists across all navigation.
    - Add VoiceSettings to the settings panel router (if settings uses panel switching, add 'voice' as a panel option).
  </action>
  <verify>
    cd /c/Users/matts/united/client && npx tsc --noEmit 2>&1 | tail -10
  </verify>
  <done>
    VoiceBar shows persistent controls at bottom of sidebar with mute/deafen/disconnect and connection quality. VoiceParticipant shows inline entries under voice channels with green speaking glow. VoiceSettings has full device selection, VAD slider, PTT key config, and mic test. ChannelList joins voice channels on click without changing active text channel. docker-compose not yet done (next task). TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: docker-compose.yml with coturn sidecar and config template update</name>
  <files>
    docker-compose.yml
    server/src/config.rs
  </files>
  <action>
    **1. Create `docker-compose.yml` at project root:**
    ```yaml
    version: '3.8'

    services:
      united-server:
        build:
          context: .
          dockerfile: server/Dockerfile
        ports:
          - "1984:1984"   # HTTP + WS
          - "1985:1985"   # libp2p WebSocket
        volumes:
          - united-data:/data
          - ./united.toml:/etc/united/united.toml:ro
        environment:
          - UNITED_DATA_DIR=/data
          - UNITED_PORT=1984
          - UNITED_CONFIG=/etc/united/united.toml
        restart: unless-stopped
        depends_on:
          - coturn

      coturn:
        image: coturn/coturn:4.8
        ports:
          - "3478:3478/udp"    # STUN/TURN UDP
          - "3478:3478/tcp"    # STUN/TURN TCP
          - "5349:5349/tcp"    # TURN TLS
          - "49152-49252:49152-49252/udp"  # Relay ports
        volumes:
          - ./turnserver.conf:/etc/turnserver.conf:ro
        command: ["-c", "/etc/turnserver.conf"]
        restart: unless-stopped

    volumes:
      united-data:
    ```

    **2. Create `turnserver.conf` template at project root:**
    ```
    # UNITED TURN Server Configuration
    # Used by coturn Docker sidecar for voice channel NAT traversal

    # Listening on all interfaces
    listening-ip=0.0.0.0

    # STUN/TURN ports
    listening-port=3478
    tls-listening-port=5349

    # Relay port range (keep narrow for Docker port mapping)
    min-port=49152
    max-port=49252

    # Authentication via shared secret (time-limited credentials)
    # IMPORTANT: Must match [turn] shared_secret in united.toml
    use-auth-secret
    static-auth-secret=CHANGE_ME_GENERATE_A_RANDOM_SECRET

    # Realm (use your domain or server hostname)
    realm=united.local

    # Logging
    log-file=stdout
    verbose

    # Security
    no-multicast-peers
    no-cli

    # Fingerprint for TURN messages
    fingerprint

    # Long-term credential mechanism
    lt-cred-mech
    ```

    **3. Update `server/src/config.rs` generate_config_template:**
    Add TURN section to the template with instructions linking to turnserver.conf:
    ```toml
    # ---- TURN Relay (Voice Channels) ----
    # Required for voice channels to work across NATs (~20-30% of connections need TURN)
    # The shared_secret MUST match static-auth-secret in turnserver.conf
    # [turn]
    # enabled = true
    # host = "your-server-hostname-or-ip"
    # port = 3478
    # shared_secret = "CHANGE_ME_GENERATE_A_RANDOM_SECRET"
    # credential_ttl_secs = 86400
    ```

    **4. Add a simple setup note** as a comment in docker-compose.yml explaining:
    - Copy `turnserver.conf` and set a random `static-auth-secret`
    - Set the same secret in `united.toml` under `[turn] shared_secret`
    - Set `[turn] host` to the server's public IP or domain
    - `docker-compose up` brings up both services
  </action>
  <verify>
    test -f /c/Users/matts/united/docker-compose.yml && echo "docker-compose.yml exists" && test -f /c/Users/matts/united/turnserver.conf && echo "turnserver.conf exists"
  </verify>
  <done>
    docker-compose.yml defines united-server and coturn services with proper port mappings. turnserver.conf provides coturn configuration template with shared-secret auth. Config template updated with TURN section. Setup instructions included as comments. Both files exist at project root.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. VoiceBar renders with mute/deafen/disconnect buttons and quality indicator
3. VoiceParticipant shows green speaking glow animation
4. VoiceSettings has device selection, VAD slider, PTT key config
5. Clicking a voice channel in sidebar joins (not selects as active text channel)
6. Participants appear under voice channel entries in sidebar
7. docker-compose.yml and turnserver.conf exist at project root
8. Per-user volume context menu works on right-click
</verification>

<success_criteria>
- Single-click voice channel to join immediately (no confirmation)
- VoiceBar persists at bottom-left with channel name, quality icon, mute/deafen/disconnect
- Participants shown inline in sidebar under voice channel with speaking glow
- Per-user volume slider (0-200%) via right-click context menu
- VoiceSettings panel with device selection, mic test, VAD sensitivity, PTT key config
- Clicking text channel does NOT disconnect from voice
- Clicking different voice channel auto-disconnects and joins new one
- docker-compose.yml ships coturn sidecar for TURN relay
- Connection quality icon: green/yellow/red with hover tooltip showing latency
</success_criteria>

<output>
After completion, create `.planning/phases/08-voice-channels/08-03-SUMMARY.md`
</output>
