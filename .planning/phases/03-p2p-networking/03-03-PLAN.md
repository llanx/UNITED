---
phase: 03-p2p-networking
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - client/src/main/p2p/stats.ts
  - client/src/renderer/src/components/DevPanel.tsx
  - client/src/renderer/src/hooks/useP2P.ts
  - client/src/renderer/src/stores/p2p.ts
  - client/src/renderer/src/stores/index.ts
  - client/src/renderer/src/components/MainContent.tsx
  - client/src/preload/index.ts
autonomous: true
requirements:
  - P2P-02
  - APP-02

must_haves:
  truths:
    - "Developer can open a floating debug panel via Ctrl+Shift+D"
    - "Dev panel shows connected peer list with PeerId, connection type, latency, and NAT type"
    - "Dev panel shows gossipsub topic list with message count and last received timestamp"
    - "Developer can send a test gossipsub message from the dev panel and see it arrive"
    - "Developer can ping a specific peer and see the RTT"
    - "Developer can force-reconnect to the mesh"
    - "Panel auto-refreshes every ~2 seconds while open"
    - "Zero performance overhead when the dev panel is closed (no stats pushed to renderer)"
  artifacts:
    - path: "client/src/main/p2p/stats.ts"
      provides: "P2P stats aggregation and push pipeline from main process"
      contains: "startStatsPush"
    - path: "client/src/renderer/src/components/DevPanel.tsx"
      provides: "Floating overlay UI with peer list, gossipsub stats, and 3 test actions"
      contains: "DevPanel"
    - path: "client/src/renderer/src/hooks/useP2P.ts"
      provides: "Hook subscribing to P2P stats push events"
      contains: "useP2P"
    - path: "client/src/renderer/src/stores/p2p.ts"
      provides: "Zustand slice for P2P state"
      contains: "P2PSlice"
  key_links:
    - from: "client/src/main/p2p/stats.ts"
      to: "client/src/renderer/src/stores/p2p.ts"
      via: "IPC push event PUSH_P2P_STATS"
      pattern: "PUSH_P2P_STATS"
    - from: "client/src/renderer/src/hooks/useP2P.ts"
      to: "client/src/main/ipc/p2p.ts"
      via: "IPC calls for test actions (send message, ping, reconnect)"
      pattern: "sendTestMessage|pingPeer|forceReconnect"
    - from: "client/src/renderer/src/components/DevPanel.tsx"
      to: "client/src/renderer/src/stores/p2p.ts"
      via: "useP2P hook reading from store"
      pattern: "useP2P"
---

<objective>
Build the P2P developer observability panel: an IPC data pipeline pushing live stats from the main process to the renderer, a Zustand store for P2P state, and a floating overlay UI (Ctrl+Shift+D) showing connected peers, gossipsub topics, and 3 test actions (send test message, ping peer, force reconnect). The IPC pipeline is the permanent architectural investment; the dev panel UI is the Phase 3 verification tool and evolves into a user-facing feature in v2.

Purpose: Phase 3 has no chat UI, so the dev panel is the only way to verify the P2P mesh works. The IPC data pipeline established here is permanent infrastructure reused by the user-facing P2P dashboard (AP2P-02) in v2.
Output: Functional dev panel accessible via Ctrl+Shift+D showing live P2P mesh health and enabling interactive testing.
</objective>

<execution_context>
@C:/Users/matts/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matts/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-p2p-networking/03-CONTEXT.md
@.planning/phases/03-p2p-networking/03-RESEARCH.md
@.planning/phases/03-p2p-networking/03-02-SUMMARY.md
@client/src/renderer/src/stores/index.ts
@client/src/renderer/src/components/MainContent.tsx
@client/src/preload/index.ts
@shared/types/ipc-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: P2P stats pipeline, Zustand store, and useP2P hook</name>
  <files>
    client/src/main/p2p/stats.ts
    client/src/renderer/src/stores/p2p.ts
    client/src/renderer/src/stores/index.ts
    client/src/renderer/src/hooks/useP2P.ts
    client/src/preload/index.ts
  </files>
  <action>
    **1. Create client/src/main/p2p/stats.ts:**
    The main process stats aggregation and push pipeline.

    Function `startStatsPush(getNode: () => Libp2p | null)`:
    - Track `panelOpen` state via IPC listeners on `IPC.P2P_PANEL_OPEN` and `IPC.P2P_PANEL_CLOSE`
    - Set up a `setInterval` at 2000ms (2 seconds):
      - If `!panelOpen` → return immediately (zero overhead when panel closed)
      - If no P2P node → send empty stats
      - Aggregate stats from the libp2p node:
        - **Peers:** Iterate `node.getConnections()` — for each connection: extract peerId, determine connection type (check if connection has a relay address component → 'relayed', otherwise 'direct'), get last ping RTT from ping service results
        - **Topics:** Get subscribed topics from `node.services.pubsub.getTopics()`, for each topic: get subscriber count from `node.services.pubsub.getSubscribers(topic).length`, get message count and last received from the TopicStats map maintained in gossipsub.ts
        - **NAT type:** Read from cached AutoNAT result (if server probed)
        - **isConnected:** Whether the server peer is in the connection list
        - **serverPeerId:** The server's PeerId string
      - Push `P2PStats` to all renderer windows via `BrowserWindow.getAllWindows().forEach(win => win.webContents.send(IPC.PUSH_P2P_STATS, stats))`

    Function `stopStatsPush()`: Clear the interval.

    Call `startStatsPush()` from the P2P node startup flow (after the node is created and started).

    **2. Create client/src/renderer/src/stores/p2p.ts:**
    Zustand slice following existing project pattern (StateCreator<RootStore, [], [], P2PSlice>).

    ```typescript
    export interface P2PSlice {
      // State
      peers: PeerInfo[]
      topics: TopicStats[]
      natType: string
      isConnected: boolean
      serverPeerId: string
      devPanelOpen: boolean
      // Actions
      setP2PStats: (stats: P2PStats) => void
      toggleDevPanel: () => void
      setDevPanelOpen: (open: boolean) => void
    }
    ```

    `toggleDevPanel()`: Flip `devPanelOpen`, call `window.united.p2p.openPanel()` or `window.united.p2p.closePanel()` to notify main process.
    `setP2PStats()`: Update all stat fields from the push event data.

    **3. Update client/src/renderer/src/stores/index.ts:**
    Import and spread the P2P slice into the root store, following the existing pattern (like auth, channels, roles, etc.).

    **4. Create client/src/renderer/src/hooks/useP2P.ts:**
    Custom hook that:
    - Subscribes to `PUSH_P2P_STATS` push events via `window.united.p2p.onStatsUpdate(callback)`
    - On each stats update: call `setP2PStats(stats)` on the store
    - Returns cleanup function that unsubscribes
    - Also returns action functions: `sendTestMessage(topic, text)`, `pingPeer(peerId)`, `forceReconnect()`
    - These actions call `window.united.p2p.sendTestMessage()`, etc.
    - Follow the existing push event subscription pattern from other hooks (e.g., useConnection.ts)

    **5. Update client/src/preload/index.ts:**
    Expose the P2P methods on the `window.united.p2p` object via contextBridge:
    - `startMesh`, `stopMesh`, `sendTestMessage`, `pingPeer`, `forceReconnect`, `getStats`
    - `onStatsUpdate(callback)` — wraps `ipcRenderer.on(IPC.PUSH_P2P_STATS, (_, stats) => callback(stats))`, returns cleanup function
    - `openPanel`, `closePanel` — wraps `ipcRenderer.send(IPC.P2P_PANEL_OPEN)` and `IPC.P2P_PANEL_CLOSE`
  </action>
  <verify>
    Run `npx electron-vite build` — compiles without errors. Verify p2p.ts store slice is integrated into root store by checking stores/index.ts exports. Verify preload exposes window.united.p2p methods.
  </verify>
  <done>
    P2P stats push pipeline runs in main process at 2s interval, zero overhead when panel is closed. Zustand P2P slice tracks peers, topics, NAT type, connection status. useP2P hook subscribes to push events and provides test action functions. Preload bridge exposes all P2P IPC methods to the renderer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dev panel floating overlay UI with peer list, gossipsub stats, and test actions</name>
  <files>
    client/src/renderer/src/components/DevPanel.tsx
    client/src/renderer/src/components/MainContent.tsx
  </files>
  <action>
    **1. Create client/src/renderer/src/components/DevPanel.tsx:**
    A floating overlay panel activated by Ctrl+Shift+D.

    **Layout:**
    - Floating overlay (position: fixed, z-index high enough to float above everything)
    - Draggable via a title bar (implement basic drag: onMouseDown on title bar sets dragging state, onMouseMove updates position, onMouseUp clears)
    - Default position: bottom-right corner, size approximately 500x400px
    - Dark theme matching the app (use existing dark theme colors)
    - Close button (X) in title bar that calls `toggleDevPanel()`
    - Title: "P2P Debug Panel" with a small connection status indicator dot (green/red)

    **Section 1: Peers**
    - Table/list of connected peers:
      - PeerId (truncated to first 8 chars + "...")
      - Connection type: "direct" or "relayed" (with colored badge)
      - Latency: "{N}ms" (or "—" if no ping data)
      - NAT type: "public" / "private" / "unknown"
    - If no peers: show "No peers connected" message
    - Show total peer count in section header

    **Section 2: Gossipsub Topics**
    - Table/list of subscribed topics:
      - Topic name (show channel UUID, truncated)
      - Message count since subscription
      - Last received: relative time ("3s ago", "never")
      - Delivery latency: if tracked, show average ms
    - If no topics: show "No subscriptions" message

    **Section 3: Test Actions (bottom of panel)**
    Three buttons in a row:
    1. **"Send Test"**: Opens an inline input for topic selection (dropdown of subscribed topics) and a text field. On click: calls `sendTestMessage(topic, text)`. Show success/failure toast.
    2. **"Ping Peer"**: Opens an inline dropdown of connected peers. On click: calls `pingPeer(peerId)`. Shows RTT result inline or toast.
    3. **"Force Reconnect"**: Single button, calls `forceReconnect()`. Shows "Reconnecting..." status briefly.

    **Info footer:**
    - Own PeerId (truncated)
    - NAT type
    - Server PeerId (truncated)

    **2. Wire keyboard shortcut (Ctrl+Shift+D):**
    In MainContent.tsx (or App.tsx — wherever the main layout lives):
    - Add `useEffect` with `document.addEventListener('keydown', handler)` that listens for Ctrl+Shift+D (keyCode 68 or key === 'D')
    - On trigger: call `toggleDevPanel()` from the P2P store
    - Render `{devPanelOpen && <DevPanel />}` in the component tree

    **3. Integration with useP2P hook:**
    Inside DevPanel, call `useP2P()` at the top level. The hook's stats subscription ensures the panel data auto-refreshes (~2s).
    When the panel opens: `setDevPanelOpen(true)` triggers `openPanel()` IPC, which starts the stats push.
    When the panel closes: `setDevPanelOpen(false)` triggers `closePanel()` IPC, which stops the stats push.

    **Styling notes:**
    - Use inline styles or a CSS module. Keep it simple — this is a dev tool, not a polished UI.
    - Monospace font for PeerIds, timestamps, and stats
    - Subtle border and shadow to distinguish from main app content
    - Semi-transparent background so the app is slightly visible underneath
    - Scrollable peer and topic lists if they exceed the panel height
  </action>
  <verify>
    Run `npx electron-vite build` — compiles without errors. Start the app, press Ctrl+Shift+D — dev panel should appear as a floating overlay. Press Ctrl+Shift+D again — panel should close. Verify the panel shows the Peers section (at least the server as a connected peer), the Gossipsub section (subscribed channel topics), and the 3 test action buttons. Send a test message — verify it appears in the server's gossipsub message log. Ping the server — verify RTT displays.
  </verify>
  <done>
    Dev panel renders as a floating, draggable overlay showing live P2P mesh health. Peers section shows connected peers with PeerId, connection type, latency, and NAT type. Gossipsub section shows subscribed topics with message counts and timestamps. Three test actions work: send test message (published via gossipsub), ping peer (shows RTT), force reconnect (drops and re-establishes connections). Panel auto-refreshes at ~2s via push events. Zero overhead when closed.
  </done>
</task>

</tasks>

<verification>
1. `npx electron-vite build` compiles without errors
2. Ctrl+Shift+D opens the dev panel as a floating overlay
3. Ctrl+Shift+D again closes it (toggle behavior)
4. Panel is draggable by its title bar
5. Peers section shows at least the server peer with connection info
6. Topics section shows subscribed channel topics with message counts
7. "Send Test" button publishes a gossipsub message visible in server logs
8. "Ping Peer" button shows RTT in milliseconds
9. "Force Reconnect" button disconnects and reconnects without crashing
10. Stats update every ~2 seconds while panel is open
11. CPU/memory usage is flat when panel is closed (no unnecessary IPC traffic)
</verification>

<success_criteria>
- Dev panel is the primary verification tool for Phase 3 P2P networking
- IPC data pipeline (permanent infrastructure) pushes P2PStats from main to renderer
- Zustand P2P slice integrated into root store following existing patterns
- Zero overhead when panel is closed (interval check, no event emission)
- 3 test actions provide interactive P2P mesh testing without a chat UI
- Panel ships in all builds (hidden behind Ctrl+Shift+D shortcut)
- Data pipeline ready for reuse by user-facing P2P dashboard (AP2P-02 in v2)
</success_criteria>

<output>
After completion, create `.planning/phases/03-p2p-networking/03-03-SUMMARY.md`
</output>
