---
milestone: v1.0
audited: 2026-02-27T12:00:00Z
status: gaps_found
scores:
  requirements: 56/56
  phases: 11/11
  integration: 45/47
  flows: 8/10
gaps:
  requirements: []
  integration:
    - from: "client/src/main/ipc/connection.ts (performChallengeResponse + connectWebSocket)"
      to: "client WS connection lifecycle"
      issue: "performChallengeResponse() defined at line 83 is never called. connectWebSocket() at line 121 is only called in the TOKEN_EXPIRED reconnect handler (line 160) — never during initial startup. Neither Welcome.tsx (returning user) nor JoinServer.tsx (new user) initiate a WS connection. The app reaches /app in an effectively offline state."
      affected_requirements: ["MSG-01", "MSG-04", "MSG-05", "MSG-06", "MSG-09", "DM-01", "VOICE-01", "VOICE-02", "VOICE-03", "P2P-02", "APP-03", "SEC-02"]
      severity: "critical"
    - from: "client/src/renderer/src/hooks/usePresence.ts (usePresence)"
      to: "client/src/renderer/src/stores/presence.ts (userPresence)"
      issue: "usePresence() hook exported but never mounted at the app level. Only useTypingIndicator (sub-export from same file) is imported by ChatView.tsx. The PUSH_PRESENCE_EVENT IPC listener is never registered in the renderer. userPresence store is always empty — MemberListSidebar presence dots never render."
      affected_requirements: ["MSG-06"]
      severity: "high"
  flows:
    - flow: "User Authentication → WS Connect → Real-Time Features"
      breaks_at: "After identity unlock (returning) or register (new), no code path calls performChallengeResponse() or connectWebSocket(). wsClient stays disconnected. All WS-dependent features (real-time chat, DM push, voice signaling, presence, typing, P2P auto-start) are non-functional."
      affected_requirements: ["MSG-01", "MSG-04", "MSG-05", "MSG-06", "MSG-09", "DM-01", "VOICE-01", "VOICE-02", "VOICE-03", "P2P-02", "APP-03", "SEC-02"]
    - flow: "Presence Display in Member List"
      breaks_at: "usePresence() never mounted — onPresenceEvent callback never registered — userPresence store always empty — MemberListSidebar shows no presence dots"
      affected_requirements: ["MSG-06"]
tech_debt:
  - phase: 01-foundation
    items:
      - "SRVR-07: icon upload not implemented — settings CRUD supports name/description/registration_mode only"
  - phase: 04-real-time-chat
    items:
      - "SEC-03 partially satisfied: REST message path has empty signature bytes (gossip path is signed)"
      - "MessageGroup.tsx lines 108-109: minor redundancy in isFirstInDay logic"
  - phase: 05-direct-messages
    items:
      - "DM_DELETE_LOCAL handler is a no-op (delete-for-self only in renderer memory, lost on restart)"
  - phase: 06-content-distribution
    items:
      - "server/src/blocks/store.rs: no disk-based verification on get_block (trusts metadata presence)"
  - phase: 08-voice-channels
    items:
      - "ChannelList.tsx line 266-268: console.warn for soft cap warning (should use toast system)"
      - "SEC-11 key rotation: 72h cancellation endpoint has no client-side UI to cancel"
  - phase: dead-code
    items:
      - "client/src/main/ws/protocol.ts: encode/decode stubs throw errors, never called (unreachable dead code)"
      - "client/src/renderer/src/hooks/useAuth.ts: exported but never imported (intended orchestration layer for auth flow, unused)"
---

# v1.0 Milestone Audit Report

**Audited:** 2026-02-27
**Milestone:** v1.0 — UNITED Desktop Application
**Status:** GAPS FOUND
**Previous audit:** 2026-02-27 (post-Phase 11, pre-re-audit)

---

## Executive Summary

56 v1 requirements. All 56 have formal verification evidence across 11 phase VERIFICATION.md files. All 11 phases complete with no missing verification files. However, the integration checker found **2 critical cross-phase wiring breaks** that were not visible to per-phase verification:

1. **WebSocket connection never initiated** — `performChallengeResponse()` and `connectWebSocket()` are dead code. The app reaches `/app` without an active WS connection, breaking all real-time features.
2. **usePresence() never mounted** — presence IPC listener never registered, presence store always empty.

These are **new findings** not present in the previous audit. They represent integration gaps between Phase 1 (auth/connection infrastructure) and Phases 4-8 (features that depend on WS).

---

## 1. Phase Verification Status

| Phase | VERIFICATION.md | Status | Score | Notes |
|-------|----------------|--------|-------|-------|
| 01-foundation | 01-VERIFICATION.md | passed | 8/8 | Created by Phase 11 gap closure |
| 02-server-management | 02-06-VERIFICATION.md | human_needed | 9/9 | Re-verified after gap closure. 6 human-test items. |
| 03-p2p-networking | 03-VERIFICATION.md | human_needed | 4/4 | Re-verified after 03-04 gap closure. 4 human-test items. |
| 04-real-time-chat | 04-VERIFICATION.md | human_needed | 5/5 | Re-verified after 04-06 gap closure. 6 human-test items. |
| 05-direct-messages | 05-VERIFICATION.md | passed | 4/4 | Re-verified after 05-04 gap closure. |
| 06-content-distribution | 06-VERIFICATION.md | human_needed | 14/14 | Re-verified after 06-05 gap closure. 3 human-test items. |
| 07-media-and-prefetching | 07-VERIFICATION.md | passed | 19/19 | Initial verification, no gaps. |
| 08-voice-channels | 08-VERIFICATION.md | passed | 11/11 | Initial verification, no gaps. |
| 09-milestone-gap-closure | 09-VERIFICATION.md | passed | 10/10 | Closed SEC-08, APP-01, SRVR-09, VOICE-01/03 gaps. |
| 10-media-attachment-wiring | 10-VERIFICATION.md | passed | 3/3 | Closed block_refs wiring gap. |
| 11-phase1-formal-verification | 11-VERIFICATION.md | passed | 5/5 | Verified 6 orphaned Phase 1 requirements. |

**Phase score: 11/11** (all phases have verification)

---

## 2. Requirements Coverage (3-Source Cross-Reference)

### 2a. Fully Satisfied Requirements (56/56)

All three sources agree — REQUIREMENTS.md `[x]`, VERIFICATION.md SATISFIED, implementation confirmed:

| Category | Requirements | Phase | Status |
|----------|-------------|-------|--------|
| Messaging | MSG-01 through MSG-09 | Phase 4 | SATISFIED |
| Direct Messages | DM-01, DM-02, DM-03 | Phase 5 | SATISFIED |
| Media | MEDIA-01, MEDIA-02, MEDIA-03, MEDIA-04 | Phase 7 + Phase 10 fix | SATISFIED |
| Voice | VOICE-01, VOICE-02, VOICE-03, VOICE-04 | Phase 8 + Phase 9 fixes | SATISFIED |
| Server Mgmt | SRVR-01 through SRVR-09 | Phase 2 + Phase 9 fix | SATISFIED |
| P2P | P2P-01 through P2P-10 | Phases 3, 6, 7 | SATISFIED |
| Security | SEC-01 through SEC-12 | Phases 1-6, 9, 11 | SATISFIED |
| Client App | APP-01 through APP-05 | Phases 1, 3, 4, 6, 9 | SATISFIED |

**Note:** All 56 requirements are SATISFIED at the per-phase verification level. The integration gaps below affect the **cross-phase wiring** that connects these implementations — the code exists and is correct in isolation, but 2 connection points are missing.

### 2b. Orphaned Requirements: None

All 56 v1 requirements appear in at least one VERIFICATION.md with SATISFIED status.

### 2c. SEC-03 Caveat (unchanged from previous audit)

SEC-03 (messages signed by Ed25519 key) is marked SATISFIED in Phase 4 verification with a known caveat: only the gossipsub path signs messages. The REST POST path sends empty signature bytes. This is tracked as tech debt, not a blocker.

---

## 3. Cross-Phase Integration Results

**Integration checker result:** 45/47 integration points wired. 8/10 E2E flows complete.

### 3a. Critical Integration Break: WebSocket Connection Never Initiated

**Affected requirements:** MSG-01, MSG-04, MSG-05, MSG-06, MSG-09, DM-01, VOICE-01, VOICE-02, VOICE-03, P2P-02, APP-03, SEC-02

**Root cause:** The app startup flow (both new-user and returning-user paths) never calls `performChallengeResponse()` or `connectWebSocket()`. These functions are defined in `client/src/main/ipc/connection.ts` but are dead code:

- `performChallengeResponse()` (line 83): calls POST /api/auth/challenge + POST /api/auth/verify. **Never called from any code path.**
- `connectWebSocket()` (line 121): calls `wsClient.connect()`. **Only called from the TOKEN_EXPIRED reconnect handler (line 160)**, which requires an already-connected WS to fire.

**New-user flow (`JoinServer.tsx`):**
```
window.united.connectToServer(url)    → fetches server info only (no WS)
window.united.register(displayName)   → gets JWT from POST /api/auth/register (no WS)
navigate('/app')                      → app renders without WS connection
```

**Returning-user flow (`Welcome.tsx`):**
```
window.united.unlockIdentity(pass)    → unlocks local identity (no server contact)
navigate('/app')                      → app renders without auth or WS
```

**Impact:** `wsClient` stays in `disconnected` state for the entire session. All WS-dependent features are non-functional at runtime:
- Real-time chat message delivery (PUSH_CHAT_EVENT)
- Real-time DM delivery (PUSH_DM_EVENT)
- Voice signaling (PUSH_VOICE_EVENT)
- Presence updates from server (PUSH_PRESENCE_EVENT)
- Typing indicators (PUSH_TYPING_EVENT)
- P2P mesh auto-start (triggered on WS `connected` status)

**Fix required in 2-3 files:**
- Wire `performChallengeResponse()` into the returning-user flow (after unlock, use stored server URL to get JWT)
- Wire `connectWebSocket()` into both flows (after JWT is available, connect WS)
- The existing `useAuth.ts` hook was designed as this orchestration layer — either use it or inline its logic

### 3b. High Integration Break: usePresence() Never Mounted

**Affected requirements:** MSG-06

**Root cause:** `usePresence()` hook (`client/src/renderer/src/hooks/usePresence.ts`, line 16) is exported but never imported or mounted at the app level. Only `useTypingIndicator` (a sub-export from the same file) is used by `ChatView.tsx`.

**Chain break:**
```
server/ws/actor.rs → PUSH_PRESENCE_EVENT broadcast
→ chat-events.ts → broadcastToRenderers(IPC.PUSH_PRESENCE_EVENT, ...)
→ preload → onPresenceEvent()
→ usePresence() → window.united.onPresenceEvent(callback)   ← NEVER CALLED
→ stores/presence.ts → setPresence()                        ← NEVER REACHED
→ MemberListSidebar → userPresence[member.pubkey]           ← ALWAYS EMPTY
```

**Fix required in 1 file:** Mount `usePresence()` in `Main.tsx` or `MainContent.tsx` alongside existing hooks (`useConnection`, `useVoice`, `useNetworkStats`).

### 3c. Connected Flows (8/10 Complete)

| # | Flow | Status |
|---|------|--------|
| 1 | Identity creation → mnemonic → local storage | COMPLETE |
| 2 | **User auth → WS connect → real-time features** | **BROKEN** |
| 3 | Channel/role CRUD (REST) | COMPLETE |
| 4 | Invite validate → join → channel list | COMPLETE |
| 5 | Block content resolution cascade (5-layer) | COMPLETE |
| 6 | DM E2E encryption pipeline (code correct, WS delivery blocked by Break 1) | COMPLETE (at code level) |
| 7 | Voice signaling infrastructure (code correct, WS blocked by Break 1) | COMPLETE (at code level) |
| 8 | Media attachment display (REST + WS paths) | COMPLETE |
| 9 | Gossip-to-WS bridge (server side) | COMPLETE |
| 10 | **Presence display in member list** | **BROKEN** |

### 3d. Auth Protection (unchanged)

All sensitive REST endpoints use `Claims` extractor JWT middleware. Public routes are intentionally unauthenticated:
- `GET /api/identity/blob/:fingerprint` — public key discovery
- `GET /api/p2p/info` — peer directory bootstrap
- `GET /api/invites/{code}` — pre-join invite preview
- `GET /invite/{code}` — HTML landing page

---

## 4. Changes Since Previous Audit

The previous audit (2026-02-27 pre-re-audit) identified 6 orphaned requirements and 1 media wiring break. Those were closed by Phases 10 and 11:

| Previous Gap | Resolution |
|-------------|------------|
| 6 orphaned Phase 1 requirements | Phase 11 created 01-VERIFICATION.md |
| block_refs wiring break (MEDIA-01..04) | Phase 10 fixed REST and WS paths |

**New findings in this audit:**
- WS connection never initiated (affects 12 requirements at integration level)
- usePresence() never mounted (affects MSG-06 at integration level)
- 2 dead code items (useAuth.ts, ws/protocol.ts stubs)

---

## 5. Tech Debt Inventory

### Phase 1: Foundation
- SRVR-07: icon upload not implemented — settings CRUD supports name/description/registration_mode only

### Phase 4: Real-Time Chat
- SEC-03 REST path: messages sent via POST have empty signature bytes (gossip path correctly signs)
- MessageGroup.tsx: minor redundancy in isFirstInDay logic (cosmetic)

### Phase 5: Direct Messages
- DM_DELETE_LOCAL handler is a no-op — delete-for-self only persists in renderer memory, cleared on restart

### Phase 6: Content Distribution
- server/src/blocks/store.rs: no disk-based verification on get_block (trusts metadata presence)

### Phase 8: Voice Channels
- ChannelList.tsx: console.warn for soft cap warning (should use toast system)
- SEC-11 key rotation: 72h cancellation endpoint has no client-side UI to cancel

### Dead Code
- client/src/main/ws/protocol.ts: encode/decode stubs that throw errors (unreachable)
- client/src/renderer/src/hooks/useAuth.ts: exported but never imported

**Total: 9 tech debt items across 5 phases + dead code**

---

## 6. Human Verification Backlog

| Phase | Count | Key Items |
|-------|-------|-----------|
| Phase 1 | 6 | Identity creation E2E, challenge-response round-trip, TOTP enrollment, blob recovery, key rotation, server settings |
| Phase 2 | 6 | WS channel events, non-admin gating, invite join, welcome overlay, ban notice, SEC-12 QR round-trip |
| Phase 3 | 4 | Cross-network discovery, gossipsub latency, dev panel, reconnection fast-recovery |
| Phase 4 | 6 | Real-time delivery, message grouping, @mention UX, reaction sync, desktop notifications, presence dots |
| Phase 5 | 4 | Real-time DM delivery, offline DM, encryption banner persistence, key unavailable state |
| Phase 6 | 3 | StorageSettings panel, zero-reflow, file type icons |
| Phase 7 | 7 | Inline media grids, placeholder transitions, lightbox, drag-drop, upload progress, status bar, hover prefetch |
| Phase 8 | 5 | P2P audio, mute/deafen, speaking glow, PTT global hook, TURN relay |
| Phase 9 | 3 | Invite E2E, voice self-exclusion, offer/answer correctness |
| Phase 10 | 3 | Upload round-trip, history reload, blurhash placeholder |

**Total: 47 human verification items** (none are blockers — all automated checks pass)

---

_Audited: 2026-02-27_
_Auditor: Claude (gsd audit-milestone workflow)_
_Previous audit: 2026-02-27 (post-Phase 11)_
